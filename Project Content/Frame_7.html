<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="UMak_Logo_Registered.png" />
  <title>University of Makati Library - Activity Log</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="theme.css" />
  <script defer src="theme.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <style>
    /* First-paint blur + transition variables */
    [data-fade] {
      opacity: 0;
      --fade-init: 14px;
      --fade-filter: none;
      filter: var(--fade-filter) !important;
      transition: var(--fade-transition, opacity 1000ms ease-out, filter 1000ms ease-out) !important;
      will-change: opacity, filter;
    }

    [data-fade]:not([data-blur="false"]) {
      --fade-filter: blur(var(--fade-init));
    }

    /* Modern Top Navigation Bar */
    .modern-sidebar {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: auto;
      min-width: 320px;
      max-width: 500px;
      height: auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-top: none;
      border-radius: 0 0 20px 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.05);
      z-index: 1000;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      padding: 1rem 2rem;
      gap: 1rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Top Navigation Items */
    .sidebar-nav-item {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(0, 0, 0, 0.3);
      color: #374151;
      text-decoration: none;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    .sidebar-nav-item:hover {
      transform: translateY(-2px) scale(1.05);
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(0, 0, 0, 0.5);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15), 0 0 20px rgba(59, 130, 246, 0.3);
    }

    .sidebar-nav-item:active {
      transform: translateY(0) scale(0.98);
    }

    .sidebar-nav-item.active {
      background: rgba(59, 130, 246, 0.2);
      border-color: rgba(59, 130, 246, 0.4);
      color: #3b82f6;
    }

    /* Sidebar Icons */
    .sidebar-icon {
      width: 24px;
      height: 24px;
      stroke-width: 1.5;
    }

    /* Tooltips */
    .sidebar-tooltip {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-top: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
      z-index: 1001;
    }

    .sidebar-tooltip::before {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-bottom-color: rgba(0, 0, 0, 0.9);
    }

    .sidebar-nav-item:hover .sidebar-tooltip {
      opacity: 1;
      visibility: visible;
    }

    /* Logo/Brand in Top Navigation */
    .sidebar-brand {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 0.5rem;
    }

    .sidebar-brand img {
      width: 32px;
      height: 32px;
      border-radius: 6px;
    }

    .sidebar-brand-text {
      font-size: 1.125rem;
      font-weight: 600;
      color: #374151;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .modern-sidebar {
        min-width: 280px;
        max-width: 90vw;
        padding: 0.75rem 1rem;
        gap: 0.75rem;
      }

      .sidebar-nav-item {
        width: 40px;
        height: 40px;
      }

      .sidebar-icon {
        width: 20px;
        height: 20px;
      }

      .sidebar-brand img {
        width: 28px;
        height: 28px;
      }

      .sidebar-brand-text {
        font-size: 1rem;
      }
    }

    /* Dark Mode Support */
    @media (prefers-color-scheme: dark) {
      .modern-sidebar {
        background: rgba(15, 23, 42, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-top: none;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.05);
      }

      .sidebar-nav-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #e5e7eb;
      }

      .sidebar-nav-item:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 20px rgba(59, 130, 246, 0.4);
      }

      .sidebar-nav-item.active {
        background: rgba(59, 130, 246, 0.3);
        border-color: rgba(59, 130, 246, 0.5);
        color: #60a5fa;
      }

      .sidebar-brand-text {
        color: #e5e7eb;
      }
    }

    /* Manual dark mode class support */
    .dark .modern-sidebar {
      background: rgba(15, 23, 42, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-top: none;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.05);
    }

    .dark .sidebar-nav-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #e5e7eb;
    }

    .dark .sidebar-nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 20px rgba(59, 130, 246, 0.4);
    }

    .dark .sidebar-nav-item.active {
      background: rgba(59, 130, 246, 0.3);
      border-color: rgba(59, 130, 246, 0.5);
      color: #60a5fa;
    }

    .dark .sidebar-brand-text {
      color: #e5e7eb;
    }

    /* Adjust main content for top navigation */
    .main-with-sidebar {
      padding-top: 5rem;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">
  <!-- Modern Top Navigation Bar -->
  <nav class="modern-sidebar" data-fade data-blur="true" data-initial-opacity="0" data-duration="1000">
    <!-- Brand/Logo -->
    <div class="sidebar-brand">
      <img src="UMak_Logo_Registered.png" alt="University of Makati Logo" />
    </div>

    <!-- Navigation Items -->
    <a href="Frame_6.html" class="sidebar-nav-item" aria-label="Dashboard">
      <i data-lucide="layout-dashboard" class="sidebar-icon"></i>
      <div class="sidebar-tooltip">Dashboard</div>
    </a>

    <a href="Frame_7.html" class="sidebar-nav-item active" aria-label="Log">
      <i data-lucide="file-text" class="sidebar-icon"></i>
      <div class="sidebar-tooltip">Log</div>
    </a>

    <a href="Frame_9.html" class="sidebar-nav-item" aria-label="Alerts">
      <i data-lucide="bell" class="sidebar-icon"></i>
      <div class="sidebar-tooltip">Alerts</div>
    </a>

    <a href="Frame_18.html" class="sidebar-nav-item" aria-label="Reports">
      <i data-lucide="bar-chart-3" class="sidebar-icon"></i>
      <div class="sidebar-tooltip">Reports</div>
    </a>

    <a href="Frame_15.html" class="sidebar-nav-item" aria-label="Users">
      <i data-lucide="users" class="sidebar-icon"></i>
      <div class="sidebar-tooltip">Users</div>
    </a>

    <a href="Frame_19.html" class="sidebar-nav-item" aria-label="Settings">
      <i data-lucide="settings" class="sidebar-icon"></i>
      <div class="sidebar-tooltip">Settings</div>
    </a>

    <button onclick="logout()" class="sidebar-nav-item" aria-label="Logout">
      <i data-lucide="log-out" class="sidebar-icon"></i>
      <div class="sidebar-tooltip">Logout</div>
    </button>
  </nav>

  <!-- UI/UX refinements are scoped to #admin-log-root to avoid global changes -->
  <main id="admin-log-root" class="main-with-sidebar flex-1 py-8 px-6" data-fade data-blur="true" data-blur-px="16"
    data-initial-opacity="0" data-duration="1000" data-delay="50">
    <div class="max-w-7xl mx-auto">

      <!-- Header Section -->
      <div class="mb-8" data-fade data-blur="true" data-initial-opacity="0" data-duration="900">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <h1 class="text-3xl font-bold mb-2">Activity Log</h1>
            <p class="text-slate-600">Monitor all system activities and user interactions</p>
          </div>
          <div class="flex items-center gap-3">
            <button onclick="exportLog()"
              class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
              Export CSV
            </button>
            <button onclick="refreshLog()"
              class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
              Refresh
            </button>
          </div>
        </div>
      </div>

      <!-- Filter Controls -->
      <div class="bg-white rounded-xl p-6 md:p-8 shadow-sm border border-slate-200 mb-8 card-hover" data-fade
        data-blur="true" data-initial-opacity="0" data-delay="50">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Date Range</label>
            <select id="dateRange"
              class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
              <option value="today">Today</option>
              <option value="yesterday">Yesterday</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
              <option value="all">All Time</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Activity Type</label>
            <select id="activityType"
              class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
              <option value="all">All Activities</option>
              <option value="login">Logins</option>
              <option value="seat">Seat Changes</option>
              <option value="noise">Noise Events</option>
              <option value="system">System Events</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">User</label>
            <input type="text" id="userFilter" placeholder="Search by user..."
              class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Severity</label>
            <select id="severityFilter"
              class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
              <option value="all">All Levels</option>
              <option value="critical">Critical</option>
              <option value="warning">Warning</option>
              <option value="info">Info</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Activity Stats -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" data-fade data-blur="true" data-initial-opacity="0"
        data-delay="75">
        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200" data-fade data-blur="true"
          data-initial-opacity="0" data-delay="0">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-bold text-indigo-600" id="totalActivities">—</div>
              <div class="text-sm text-slate-500">Total Activities</div>
            </div>
            <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                </path>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200" data-fade data-blur="true"
          data-initial-opacity="0" data-delay="50">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-bold text-green-600" id="activeUsers">—</div>
              <div class="text-sm text-slate-500">Active Users</div>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z">
                </path>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200" data-fade data-blur="true"
          data-initial-opacity="0" data-delay="100">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-bold text-yellow-600" id="noiseEvents">—</div>
              <div class="text-sm text-slate-500">Noise Events</div>
            </div>
            <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z">
                </path>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200" data-fade data-blur="true"
          data-initial-opacity="0" data-delay="150">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-bold text-red-600" id="violations">—</div>
              <div class="text-sm text-slate-500">Violations</div>
            </div>
            <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z">
                </path>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- Activity Timeline -->
      <div class="bg-white rounded-xl shadow-sm border border-slate-200" data-fade data-blur="true"
        data-initial-opacity="0" data-delay="200">
        <div class="p-6 md:p-8 border-b border-slate-200">
          <h3 class="text-xl font-semibold text-slate-900">Activity Timeline</h3>
        </div>
        <div class="p-6 md:p-8">
          <div class="space-y-4" id="activityTimeline">
            <!-- Sample activities -->
            <div class="flex items-start gap-4 p-4 bg-slate-50 rounded-lg">
              <div class="w-3 h-3 rounded-full bg-green-500 mt-2"></div>
              <div class="flex-1">
                <div class="flex items-center justify-between">
                  <h4 class="font-medium text-slate-900">User Login</h4>
                  <span class="text-sm text-slate-500">2 minutes ago</span>
                </div>
                <p class="text-sm text-slate-600">Maria Santos logged in successfully</p>
                <div class="flex items-center gap-2 mt-1">
                  <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Login</span>
                  <span class="px-2 py-1 bg-slate-100 text-slate-700 text-xs rounded-full">Info</span>
                </div>
              </div>
            </div>

            <div class="flex items-start gap-4 p-4 bg-slate-50 rounded-lg">
              <div class="w-3 h-3 rounded-full bg-yellow-500 mt-2"></div>
              <div class="flex-1">
                <div class="flex items-center justify-between">
                  <h4 class="font-medium text-slate-900">Seat Occupied</h4>
                  <span class="text-sm text-slate-500">5 minutes ago</span>
                </div>
                <p class="text-sm text-slate-600">Table 2, Seat 3 occupied by John Doe</p>
                <div class="flex items-center gap-2 mt-1">
                  <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Seat</span>
                  <span class="px-2 py-1 bg-slate-100 text-slate-700 text-xs rounded-full">Info</span>
                </div>
              </div>
            </div>

            <div class="flex items-start gap-4 p-4 bg-slate-50 rounded-lg">
              <div class="w-3 h-3 rounded-full bg-red-500 mt-2"></div>
              <div class="flex-1">
                <div class="flex items-center justify-between">
                  <h4 class="font-medium text-slate-900">High Noise Detected</h4>
                  <span class="text-sm text-slate-500">8 minutes ago</span>
                </div>
                <p class="text-sm text-slate-600">Noise level 4.8/5 detected at Table 3</p>
                <div class="flex items-center gap-2 mt-1">
                  <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">Noise</span>
                  <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">Critical</span>
                </div>
              </div>
            </div>

            <div class="flex items-start gap-4 p-4 bg-slate-50 rounded-lg">
              <div class="w-3 h-3 rounded-full bg-blue-500 mt-2"></div>
              <div class="flex-1">
                <div class="flex items-center justify-between">
                  <h4 class="font-medium text-slate-900">System Update</h4>
                  <span class="text-sm text-slate-500">1 hour ago</span>
                </div>
                <p class="text-sm text-slate-600">Noise monitoring system updated to v2.1.0</p>
                <div class="flex items-center gap-2 mt-1">
                  <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">System</span>
                  <span class="px-2 py-1 bg-slate-100 text-slate-700 text-xs rounded-full">Info</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>
  <footer class="text-center text-xs text-slate-500 py-3" data-fade data-blur="true" data-initial-opacity="0"
    data-delay="250">© 2025 UMak Library · Noise Comfort Index</footer>

  <script>
    (function () {
      // Robust mobile menu toggle
      try {
        var mmBtn = document.getElementById('mobile-menu-btn');
        var mmenu = document.getElementById('mobile-menu');
        var hdr = document.querySelector('header.site-header');
        if (mmBtn && mmenu && hdr) {
          mmBtn.addEventListener('click', function () {
            var hidden = mmenu.classList.contains('hidden');
            if (hidden) { hdr.classList.add('menu-open'); mmenu.classList.remove('hidden'); mmBtn.setAttribute('aria-expanded', 'true'); }
            else { hdr.classList.remove('menu-open'); mmenu.classList.add('hidden'); mmBtn.setAttribute('aria-expanded', 'false'); }
          });
        }
      } catch (_) { }

      var supabaseInitialized = false;
      var activities = [];
      var filteredActivities = [];

      // Firebase init
      var cfg = window.firebaseConfig || {};
      try { if (!firebase.apps.length) firebase.initializeApp(cfg); } catch (_) { }
      var db = null; try { db = firebase.database(); } catch (_) { }

      // Sample activities data
      var sampleActivities = [
        {
          id: 1,
          type: 'login',
          title: 'User Login',
          description: 'Maria Santos logged in successfully',
          timestamp: Date.now() - 120000,
          severity: 'info',
          user: 'Maria Santos',
          details: { ip: '192.168.1.100', userAgent: 'Chrome/91.0' }
        },
        {
          id: 2,
          type: 'seat',
          title: 'Seat Occupied',
          description: 'Table 2, Seat 3 occupied by John Doe',
          timestamp: Date.now() - 300000,
          severity: 'info',
          user: 'John Doe',
          details: { table: 'table-2', seat: 3 }
        },
        {
          id: 3,
          type: 'noise',
          title: 'High Noise Detected',
          description: 'Noise level 4.8/5 detected at Table 3',
          timestamp: Date.now() - 480000,
          severity: 'critical',
          user: 'System',
          details: { table: 'table-3', level: 4.8, threshold: 4.0 }
        },
        {
          id: 4,
          type: 'system',
          title: 'System Update',
          description: 'Noise monitoring system updated to v2.1.0',
          timestamp: Date.now() - 3600000,
          severity: 'info',
          user: 'System',
          details: { version: '2.1.0', components: ['sensors', 'ui'] }
        },
        {
          id: 5,
          type: 'seat',
          title: 'Seat Released',
          description: 'Table 1, Seat 2 released by Alice Johnson',
          timestamp: Date.now() - 600000,
          severity: 'info',
          user: 'Alice Johnson',
          details: { table: 'table-1', seat: 2, duration: 45 }
        }
      ];

      function updateStats() {
        var total = activities.length;
        var activeUsers = new Set(activities.filter(function (a) {
          return a.type === 'login' && (Date.now() - a.timestamp) < 3600000;
        }).map(function (a) { return a.user; })).size;
        var noiseEvents = activities.filter(function (a) { return a.type === 'noise'; }).length;
        var violations = activities.filter(function (a) { return a.severity === 'critical'; }).length;

        var totalEl = document.getElementById('totalActivities');
        var activeEl = document.getElementById('activeUsers');
        var noiseEl = document.getElementById('noiseEvents');
        var violationsEl = document.getElementById('violations');

        if (totalEl) totalEl.textContent = total;
        if (activeEl) activeEl.textContent = activeUsers;
        if (noiseEl) noiseEl.textContent = noiseEvents;
        if (violationsEl) violationsEl.textContent = violations;
      }

      function renderActivities() {
        var container = document.getElementById('activityTimeline');
        if (!container) return;

        if (filteredActivities.length === 0) {
          container.innerHTML = '<div class="text-center py-12 text-slate-500">No activities found</div>';
          return;
        }

        container.innerHTML = '';
        filteredActivities.forEach(function (activity) {
          var activityEl = document.createElement('div');
          activityEl.className = 'flex items-start gap-4 p-4 bg-slate-50 rounded-lg';

          var severityColors = {
            critical: 'bg-red-500',
            warning: 'bg-yellow-500',
            info: 'bg-blue-500',
            success: 'bg-green-500'
          };

          var severityBgColors = {
            critical: 'bg-red-100 text-red-800',
            warning: 'bg-yellow-100 text-yellow-800',
            info: 'bg-blue-100 text-blue-800',
            success: 'bg-green-100 text-green-800'
          };

          var timeAgo = getTimeAgo(activity.timestamp);

          activityEl.innerHTML = `
            <div class="w-3 h-3 rounded-full ${severityColors[activity.severity]} mt-2"></div>
            <div class="flex-1">
              <div class="flex items-center justify-between">
                <h4 class="font-medium text-slate-900">${activity.title}</h4>
                <span class="text-sm text-slate-500">${timeAgo}</span>
              </div>
              <p class="text-sm text-slate-600">${activity.description}</p>
              <div class="flex items-center gap-2 mt-1">
                <span class="px-2 py-1 ${severityBgColors[activity.severity]} text-xs rounded-full">${activity.type.charAt(0).toUpperCase() + activity.type.slice(1)}</span>
                <span class="px-2 py-1 bg-slate-100 text-slate-700 text-xs rounded-full">${activity.severity}</span>
                <span class="px-2 py-1 bg-slate-100 text-slate-700 text-xs rounded-full">${activity.user}</span>
              </div>
            </div>
          `;

          container.appendChild(activityEl);
        });
      }

      function getTimeAgo(timestamp) {
        var now = Date.now();
        var diff = now - timestamp;
        var minutes = Math.floor(diff / 60000);
        var hours = Math.floor(diff / 3600000);
        var days = Math.floor(diff / 86400000);

        if (minutes < 1) return 'Just now';
        if (minutes < 60) return minutes + ' minute' + (minutes > 1 ? 's' : '') + ' ago';
        if (hours < 24) return hours + ' hour' + (hours > 1 ? 's' : '') + ' ago';
        return days + ' day' + (days > 1 ? 's' : '') + ' ago';
      }

      function applyFilters() {
        var dateRange = document.getElementById('dateRange').value;
        var activityType = document.getElementById('activityType').value;
        var userFilter = document.getElementById('userFilter').value.toLowerCase();
        var severityFilter = document.getElementById('severityFilter').value;

        filteredActivities = activities.filter(function (activity) {
          // Date filter
          if (dateRange !== 'all') {
            var now = Date.now();
            var activityDate = new Date(activity.timestamp);
            var today = new Date();
            today.setHours(0, 0, 0, 0);

            if (dateRange === 'today' && activity.timestamp < today.getTime()) return false;
            if (dateRange === 'yesterday') {
              var yesterday = new Date(today);
              yesterday.setDate(yesterday.getDate() - 1);
              if (activity.timestamp < yesterday.getTime() || activity.timestamp >= today.getTime()) return false;
            }
            if (dateRange === 'week' && activity.timestamp < (now - 7 * 24 * 60 * 60 * 1000)) return false;
            if (dateRange === 'month' && activity.timestamp < (now - 30 * 24 * 60 * 60 * 1000)) return false;
          }

          // Type filter
          if (activityType !== 'all' && activity.type !== activityType) return false;

          // User filter
          if (userFilter && !activity.user.toLowerCase().includes(userFilter)) return false;

          // Severity filter
          if (severityFilter !== 'all' && activity.severity !== severityFilter) return false;

          return true;
        });

        renderActivities();
      }

      function exportLog() {
        var csv = 'Timestamp,Type,Title,Description,User,Severity\n';
        filteredActivities.forEach(function (activity) {
          var timestamp = new Date(activity.timestamp).toISOString();
          csv += `"${timestamp}","${activity.type}","${activity.title}","${activity.description}","${activity.user}","${activity.severity}"\n`;
        });

        var blob = new Blob([csv], { type: 'text/csv' });
        var url = window.URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'activity_log_' + new Date().toISOString().split('T')[0] + '.csv';
        a.click();
        window.URL.revokeObjectURL(url);
      }

      async function fetchActivityLogs() {
        try {
          if (!window.initSupabaseWithRetry || !window.supabaseDB) return;
          if (!supabaseInitialized) {
            try { supabaseInitialized = await window.initSupabaseWithRetry(); } catch (_) { supabaseInitialized = false; }
          }
          const res = await window.supabaseDB.getActivityLogs(200);
          if (res && res.data) {
            activities = res.data.map(function (row) {
              return {
                id: row.id,
                type: row.type,
                title: row.title,
                description: row.description || '',
                timestamp: new Date(row.created_at).getTime(),
                severity: row.severity || 'info',
                user: row.user_name || row.user_id || 'System'
              };
            });
            filteredActivities = activities;
            applyFilters();
            updateStats();
          }
        } catch (e) {
          console.error('Failed to fetch activity logs', e);
        }
      }

      function refreshLog() {
        fetchActivityLogs();
      }

      async function showLoggedInUser() {
        try {
          if (!window.supabaseAuth) return;
          const result = await window.supabaseAuth.getCurrentUser();
          if (result && result.data && result.data.user) {
            var email = result.data.user.email || 'Unknown user';
            var lbl = document.getElementById('currentUserLabel');
            var el = document.getElementById('currentUserEmail');
            if (el) el.textContent = email;
            if (lbl) lbl.classList.remove('hidden');
          }
        } catch (_) { }
      }

      function logout() {
        try {
          if (window.supabaseAuth) {
            window.supabaseAuth.signOut().then(function () {
              window.location.href = 'index.html';
            }).catch(function (e) {
              try { alert(e.message); } catch (_) { }
            });
          } else {
            window.location.href = 'index.html';
          }
        } catch (_) { window.location.href = 'index.html'; }
      }

      // Expose functions globally
      window.exportLog = exportLog;
      window.refreshLog = refreshLog;
      window.logout = logout;

      // Event listeners
      document.getElementById('dateRange').addEventListener('change', applyFilters);
      document.getElementById('activityType').addEventListener('change', applyFilters);
      document.getElementById('userFilter').addEventListener('input', applyFilters);
      document.getElementById('severityFilter').addEventListener('change', applyFilters);

      // Admin access control
      async function checkAdminAccess() {
        try {
          // Ensure Supabase is initialized
          if (!supabaseInitialized && window.initSupabaseWithRetry) {
            try { supabaseInitialized = await window.initSupabaseWithRetry(); } catch (_) { supabaseInitialized = false; }
          }
          // Check if user is authenticated
          const userResult = await window.supabaseAuth.getCurrentUser();

          if (userResult.error || !userResult.data || !userResult.data.user) {
            console.log('User not authenticated, blocking access');
            showAccessDenied();
            return false;
          }

          const user = userResult.data.user;

          // Check for legacy admin credentials first
          const email = user.email ? user.email.toLowerCase() : '';
          if (email === 'adminlibrarian@umak.edu.ph') {
            console.log('Legacy admin user detected, granting access');
            return true;
          }

          // Check if user is admin in database
          const adminResult = await window.supabaseDB.isAdmin(user.id);

          if (adminResult.error) {
            console.error('Error checking admin status:', adminResult.error);
            showAccessDenied();
            return false;
          }

          if (!adminResult.data) {
            console.log('User is not an admin, blocking access');
            showAccessDenied();
            return false;
          }

          return true;
        } catch (error) {
          console.error('Error in admin access check:', error);
          showAccessDenied();
          return false;
        }
      }

      // Show access denied message
      function showAccessDenied() {
        document.body.innerHTML = `
          <div class="min-h-screen bg-slate-50 flex items-center justify-center">
            <div class="bg-white rounded-xl shadow-lg p-8 max-w-md mx-4 text-center">
              <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
              </div>
              <h1 class="text-2xl font-bold text-slate-900 mb-2">Access Denied</h1>
              <p class="text-slate-600 mb-6">You don't have permission to access the admin panel. Only administrators can view this page.</p>
              <div class="space-y-3">
                <a href="Frame_4.html" class="block w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                  Go to Student Dashboard
                </a>
                <a href="index.html" class="block w-full px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition">
                  Back to Login
                </a>
              </div>
            </div>
          </div>
        `;
      }

      // Show loading state
      function showLoadingState() {
        const loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'loading-overlay';
        loadingOverlay.className = 'fixed inset-0 bg-slate-50 flex items-center justify-center z-50';
        loadingOverlay.innerHTML = `
          <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <p class="text-slate-600">Verifying admin access...</p>
          </div>
        `;
        document.body.appendChild(loadingOverlay);
      }

      // Hide loading state
      function hideLoadingState() {
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
          loadingOverlay.remove();
        }
      }

      // Initialize with admin check
      async function initialize() {
        showLoadingState();
        // Initialize Supabase first
        try {
          if (window.initSupabaseWithRetry) {
            supabaseInitialized = await window.initSupabaseWithRetry();
          } else if (window.initSupabase) {
            supabaseInitialized = !!window.initSupabase();
          }
        } catch (_) { supabaseInitialized = false; }

        // Check admin access
        const hasAccess = await checkAdminAccess();
        if (hasAccess) {
          // Hide loading state and initialize admin content
          hideLoadingState();
          // Show logged in user in header
          showLoggedInUser();
          fetchActivityLogs();
        }
      }

      // Initialize
      initialize();
    })();
  </script>
  <script>
    // Fade-on-scroll transitions (CSS-vars driven like Frame 6)
    (function () {
      var fadeElements = Array.from(document.querySelectorAll('[data-fade]'));
      if (fadeElements.length === 0) return;

      fadeElements.forEach(function (el) {
        var initialOpacity = parseFloat(el.getAttribute('data-initial-opacity') || '0');
        var duration = parseInt(el.getAttribute('data-duration') || '1000', 10);
        var easing = el.getAttribute('data-easing') || 'ease-out';
        var blurAttr = el.getAttribute('data-blur');
        var blurEnabled = (blurAttr !== 'false');
        var blurPxAttr = el.getAttribute('data-blur-px');
        var blurPx = parseInt(blurPxAttr || '14', 10);
        el.style.opacity = String(initialOpacity);
        el.style.setProperty('--fade-init', blurPx + 'px');
        el.style.setProperty('--fade-transition', 'opacity ' + duration + 'ms ' + easing + ', filter ' + duration + 'ms ' + easing);
      });

      var observer = new IntersectionObserver(function (entries) {
        entries.forEach(function (entry) {
          if (entry.isIntersecting) {
            var el = entry.target;
            var delay = parseInt(el.getAttribute('data-delay') || '0', 10);
            var blurAttr = el.getAttribute('data-blur');
            var blurEnabled = (blurAttr !== 'false');
            observer.unobserve(el);
            setTimeout(function () {
              el.style.opacity = '1';
              if (blurEnabled) {
                el.style.setProperty('--fade-init', '0px');
              }
            }, delay);
          }
        });
      }, { threshold: 0.1 });

      fadeElements.forEach(function (el) { observer.observe(el); });
    })();

    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  </script>
</body>

</html>