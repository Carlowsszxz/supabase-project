<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="UMak_Logo_Registered.png" />
  <meta http-equiv="Content-Security-Policy" content="connect-src 'self' https://*.supabase.co wss://*.supabase.co;" />
  <title>University of Makati Library - Reports</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="theme.css" />
  <script defer src="theme.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <style>
    /* First-paint blur + transition variables */
    [data-fade] {
      opacity: 0;
      --fade-init: 14px;
      --fade-filter: none;
      filter: var(--fade-filter) !important;
      transition: var(--fade-transition, opacity 1000ms ease-out, filter 1000ms ease-out) !important;
      will-change: opacity, filter;
    }

    [data-fade]:not([data-blur="false"]) {
      --fade-filter: blur(var(--fade-init));
    }

    /* Modern Top Navigation Bar */
    .modern-sidebar {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: auto;
      min-width: 320px;
      max-width: 500px;
      height: auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-top: none;
      border-radius: 0 0 20px 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.05);
      z-index: 1000;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      padding: 1rem 2rem;
      gap: 1rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Top Navigation Items */
    .sidebar-nav-item {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(0, 0, 0, 0.3);
      color: #374151;
      text-decoration: none;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    .sidebar-nav-item:hover {
      transform: translateY(-2px) scale(1.05);
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(0, 0, 0, 0.5);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15), 0 0 20px rgba(59, 130, 246, 0.3);
    }

    .sidebar-nav-item:active {
      transform: translateY(0) scale(0.98);
    }

    .sidebar-nav-item.active {
      background: rgba(59, 130, 246, 0.2);
      border-color: rgba(59, 130, 246, 0.4);
      color: #3b82f6;
    }

    /* Sidebar Icons */
    .sidebar-icon {
      width: 24px;
      height: 24px;
      stroke-width: 1.5;
    }

    /* Tooltips */
    .sidebar-tooltip {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-top: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
      z-index: 1001;
    }

    .sidebar-tooltip::before {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-bottom-color: rgba(0, 0, 0, 0.9);
    }

    .sidebar-nav-item:hover .sidebar-tooltip {
      opacity: 1;
      visibility: visible;
    }

    /* Logo/Brand in Top Navigation */
    .sidebar-brand {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 0.5rem;
    }

    .sidebar-brand img {
      width: 32px;
      height: 32px;
      border-radius: 6px;
    }

    .sidebar-brand-text {
      font-size: 1.125rem;
      font-weight: 600;
      color: #374151;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .modern-sidebar {
        min-width: 280px;
        max-width: 90vw;
        padding: 0.75rem 1rem;
        gap: 0.75rem;
      }

      .sidebar-nav-item {
        width: 40px;
        height: 40px;
      }

      .sidebar-icon {
        width: 20px;
        height: 20px;
      }

      .sidebar-brand img {
        width: 28px;
        height: 28px;
      }

      .sidebar-brand-text {
        font-size: 1rem;
      }
    }

    /* Dark Mode Support */
    @media (prefers-color-scheme: dark) {
      .modern-sidebar {
        background: rgba(15, 23, 42, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-top: none;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.05);
      }

      .sidebar-nav-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #e5e7eb;
      }

      .sidebar-nav-item:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 20px rgba(59, 130, 246, 0.4);
      }

      .sidebar-nav-item.active {
        background: rgba(59, 130, 246, 0.3);
        border-color: rgba(59, 130, 246, 0.5);
        color: #60a5fa;
      }

      .sidebar-brand-text {
        color: #e5e7eb;
      }
    }

    /* Manual dark mode class support */
    .dark .modern-sidebar {
      background: rgba(15, 23, 42, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-top: none;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.05);
    }

    .dark .sidebar-nav-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #e5e7eb;
    }

    .dark .sidebar-nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 20px rgba(59, 130, 246, 0.4);
    }

    .dark .sidebar-nav-item.active {
      background: rgba(59, 130, 246, 0.3);
      border-color: rgba(59, 130, 246, 0.5);
      color: #60a5fa;
    }

    .dark .sidebar-brand-text {
      color: #e5e7eb;
    }

    /* Adjust main content for top navigation */
    .main-with-sidebar {
      padding-top: 5rem;
    }

    /* Table row hover styling for better readability */
    tbody tr {
      transition: background-color 0.2s ease, transform 0.1s ease;
    }

    tbody tr:hover {
      background-color: rgba(241, 245, 249, 0.8) !important;
    }

    tbody tr:hover td {
      color: #000000 !important;
    }

    /* Ensure Reporter column text turns black on hover */
    tbody tr:hover td .text-slate-700 {
      color: #000000 !important;
    }

    tbody tr:hover button {
      color: inherit !important;
    }

    /* Preserve specific button colors on hover */
    tbody tr:hover button.bg-red-600,
    tbody tr:hover button.bg-red-500 {
      color: white !important;
    }

    tbody tr:hover button.bg-green-600,
    tbody tr:hover button.bg-green-500 {
      color: white !important;
    }

    tbody tr:hover button.bg-blue-600,
    tbody tr:hover button.bg-blue-500 {
      color: white !important;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">
  <!-- Modern Top Navigation Bar -->
  <nav class="modern-sidebar" data-fade data-blur="true" data-initial-opacity="0" data-duration="1000">
    <!-- Brand/Logo -->
    <div class="sidebar-brand">
      <img src="UMak_Logo_Registered.png" alt="University of Makati Logo" />
    </div>

    <!-- Navigation Items -->
    <a href="Frame_6.html" class="sidebar-nav-item" aria-label="Dashboard">
      <i data-lucide="layout-dashboard" class="sidebar-icon"></i>
      <div class="sidebar-tooltip">Dashboard</div>
    </a>

    <a href="Frame_7.html" class="sidebar-nav-item" aria-label="Log">
      <i data-lucide="file-text" class="sidebar-icon"></i>
      <div class="sidebar-tooltip">Log</div>
    </a>

    <a href="Frame_18.html" class="sidebar-nav-item active" aria-label="Reports">
      <i data-lucide="bar-chart-3" class="sidebar-icon"></i>
      <div class="sidebar-tooltip">Reports</div>
    </a>

    <a href="Frame_15.html" class="sidebar-nav-item" aria-label="Users">
      <i data-lucide="users" class="sidebar-icon"></i>
      <div class="sidebar-tooltip">Users</div>
    </a>

    <a href="Frame_19.html" class="sidebar-nav-item" aria-label="Settings">
      <i data-lucide="settings" class="sidebar-icon"></i>
      <div class="sidebar-tooltip">Settings</div>
    </a>

    <button onclick="logout()" class="sidebar-nav-item" aria-label="Logout">
      <i data-lucide="log-out" class="sidebar-icon"></i>
      <div class="sidebar-tooltip">Logout</div>
    </button>
  </nav>

  <!-- Scoped UI/UX refinements to #admin-reports-root; visuals only, no logic changes -->
  <main id="admin-reports-root" class="main-with-sidebar flex-1 py-8 px-6" data-fade data-blur="true" data-blur-px="16"
    data-initial-opacity="0" data-duration="1000" data-delay="50">
    <div class="max-w-7xl mx-auto">
      <div class="mb-8" data-fade data-blur="true" data-initial-opacity="0" data-duration="900">
        <h1 class="text-3xl font-bold mb-2">Student Reports</h1>
        <p class="text-slate-600">View and handle submitted noise reports</p>
      </div>

      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 md:p-8 mb-8 card-hover" data-fade
        data-blur="true" data-initial-opacity="0" data-delay="75">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
          <div class="flex items-center gap-2 text-sm">
            <label class="text-slate-600">Filter:</label>
            <select id="filterType"
              class="px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500">
              <option value="all">All</option>
              <option value="critical">Critical</option>
              <option value="warning">Warning</option>
              <option value="info">Info</option>
              <option value="unresolved">Unresolved</option>
            </select>
          </div>
          <div class="flex items-center gap-2 text-sm">
            <button id="refreshBtn" class="px-3 py-2 h-10 rounded-lg btn-outline">Refresh</button>
            <button id="deleteAllBtn"
              class="px-3 py-2 h-10 rounded-lg bg-red-600 hover:bg-red-700 text-white transition-all duration-200 ease-in-out">Delete
              All
              Messages</button>
          </div>
        </div>

        <div class="overflow-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-slate-500 border-b">
                <th class="py-2 pr-3">When</th>
                <th class="py-2 pr-3">Reporter</th>
                <th class="py-2 pr-3">Details</th>
                <th class="py-2 pr-3">Notes</th>
                <th class="py-2 pr-3">Action</th>
              </tr>
            </thead>
            <tbody id="reportRows">
              <tr>
                <td colspan="5" class="py-6 text-center text-slate-400">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Admin Reply Section -->
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 md:p-8 mb-8 card-hover" data-fade
        data-blur="true" data-initial-opacity="0" data-delay="100">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-slate-900">Admin Replies</h2>
          <button id="refreshAdminReplies"
            class="px-3 py-1 rounded bg-slate-200 hover:bg-slate-300 text-sm">Refresh</button>
        </div>
        <!-- Admin Post Form -->
        <form id="adminReplyForm" class="mb-6 flex flex-col md:flex-row gap-3 items-start md:items-end">
          <input type="text" id="adminReplyLocation"
            class="border border-slate-300 rounded-lg px-3 py-2 w-full md:w-48 focus:ring-2 focus:ring-indigo-500"
            placeholder="Location (optional)">
          <input type="text" id="adminReplyNotes"
            class="border border-slate-300 rounded-lg px-3 py-2 flex-1 focus:ring-2 focus:ring-indigo-500"
            placeholder="Admin Reply Message" required>
          <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Post as
            Admin</button>
        </form>
        <div id="adminRepliesList" class="space-y-3"></div>
      </div>
    </div>
  </main>

  <footer class="text-center text-xs text-slate-500 py-3" data-fade data-blur="true" data-initial-opacity="0"
    data-delay="150">© 2025 UMak Library · Noise Comfort Index</footer>

  <script>
    (function () {
      // Robust mobile menu toggle
      try {
        var mmBtn = document.getElementById('mobile-menu-btn');
        var mmenu = document.getElementById('mobile-menu');
        var hdr = document.querySelector('header.site-header');
        if (mmBtn && mmenu && hdr) {
          mmBtn.addEventListener('click', function () {
            var hidden = mmenu.classList.contains('hidden');
            if (hidden) { hdr.classList.add('menu-open'); mmenu.classList.remove('hidden'); mmBtn.setAttribute('aria-expanded', 'true'); }
            else { hdr.classList.remove('menu-open'); mmenu.classList.add('hidden'); mmBtn.setAttribute('aria-expanded', 'false'); }
          });
        }
      } catch (_) { }

      var supabaseInitialized = false;
      var rowsEl = document.getElementById('reportRows');
      var filterSel = document.getElementById('filterType');
      var refreshBtn = document.getElementById('refreshBtn');


      function fmtTime(ts) {
        try { return new Date(ts).toLocaleString(); } catch (_) { return '—'; }
      }

      function severityOf(level) {
        if (level >= 4.5) return 'critical';
        if (level >= 3) return 'warning';
        return 'info';
      }

      function renderRows(items) {
        if (!rowsEl) return;
        if (!items || items.length === 0) {
          rowsEl.innerHTML = '<tr><td colspan="4" class="py-6 text-center text-slate-400">No reports</td></tr>';
          return;
        }
        rowsEl.innerHTML = '';
        items.forEach(function (r) {
          var tr = document.createElement('tr');
          tr.className = 'border-b last:border-0';
          var sev = severityOf(parseFloat(r.noise_level || 0));
          var badgeCls = sev === 'critical' ? 'bg-red-100 text-red-800' : (sev === 'warning' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800');
          var statusChip = r.canceled_at ? '<span class="px-2 py-0.5 text-xs rounded bg-slate-200 text-slate-700">Canceled</span>' : (r.resolved_at ? '<span class="px-2 py-0.5 text-xs rounded bg-blue-600 text-white">Resolved</span>' : '');
          var icon = sev === 'critical' ? '🔴' : (sev === 'warning' ? '🟡' : '🟢');
          var isAdmin = r.notes && r.notes.toLowerCase().includes('posted by admin');
          tr.innerHTML = `
            <td class="py-2 pr-3">${fmtTime(r.created_at)}</td>
            <td class="py-2 pr-3">
              <div class="text-sm text-slate-700">
                ${r.reporter_email || 'Anonymous'}
              </div>
            </td>
            <td class="py-2 pr-3">
              <div class="flex items-center gap-2">
                <span class="text-base">${icon}</span>
                <span class="font-medium">${r.table_id || r.location || '—'}</span>
                <span class="text-xs px-2 py-0.5 rounded ${badgeCls}">${sev}</span>
                ${statusChip}
                ${isAdmin ? '<span class="ml-2 px-2 py-0.5 text-xs rounded bg-indigo-600 text-white font-semibold">Admin</span>' : ''}
              </div>
            </td>
            <td class="py-2 pr-3 max-w-[420px] truncate" title="${r.notes || ''}">${r.notes || '—'}</td>
            <td class="py-2 pr-3">
              <div class="flex items-center gap-2">
                ${isAdmin
              ? `<button class=\"px-3 py-1 text-xs rounded bg-red-600 hover:bg-red-700 text-white\" data-action=\"delete\" data-id=\"${r.id}\">Delete</button>`
              : (r.canceled_at ? '<button disabled class="px-3 py-1 text-xs rounded bg-slate-200">Canceled</button>' : (r.resolved_at ? '<button disabled class="px-3 py-1 text-xs rounded bg-blue-600 text-white">Resolved</button>' : `<button class=\"px-3 py-1 text-xs rounded bg-green-600 hover:bg-green-700 text-white\" data-action=\"resolve\" data-id=\"${r.id}\" data-uid=\"${r.user_id}\">Mark Resolved</button>`)) + ` <button class=\"px-3 py-1 text-xs rounded bg-red-600 hover:bg-red-700 text-white\" data-action=\"delete\" data-id=\"${r.id}\">Delete</button>`}
              </div>
            </td>`;
          rowsEl.appendChild(tr);
        });
      }

      function applyFilter(list) {
        var type = filterSel ? filterSel.value : 'all';
        if (type === 'all') return list;
        if (type === 'unresolved') return list.filter(function (r) { return !r.resolved_at; });
        return list.filter(function (r) { return severityOf(parseFloat(r.noise_level || 0)) === type; });
      }

      function fetchReports() {
        if (!supabaseInitialized) return;
        // Use noise_logs as source of student reports
        window.supabaseDB.getNoiseLogs('*', 200).then(function (result) {
          var data = Array.isArray(result.data) ? result.data : [];
          // Sort newest first
          data.sort(function (a, b) { return new Date(b.created_at) - new Date(a.created_at); });
          renderRows(applyFilter(data));
        }).catch(function (err) {
          console.error('Failed to fetch reports:', err);
        });
      }

      async function resolveReport(id, userId) {
        if (!supabaseInitialized) return;
        try {
          // Mark as resolved (kept for audit until deleted explicitly)
          await window.supabaseDB.resolveNoiseLog(parseInt(id, 10));
          const cur = await window.supabaseAuth.getCurrentUser();
          const adminUser = cur && cur.data ? cur.data.user : null;
          if (adminUser && adminUser.id) {
            try { await window.supabaseDB.addAlert(adminUser.id, 'info', 'Report ' + id + ' resolved'); } catch (_) { }
            // Notify the student their report was resolved
            if (userId) {
              try { await window.supabaseDB.adminAddUserAlert(userId, 'info', 'Your report #' + id + ' has been resolved.'); } catch (_) { }
            }
          }
        } catch (e) {
          console.error('Failed to resolve report:', e);
        } finally {
          fetchReports();
        }
      }

      async function deleteReport(id) {
        if (!supabaseInitialized) return;
        try {
          await window.supabaseDB.deleteNoiseLog(parseInt(id, 10));
        } catch (e) {
          console.error('Failed to delete report:', e);
        } finally {
          fetchReports();
        }
      }

      // Admin Reply Functions
      function loadAdminReplies() {
        var list = document.getElementById('adminRepliesList');
        if (!list) return;
        if (!window.supabaseDB || !window.supabaseDB.publicListReports) {
          list.innerHTML = '<div class="text-center text-red-600 py-6 text-sm">Supabase is not initialized</div>';
          return;
        }
        list.innerHTML = '<div class="text-center text-slate-500 py-6 text-sm">Loading…</div>';
        window.supabaseDB.publicListReports(50).then(function (result) {
          var rows = Array.isArray(result.data) ? result.data : [];
          if (result.error) {
            list.innerHTML = '<div class="text-center text-red-600 py-6 text-sm">Error: ' + (result.error.message || result.error) + '</div>';
            return;
          }
          if (rows.length === 0) {
            list.innerHTML = '<div class="text-center text-slate-500 py-8"><p>No admin replies yet</p><p class="text-sm">Admin replies will appear here</p></div>';
            return;
          }
          list.innerHTML = '';
          rows.forEach(function (r) {
            var isAdmin = r.notes && r.notes.toLowerCase().includes('posted by admin');
            if (!isAdmin) return; // Only show admin posts

            var el = document.createElement('div');
            el.className = 'p-3 rounded-lg border border-slate-200 bg-indigo-50 border-indigo-400';
            el.innerHTML = '<div class="flex items-start justify-between">' +
              '<div>' +
              '<div class="flex items-center gap-2">' +
              '<span class="px-2 py-0.5 text-xs rounded bg-indigo-600 text-white font-semibold">Admin</span>' +
              '<span class="text-sm text-slate-600">' + (r.location || r.table_id || '—') + '</span>' +
              '</div>' +
              '<div class="text-xs text-slate-500 mt-1">' + new Date(r.created_at).toLocaleString() + '</div>' +
              '<div class="text-sm text-slate-700 mt-1">' + (r.notes || '') + '</div>' +
              '</div>' +
              '<div class="text-xs text-slate-500">' + (r.status || '') + '</div>' +
              '</div>';
            list.appendChild(el);
          });
        }).catch(function (err) {
          list.innerHTML = '<div class="text-center text-red-600 py-6 text-sm">Failed to load admin replies.<br>' + (err && err.message ? err.message : err) + '</div>';
        });
      }

      function wireEvents() {
        if (filterSel) filterSel.addEventListener('change', fetchReports);
        if (refreshBtn) refreshBtn.addEventListener('click', fetchReports);
        if (rowsEl) rowsEl.addEventListener('click', function (e) {
          var t = e.target;
          if (t && t.getAttribute('data-action') === 'resolve') {
            var id = t.getAttribute('data-id');
            var uid = t.getAttribute('data-uid');
            t.disabled = true;
            resolveReport(id, uid);
          }
          if (t && t.getAttribute('data-action') === 'delete') {
            var delId = t.getAttribute('data-id');
            t.disabled = true;
            deleteReport(delId);
          }
        });

        // Admin reply events
        var refreshAdminBtn = document.getElementById('refreshAdminReplies');
        if (refreshAdminBtn) refreshAdminBtn.addEventListener('click', loadAdminReplies);

        var adminForm = document.getElementById('adminReplyForm');
        if (adminForm) {
          adminForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            var loc = document.getElementById('adminReplyLocation').value.trim();
            var notes = document.getElementById('adminReplyNotes').value.trim();
            if (!notes) return;
            var userResult = await window.supabaseAuth.getCurrentUser();
            var user = userResult && userResult.data ? userResult.data.user : null;
            if (!user) { alert('Not logged in'); return; }
            var fullNotes = notes + ' (Posted by Admin)';
            var res = await window.supabaseDB.addNoiseLog(user.id, loc, null, 'report', fullNotes);
            if (res && res.error) {
              alert('Failed to post: ' + (res.error.message || res.error));
            } else {
              adminForm.reset();
              loadAdminReplies();
            }
          });
        }
      }

      async function checkAdminAccess() {
        try {
          const userResult = await window.supabaseAuth.getCurrentUser();
          if (userResult.error || !userResult.data || !userResult.data.user) {
            // Not logged in, go to login without bouncing back
            window.location.replace('index.html?from=reports');
            return false;
          }
          const user = userResult.data.user;
          const email = user.email ? user.email.toLowerCase() : '';
          if (email === 'adminlibrarian@umak.edu.ph') return true;
          const adminResult = await window.supabaseDB.isAdmin(user.id);
          return !!(adminResult && adminResult.data);
        } catch (_) { return false; }
      }

      function logout() {
        try {
          if (window.supabaseAuth) {
            window.supabaseAuth.signOut().then(function () { window.location.href = 'index.html'; }).catch(function () { window.location.href = 'index.html'; });
          } else { window.location.href = 'index.html'; }
        } catch (_) { window.location.href = 'index.html'; }
      }
      window.logout = logout;

      // Initialize
      (async function init() {
        try {
          var ok = await initSupabaseWithRetry();
          supabaseInitialized = !!ok;
          console.log(ok ? 'Connected to Supabase' : 'Supabase not available');
          var allowed = await checkAdminAccess();
          if (!allowed) { window.location.replace('index.html?from=reports'); return; }
          wireEvents();
          fetchReports();
          loadAdminReplies();
          // Poll every 5 seconds
          setInterval(fetchReports, 5000);
          setInterval(loadAdminReplies, 5000);
        } catch (e) {
          console.error(e);
          console.error('Initialization error');
        }
      })();

      // Add after DOMContentLoaded or main script init
      var deleteAllBtn = document.getElementById('deleteAllBtn');
      if (deleteAllBtn) {
        deleteAllBtn.addEventListener('click', async function () {
          if (!confirm('Are you sure you want to delete ALL messages? This cannot be undone.')) return;
          try {
            // Fetch all report IDs
            var allRows = Array.from(rowsEl.querySelectorAll('button[data-action="delete"]'));
            for (const btn of allRows) {
              const id = btn.getAttribute('data-id');
              if (id) {
                await window.supabaseDB.deleteNoiseLog(parseInt(id, 10));
              }
            }
            fetchReports();
            console.log('All messages deleted.');
          } catch (e) {
            console.error('Failed to delete all:', e);
          }
        });
      }
    })();
  </script>
  <script>
    // Fade-on-scroll transitions (CSS-vars driven)
    (function () {
      var fadeElements = Array.from(document.querySelectorAll('[data-fade]'));
      if (fadeElements.length === 0) return;

      fadeElements.forEach(function (el) {
        var initialOpacity = parseFloat(el.getAttribute('data-initial-opacity') || '0');
        var duration = parseInt(el.getAttribute('data-duration') || '1000', 10);
        var easing = el.getAttribute('data-easing') || 'ease-out';
        var blurAttr = el.getAttribute('data-blur');
        var blurPxAttr = el.getAttribute('data-blur-px');
        var blurPx = parseInt(blurPxAttr || '14', 10);
        el.style.opacity = String(initialOpacity);
        el.style.setProperty('--fade-init', blurPx + 'px');
        el.style.setProperty('--fade-transition', 'opacity ' + duration + 'ms ' + easing + ', filter ' + duration + 'ms ' + easing);
      });

      var observer = new IntersectionObserver(function (entries) {
        entries.forEach(function (entry) {
          if (entry.isIntersecting) {
            var el = entry.target;
            var delay = parseInt(el.getAttribute('data-delay') || '0', 10);
            var blurAttr = el.getAttribute('data-blur');
            var blurEnabled = (blurAttr !== 'false');
            observer.unobserve(el);
            setTimeout(function () {
              el.style.opacity = '1';
              if (blurEnabled) {
                el.style.setProperty('--fade-init', '0px');
              }
            }, delay);
          }
        });
      }, { threshold: 0.1 });

      fadeElements.forEach(function (el) { observer.observe(el); });
    })();

    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  </script>
</body>

</html>