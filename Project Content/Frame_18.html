<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="UMak_Logo_Registered.png" />
  <meta http-equiv="Content-Security-Policy" content="connect-src 'self' https://*.supabase.co wss://*.supabase.co;" />
  <title>University of Makati Library - Reports</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="theme.css" />
  <script defer src="theme.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <style>
    /* First-paint blur + transition variables */
    [data-fade] {
      opacity: 0;
      --fade-init: 14px;
      --fade-filter: none;
      filter: var(--fade-filter) !important;
      transition: var(--fade-transition, opacity 1000ms ease-out, filter 1000ms ease-out) !important;
      will-change: opacity, filter;
    }

    [data-fade]:not([data-blur="false"]) {
      --fade-filter: blur(var(--fade-init));
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">
  <header class="site-header" data-fade data-blur="true" data-blur-px="16" data-initial-opacity="0"
    data-duration="1000">
    <div class="max-w-6xl mx-auto flex items-center gap-4 py-3 px-6">
      <img src="UMak_Logo_Registered.png" alt="University of Makati Logo" class="h-12 w-auto" />
      <a href="Frame_6.html" class="brand-title text-2xl font-semibold mr-auto">UMak Noise Monitor - Admin</a>
      <button id="mobile-menu-btn"
        class="md:hidden inline-flex items-center justify-center rounded-md p-2 text-slate-200 hover:text-white hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white"
        aria-label="Open main menu" aria-expanded="false">
        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
          aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
      <nav class="hidden md:flex items-center gap-4 text-sm">
        <a href="Frame_6.html" class="nav-link">Dashboard</a>
        <a href="Frame_7.html" class="nav-link">Log</a>
        <a href="Frame_9.html" class="nav-link">Alerts</a>
        <a href="Frame_18.html" class="nav-link active">Reports</a>
        <a href="Frame_15.html" class="nav-link">Users</a>
        <a href="Frame_19.html" class="nav-link">Settings</a>
        <button onclick="logout()" id="logoutBtn"
          class="px-3 py-1 rounded-lg bg-slate-200 hover:bg-slate-300 text-black transition"
          style="color: black !important;">Logout</button>
      </nav>
    </div>
    <nav id="mobile-menu" class="md:hidden hidden px-6 pb-3">
      <a href="Frame_6.html" class="block py-2 text-sm nav-link">Dashboard</a>
      <a href="Frame_7.html" class="block py-2 text-sm nav-link">Log</a>
      <a href="Frame_9.html" class="block py-2 text-sm nav-link">Alerts</a>
      <a href="Frame_18.html" class="block py-2 text-sm nav-link active">Reports</a>
      <a href="Frame_15.html" class="block py-2 text-sm nav-link">Users</a>
      <a href="Frame_19.html" class="block py-2 text-sm nav-link">Settings</a>
      <button onclick="logout()"
        class="mt-2 w-full px-3 py-2 rounded-lg bg-slate-200 hover:bg-slate-300 text-black transition"
        style="color: black !important;">Logout</button>
    </nav>
  </header>

  <!-- Scoped UI/UX refinements to #admin-reports-root; visuals only, no logic changes -->
  <main id="admin-reports-root" class="flex-1 py-8 px-6" data-fade data-blur="true" data-blur-px="16"
    data-initial-opacity="0" data-duration="1000" data-delay="50">
    <div class="max-w-7xl mx-auto">
      <div class="mb-8" data-fade data-blur="true" data-initial-opacity="0" data-duration="900">
        <h1 class="text-3xl font-bold mb-2">Student Reports</h1>
        <p class="text-slate-600">View and handle submitted noise reports</p>
      </div>

      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 md:p-8 mb-8 card-hover" data-fade
        data-blur="true" data-initial-opacity="0" data-delay="75">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
          <div class="flex items-center gap-2 text-sm">
            <label class="text-slate-600">Filter:</label>
            <select id="filterType"
              class="px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500">
              <option value="all">All</option>
              <option value="critical">Critical</option>
              <option value="warning">Warning</option>
              <option value="info">Info</option>
              <option value="unresolved">Unresolved</option>
            </select>
          </div>
          <div class="flex items-center gap-2 text-sm">
            <button id="refreshBtn" class="px-3 py-2 h-10 rounded-lg btn-outline">Refresh</button>
            <button id="deleteAllBtn"
              class="px-3 py-2 h-10 rounded-lg bg-red-600 hover:bg-red-700 text-white transition-all duration-200 ease-in-out">Delete
              All
              Messages</button>
          </div>
        </div>

        <div class="overflow-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-slate-500 border-b">
                <th class="py-2 pr-3">When</th>
                <th class="py-2 pr-3">Details</th>
                <th class="py-2 pr-3">Notes</th>
                <th class="py-2 pr-3">Action</th>
              </tr>
            </thead>
            <tbody id="reportRows">
              <tr>
                <td colspan="4" class="py-6 text-center text-slate-400">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <footer class="text-center text-xs text-slate-500 py-3" data-fade data-blur="true" data-initial-opacity="0"
    data-delay="150">Â© 2025 UMak Library Â· Noise Comfort Index</footer>

  <script>
    (function () {
      // Robust mobile menu toggle
      try {
        var mmBtn = document.getElementById('mobile-menu-btn');
        var mmenu = document.getElementById('mobile-menu');
        var hdr = document.querySelector('header.site-header');
        if (mmBtn && mmenu && hdr) {
          mmBtn.addEventListener('click', function () {
            var hidden = mmenu.classList.contains('hidden');
            if (hidden) { hdr.classList.add('menu-open'); mmenu.classList.remove('hidden'); mmBtn.setAttribute('aria-expanded', 'true'); }
            else { hdr.classList.remove('menu-open'); mmenu.classList.add('hidden'); mmBtn.setAttribute('aria-expanded', 'false'); }
          });
        }
      } catch (_) { }

      var supabaseInitialized = false;
      var rowsEl = document.getElementById('reportRows');
      var filterSel = document.getElementById('filterType');
      var refreshBtn = document.getElementById('refreshBtn');


      function fmtTime(ts) {
        try { return new Date(ts).toLocaleString(); } catch (_) { return 'â€”'; }
      }

      function severityOf(level) {
        if (level >= 4.5) return 'critical';
        if (level >= 3) return 'warning';
        return 'info';
      }

      function renderRows(items) {
        if (!rowsEl) return;
        if (!items || items.length === 0) {
          rowsEl.innerHTML = '<tr><td colspan="4" class="py-6 text-center text-slate-400">No reports</td></tr>';
          return;
        }
        rowsEl.innerHTML = '';
        items.forEach(function (r) {
          var tr = document.createElement('tr');
          tr.className = 'border-b last:border-0';
          var sev = severityOf(parseFloat(r.noise_level || 0));
          var badgeCls = sev === 'critical' ? 'bg-red-100 text-red-800' : (sev === 'warning' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800');
          var statusChip = r.canceled_at ? '<span class="px-2 py-0.5 text-xs rounded bg-slate-200 text-slate-700">Canceled</span>' : (r.resolved_at ? '<span class="px-2 py-0.5 text-xs rounded bg-blue-600 text-white">Resolved</span>' : '');
          var icon = sev === 'critical' ? 'ðŸ”´' : (sev === 'warning' ? 'ðŸŸ¡' : 'ðŸŸ¢');
          var isAdmin = r.notes && r.notes.toLowerCase().includes('posted by admin');
          tr.innerHTML = `
            <td class="py-2 pr-3">${fmtTime(r.created_at)}</td>
            <td class="py-2 pr-3">
              <div class="flex items-center gap-2">
                <span class="text-base">${icon}</span>
                <span class="font-medium">${r.table_id || r.location || 'â€”'}</span>
                <span class="text-xs px-2 py-0.5 rounded ${badgeCls}">${sev}</span>
                ${statusChip}
                ${isAdmin ? '<span class="ml-2 px-2 py-0.5 text-xs rounded bg-indigo-600 text-white font-semibold">Admin</span>' : ''}
              </div>
            </td>
            <td class="py-2 pr-3 max-w-[420px] truncate" title="${r.notes || ''}">${r.notes || 'â€”'}</td>
            <td class="py-2 pr-3">
              <div class="flex items-center gap-2">
                ${isAdmin
              ? `<button class=\"px-3 py-1 text-xs rounded bg-red-600 hover:bg-red-700 text-white\" data-action=\"delete\" data-id=\"${r.id}\">Delete</button>`
              : (r.canceled_at ? '<button disabled class="px-3 py-1 text-xs rounded bg-slate-200">Canceled</button>' : (r.resolved_at ? '<button disabled class="px-3 py-1 text-xs rounded bg-blue-600 text-white">Resolved</button>' : `<button class=\"px-3 py-1 text-xs rounded bg-green-600 hover:bg-green-700 text-white\" data-action=\"resolve\" data-id=\"${r.id}\" data-uid=\"${r.user_id}\">Mark Resolved</button>`)) + ` <button class=\"px-3 py-1 text-xs rounded bg-red-600 hover:bg-red-700 text-white\" data-action=\"delete\" data-id=\"${r.id}\">Delete</button>`}
              </div>
            </td>`;
          rowsEl.appendChild(tr);
        });
      }

      function applyFilter(list) {
        var type = filterSel ? filterSel.value : 'all';
        if (type === 'all') return list;
        if (type === 'unresolved') return list.filter(function (r) { return !r.resolved_at; });
        return list.filter(function (r) { return severityOf(parseFloat(r.noise_level || 0)) === type; });
      }

      function fetchReports() {
        if (!supabaseInitialized) return;
        // Use noise_logs as source of student reports
        window.supabaseDB.getNoiseLogs('*', 200).then(function (result) {
          var data = Array.isArray(result.data) ? result.data : [];
          // Sort newest first
          data.sort(function (a, b) { return new Date(b.created_at) - new Date(a.created_at); });
          renderRows(applyFilter(data));
        }).catch(function (err) {
          console.error('Failed to fetch reports:', err);
        });
      }

      async function resolveReport(id, userId) {
        if (!supabaseInitialized) return;
        try {
          // Mark as resolved (kept for audit until deleted explicitly)
          await window.supabaseDB.resolveNoiseLog(parseInt(id, 10));
          const cur = await window.supabaseAuth.getCurrentUser();
          const adminUser = cur && cur.data ? cur.data.user : null;
          if (adminUser && adminUser.id) {
            try { await window.supabaseDB.addAlert(adminUser.id, 'info', 'Report ' + id + ' resolved'); } catch (_) { }
            // Notify the student their report was resolved
            if (userId) {
              try { await window.supabaseDB.adminAddUserAlert(userId, 'info', 'Your report #' + id + ' has been resolved.'); } catch (_) { }
            }
          }
        } catch (e) {
          console.error('Failed to resolve report:', e);
        } finally {
          fetchReports();
        }
      }

      async function deleteReport(id) {
        if (!supabaseInitialized) return;
        try {
          await window.supabaseDB.deleteNoiseLog(parseInt(id, 10));
        } catch (e) {
          console.error('Failed to delete report:', e);
        } finally {
          fetchReports();
        }
      }

      function wireEvents() {
        if (filterSel) filterSel.addEventListener('change', fetchReports);
        if (refreshBtn) refreshBtn.addEventListener('click', fetchReports);
        if (rowsEl) rowsEl.addEventListener('click', function (e) {
          var t = e.target;
          if (t && t.getAttribute('data-action') === 'resolve') {
            var id = t.getAttribute('data-id');
            var uid = t.getAttribute('data-uid');
            t.disabled = true;
            resolveReport(id, uid);
          }
          if (t && t.getAttribute('data-action') === 'delete') {
            var delId = t.getAttribute('data-id');
            t.disabled = true;
            deleteReport(delId);
          }
        });
      }

      async function checkAdminAccess() {
        try {
          const userResult = await window.supabaseAuth.getCurrentUser();
          if (userResult.error || !userResult.data || !userResult.data.user) {
            // Not logged in, go to login without bouncing back
            window.location.replace('index.html?from=reports');
            return false;
          }
          const user = userResult.data.user;
          const email = user.email ? user.email.toLowerCase() : '';
          if (email === 'adminlibrarian@umak.edu.ph') return true;
          const adminResult = await window.supabaseDB.isAdmin(user.id);
          return !!(adminResult && adminResult.data);
        } catch (_) { return false; }
      }

      function logout() {
        try {
          if (window.supabaseAuth) {
            window.supabaseAuth.signOut().then(function () { window.location.href = 'index.html'; }).catch(function () { window.location.href = 'index.html'; });
          } else { window.location.href = 'index.html'; }
        } catch (_) { window.location.href = 'index.html'; }
      }
      window.logout = logout;

      // Initialize
      (async function init() {
        try {
          var ok = await initSupabaseWithRetry();
          supabaseInitialized = !!ok;
          console.log(ok ? 'Connected to Supabase' : 'Supabase not available');
          var allowed = await checkAdminAccess();
          if (!allowed) { window.location.replace('index.html?from=reports'); return; }
          wireEvents();
          fetchReports();
          // Poll every 5 seconds
          setInterval(fetchReports, 5000);
        } catch (e) {
          console.error(e);
          console.error('Initialization error');
        }
      })();

      // Add after DOMContentLoaded or main script init
      var deleteAllBtn = document.getElementById('deleteAllBtn');
      if (deleteAllBtn) {
        deleteAllBtn.addEventListener('click', async function () {
          if (!confirm('Are you sure you want to delete ALL messages? This cannot be undone.')) return;
          try {
            // Fetch all report IDs
            var allRows = Array.from(rowsEl.querySelectorAll('button[data-action="delete"]'));
            for (const btn of allRows) {
              const id = btn.getAttribute('data-id');
              if (id) {
                await window.supabaseDB.deleteNoiseLog(parseInt(id, 10));
              }
            }
            fetchReports();
            console.log('All messages deleted.');
          } catch (e) {
            console.error('Failed to delete all:', e);
          }
        });
      }
    })();
  </script>
  <script>
    // Fade-on-scroll transitions (CSS-vars driven)
    (function () {
      var fadeElements = Array.from(document.querySelectorAll('[data-fade]'));
      if (fadeElements.length === 0) return;

      fadeElements.forEach(function (el) {
        var initialOpacity = parseFloat(el.getAttribute('data-initial-opacity') || '0');
        var duration = parseInt(el.getAttribute('data-duration') || '1000', 10);
        var easing = el.getAttribute('data-easing') || 'ease-out';
        var blurAttr = el.getAttribute('data-blur');
        var blurPxAttr = el.getAttribute('data-blur-px');
        var blurPx = parseInt(blurPxAttr || '14', 10);
        el.style.opacity = String(initialOpacity);
        el.style.setProperty('--fade-init', blurPx + 'px');
        el.style.setProperty('--fade-transition', 'opacity ' + duration + 'ms ' + easing + ', filter ' + duration + 'ms ' + easing);
      });

      var observer = new IntersectionObserver(function (entries) {
        entries.forEach(function (entry) {
          if (entry.isIntersecting) {
            var el = entry.target;
            var delay = parseInt(el.getAttribute('data-delay') || '0', 10);
            var blurAttr = el.getAttribute('data-blur');
            var blurEnabled = (blurAttr !== 'false');
            observer.unobserve(el);
            setTimeout(function () {
              el.style.opacity = '1';
              if (blurEnabled) {
                el.style.setProperty('--fade-init', '0px');
              }
            }, delay);
          }
        });
      }, { threshold: 0.1 });

      fadeElements.forEach(function (el) { observer.observe(el); });
    })();
  </script>
</body>

</html>