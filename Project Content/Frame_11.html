<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Frame 11 - User Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="theme.css" />
  <script defer src="theme.js"></script>
  <style>
    .fade-content {
      opacity: var(--fade-initial-opacity, 0);
      will-change: opacity, filter;
      transition: opacity var(--fade-duration, 1000ms) var(--fade-easing, ease-out),
        filter var(--fade-duration, 1000ms) var(--fade-easing, ease-out);
    }

    .fade-content.is-visible {
      opacity: 1;
      filter: none;
    }

    /* Global fade-in (same system as Frame 15) */
    [data-fade] {
      opacity: 0;
      --fade-init: 14px;
      --fade-filter: none;
      filter: var(--fade-filter) !important;
      transition: var(--fade-transition, opacity 1000ms ease-out, filter 1000ms ease-out) !important;
      will-change: opacity, filter;
    }

    [data-fade]:not([data-blur="false"]) {
      --fade-filter: blur(var(--fade-init));
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">
  <header class="site-header" data-fade data-blur="true" data-initial-opacity="0" data-duration="1000">
    <div class="max-w-6xl mx-auto flex items-center gap-4 py-3 px-6">
      <img src="UMak_Logo_Registered.png" alt="University of Makati Logo" class="h-12 w-auto" />
      <a href="Frame_11.html" class="brand-title text-xl md:text-2xl font-semibold mr-auto">University of Makati
        Library</a>
      <button id="mobile-menu-btn"
        class="md:hidden inline-flex items-center justify-center rounded-md p-2 text-slate-200 hover:text-white hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white"
        aria-label="Open main menu" aria-expanded="false">
        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
          aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
      <nav class="hidden md:flex items-center gap-4 text-sm">
        <a href="Frame_11.html" class="nav-link active">Profile</a>
        <a href="Frame_8.html" class="nav-link">Map</a>
        <a href="Frame_16.html" class="nav-link">Report</a>
      </nav>
      <button id="logoutBtn"
        class="hidden md:inline px-3 py-1 rounded-lg bg-slate-200 hover:bg-slate-300 text-black transition">Logout</button>
    </div>
    <nav id="mobile-menu" class="md:hidden hidden px-6 pb-3">
      <a href="Frame_11.html" class="block py-2 text-sm nav-link active">Profile</a>
      <a href="Frame_8.html" class="block py-2 text-sm nav-link">Map</a>
      <a href="Frame_16.html" class="block py-2 text-sm nav-link">Report</a>
      <button id="logoutBtnMobile"
        class="mt-2 w-full px-3 py-2 rounded-lg bg-slate-200 hover:bg-slate-300 text-black transition text-left">Logout</button>
    </nav>
  </header>
  <main class="flex-1 flex items-start justify-center py-12 px-6" data-fade data-blur="true" data-initial-opacity="0"
    data-duration="1000" data-delay="50">
    <div class="w-full max-w-6xl">
      <div id="fade-content" class="fade-content" data-blur="true" data-duration="1000" data-easing="ease-out"
        data-initial-opacity="0" data-delay="0" data-threshold="0.1">

        <!-- Profile Header -->
        <section class="bg-white rounded-2xl shadow p-6 mb-6">
          <div class="flex items-start gap-6">
            <div class="w-24 h-24 rounded-full bg-slate-100 flex items-center justify-center text-2xl font-bold"
              id="avatar">—</div>
            <div class="flex-1">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div>
                  <h1 class="text-2xl font-semibold" id="displayName">—</h1>
                  <div class="text-sm text-slate-500">Student ID: <span id="studentId">—</span> · Program: <span
                      id="program">—</span></div>
                </div>
                <div class="flex items-center justify-center">
                  <button class="px-4 py-2 text-sm rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white hidden"
                    id="checkInBtn">Check In</button>
                </div>
              </div>
              <div class="mt-3 text-sm text-slate-500">Current session: <span id="currentSession">Not checked in</span>
              </div>
            </div>
          </div>
        </section>

        <!-- Complete Profile Banner/Form (hidden until needed) -->
        <section id="complete-profile" class="bg-white rounded-2xl shadow p-6 border border-yellow-100 mb-8 hidden">
          <div class="flex items-start gap-4">
            <div class="w-10 h-10 rounded-full bg-yellow-50 flex items-center justify-center">⚠️</div>
            <div class="flex-1">
              <h2 class="text-lg font-semibold mb-2">Complete your profile</h2>
              <p class="text-sm text-slate-600 mb-4">We need a few basic details to get you started.</p>
              <form id="profile-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="pf-first" class="block text-sm text-slate-700">First name</label>
                  <input id="pf-first" name="pf-first"
                    class="mt-1 block w-full rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none"
                    placeholder="First name" />
                </div>
                <div>
                  <label for="pf-last" class="block text-sm text-slate-700">Last name</label>
                  <input id="pf-last" name="pf-last"
                    class="mt-1 block w-full rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none"
                    placeholder="Last name" />
                </div>
                <div>
                  <label for="pf-studentId" class="block text-sm text-slate-700">Student ID <span
                      class="text-red-600">*</span></label>
                  <input id="pf-studentId" name="pf-studentId" required
                    class="mt-1 block w-full rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none"
                    placeholder="Student ID" />
                </div>
                <div>
                  <label for="pf-program" class="block text-sm text-slate-700">Program <span
                      class="text-red-600">*</span></label>
                  <input id="pf-program" name="pf-program" required
                    class="mt-1 block w-full rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none"
                    placeholder="e.g., BSIT" />
                </div>
                <div class="md:col-span-2 flex items-center justify-end gap-2 mt-2">
                  <button type="button" id="pf-cancel" class="px-3 py-2 text-sm rounded-lg btn-outline">Not now</button>
                  <button type="submit" id="pf-save"
                    class="px-4 py-2 text-sm rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white">Save</button>
                </div>
              </form>
              <div id="pf-msg" class="mt-3 text-sm text-slate-600 hidden"></div>
            </div>
          </div>
        </section>

        <!-- Current Session Status -->
        <section class="grid grid-cols-1 gap-6 mb-8">
          <div class="bg-white rounded-2xl shadow p-6 border border-slate-200">
            <h2 class="text-lg font-semibold mb-4">Current Session</h2>
            <div class="space-y-3">
              <div class="flex justify-between"><span class="text-slate-500">Seat</span><span id="currentSeat"
                  class="font-medium">—</span></div>
              <div class="flex justify-between"><span class="text-slate-500">Duration</span><span id="sessionDuration"
                  class="font-medium">—</span></div>
              <div class="mt-4">
                <button id="checkOutBtn"
                  class="w-full px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white hidden">Check Out</button>
              </div>
            </div>
          </div>
        </section>

        <!-- Main Content Grid -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 space-y-6">
            <!-- Study Status -->
            <div class="bg-white rounded-2xl shadow p-6 border border-slate-200">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold">Study Status</h2>
                <div class="flex items-center gap-2">
                  <div class="w-3 h-3 rounded-full bg-green-500"></div>
                  <span class="text-sm text-slate-500">Active</span>
                </div>
              </div>
              <div class="text-center py-8">
                <div class="text-4xl mb-2">📚</div>
                <div class="text-slate-600">Ready to study? Find a seat and get started!</div>
              </div>
            </div>

            <!-- Study Tips -->
            <div class="bg-white rounded-2xl shadow p-6 border border-slate-200 h-18">
              <h2 class="text-lg font-semibold mb-4">Study Tips</h2>
              <div class="space-y-3 text-sm">
                <div class="flex items-start gap-3">
                  <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                    <svg class="w-3 h-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                  </div>
                  <div>
                    <div class="font-medium text-slate-900">Find Your Quiet Zone</div>
                    <div class="text-slate-600">Choose seats away from high-traffic areas for better focus</div>
                  </div>
                </div>

                <div class="flex items-start gap-3">
                  <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                    <svg class="w-3 h-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                  <div>
                    <div class="font-medium text-slate-900">Take Regular Breaks</div>
                    <div class="text-slate-600">Follow the 25-5 rule: 25 minutes study, 5 minutes break</div>
                  </div>
                </div>

                <div class="flex items-start gap-3">
                  <div class="w-6 h-6 bg-yellow-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                    <svg class="w-3 h-3 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z">
                      </path>
                    </svg>
                  </div>
                  <div>
                    <div class="font-medium text-slate-900">Report Disturbances</div>
                    <div class="text-slate-600">Help maintain a quiet environment by reporting noise issues</div>
                  </div>
                </div>

                <div class="flex items-start gap-3 mt-6">
                  <div class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                    <svg class="w-3 h-3 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z">
                      </path>
                    </svg>
                  </div>
                  <div>
                    <div class="font-medium text-slate-900">Stay Hydrated</div>
                    <div class="text-slate-600">Keep water nearby and take regular hydration breaks</div>
                  </div>
                </div>

                <div class="flex items-start gap-3">
                  <div class="w-6 h-6 bg-indigo-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                    <svg class="w-3 h-3 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4">
                      </path>
                    </svg>
                  </div>
                  <div>
                    <div class="font-medium text-slate-900">Organize Your Space</div>
                    <div class="text-slate-600">Keep your study area clean and organized for better focus</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column -->
          <div class="space-y-6">


            <!-- Study Goals -->
            <div class="bg-white rounded-2xl shadow p-6 border border-slate-200">
              <h2 class="text-lg font-semibold mb-4">Study Goals</h2>
              <div class="space-y-3 text-sm">
                <div class="flex justify-between">
                  <span class="text-slate-500">Today's Target</span>
                  <span class="font-medium">4 hours</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-500">Completed</span>
                  <span class="font-medium">2h 30m</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-2">
                  <div class="bg-indigo-600 h-2 rounded-full w-[62%]"></div>
                </div>
              </div>
            </div>


            <!-- Study Progress -->
            <div class="bg-white rounded-2xl shadow p-6 border border-slate-200">
              <h2 class="text-lg font-semibold mb-4">Study Progress</h2>
              <div class="space-y-3 text-sm">
                <div class="flex justify-between">
                  <span class="text-slate-500">This Week</span>
                  <span class="font-medium">18h 45m</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-500">Streak</span>
                  <span class="font-medium">5 days</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-2">
                  <div class="bg-green-600 h-2 rounded-full w-[75%]"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>
  </main>
  <footer class="text-center text-xs text-slate-500 py-3" data-fade data-blur="true" data-initial-opacity="0"
    data-duration="1000" data-delay="100">© 2025 UMak Library · Noise Comfort Index</footer>
  <div id="supabase-status" class="px-2 py-1 rounded-md text-xs bg-slate-200 text-slate-700 hidden"></div>

  <!-- Seat Selection Modal -->
  <div id="seatModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Select a Seat</h3>
        <button id="closeSeatModal" class="px-2 py-1 text-sm btn-outline">Close</button>
      </div>
      <div class="grid grid-cols-5 gap-2 mb-4" id="seatGrid">
        <!-- Seats will be populated here -->
      </div>
      <div class="flex items-center justify-between text-sm text-slate-500">
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-1">
            <div class="w-3 h-3 rounded-full bg-green-500"></div> Available
          </div>
          <div class="flex items-center gap-1">
            <div class="w-3 h-3 rounded-full bg-red-500"></div> Occupied
          </div>
          <div class="flex items-center gap-1">
            <div class="w-3 h-3 rounded-full bg-yellow-500"></div> High Noise
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script src="auth-guard.js"></script>
  <script src="security.js"></script>

  <script>
    // Noise monitoring system
    (function () {
      var checkInBtn = document.getElementById('checkInBtn');
      var checkOutBtn = document.getElementById('checkOutBtn');
      var seatModal = document.getElementById('seatModal');
      var closeSeatModal = document.getElementById('closeSeatModal');
      var logoutBtn = document.getElementById('logoutBtn');
      var logoutBtnMobile = document.getElementById('logoutBtnMobile');

      function handleLogout() {
        try {
          if (window.supabaseAuth) {
            window.supabaseAuth.signOut().then(function () {
              window.location.href = 'index.html';
            }).catch(function (err) {
              console.error('Logout error:', err);
              window.location.href = 'index.html';
            });
          } else {
            window.location.href = 'index.html';
          }
        } catch (_) { window.location.href = 'index.html'; }
      }
      if (logoutBtn) { logoutBtn.addEventListener('click', handleLogout); }
      if (logoutBtnMobile) { logoutBtnMobile.addEventListener('click', handleLogout); }

      // Disable reservation: hide modal trigger
      if (checkInBtn) { checkInBtn.classList.add('hidden'); }
      // Ensure modal remains closed
      if (seatModal) { seatModal.classList.add('hidden'); seatModal.classList.remove('flex'); }
      // Disable checkout
      if (checkOutBtn) { checkOutBtn.classList.add('hidden'); }

      function setText(id, text) {
        var el = document.getElementById(id);
        if (el) el.textContent = text != null && text !== '' ? String(text) : '';
      }
      function setValue(id, val) {
        var el = document.getElementById(id);
        if (el) el.value = val != null ? String(val) : '';
      }

      // Supabase init with status
      function showStatus(text, ok) {
        var el = document.getElementById('supabase-status');
        if (!el) return;
        el.textContent = text || '';
        if (text) {
          el.classList.remove('hidden');
          el.classList.remove('bg-red-200', 'text-red-700');
          el.classList.remove('bg-green-200', 'text-green-700');
          if (ok) {
            el.classList.add('bg-green-200', 'text-green-700');
          } else {
            el.classList.add('bg-red-200', 'text-red-700');
          }
        } else {
          el.classList.add('hidden');
        }
      }

      // Initialize Supabase
      var supabaseInitialized = false;
      try {
        if (initSupabase()) {
          supabaseInitialized = true;
          showStatus('Supabase: Connected', true);
        } else {
          showStatus('Supabase: Error', false);
        }
      } catch (err) {
        showStatus('Supabase: Error', false);
      }

      function populateFromProfile(profile, user) {
        var fn = (profile && profile.firstName) || '';
        var ln = (profile && profile.lastName) || '';
        var display = (fn || ln) ? (fn + ' ' + ln).trim() : (user && user.email) || 'User';
        setText('displayName', display);
        var initials = (function () {
          var parts = display.trim().split(/\s+/).slice(0, 2);
          return parts.map(function (p) { return p[0] ? p[0].toUpperCase() : ''; }).join('');
        })();
        var avatarEl = document.getElementById('avatar');
        if (avatarEl && initials) avatarEl.textContent = initials;

        setText('studentId', ((profile && profile.studentId) ? String(profile.studentId).toUpperCase() : '—'));
        setText('program', profile && profile.program || '—');

        // Session data
        // View-only mode: always show not checked in and hide actions
        setText('currentSession', 'Not checked in');
        setText('currentSeat', '—');
        setText('sessionDuration', '—');
        setText('environmentStatus', 'View-only');
        if (checkOutBtn) checkOutBtn.classList.add('hidden');
        if (checkInBtn) checkInBtn.classList.add('hidden');

        // Environment preferences
        var noisePrefs = profile && profile.noisePreferences || {};
        setText('noiseAlerts', noisePrefs.alerts !== false ? 'On' : 'Off');
      }

      function formatDuration(startTime) {
        if (!startTime) return '—';
        var now = Date.now();
        var elapsed = now - startTime;
        var hours = Math.floor(elapsed / 3600000);
        var minutes = Math.floor((elapsed % 3600000) / 60000);
        return hours + 'h ' + minutes + 'm';
      }

      function loadAvailableSeats() {
        if (!db) return;
        db.ref('occupancy').once('value').then(function (snap) {
          var data = snap && snap.val ? (snap.val() || {}) : {};
          renderSeatViews(data);
        }).catch(function (_) { });
      }

      function subscribeSeatsRealtime() {
        if (!db) return;
        db.ref('occupancy').on('value', function (snap) {
          var data = snap && snap.val ? (snap.val() || {}) : {};
          renderSeatViews(data);
        });
      }

      function renderSeatViews(occData) {
        try {
          var available = [];
          Object.keys(occData || {}).forEach(function (tableId) {
            var seats = (occData[tableId] && occData[tableId].seats) || {};
            Object.keys(seats).forEach(function (seatNum) {
              var isOccupied = !!seats[seatNum];
              if (!isOccupied) {
                available.push({ id: tableId + '-' + seatNum, tableId: tableId, seatNum: seatNum });
              }
            });
          });
          available.sort(function (a, b) { return a.id.localeCompare(b.id); });

          var panel = document.getElementById('availableSeats');
          if (panel) {
            panel.innerHTML = '';
            if (available.length === 0) {
              var empty = document.createElement('div');
              empty.className = 'text-center text-slate-500 text-sm col-span-5';
              empty.textContent = 'No available seats right now.';
              panel.appendChild(empty);
            } else {
              available.forEach(function (seat) {
                var btn = document.createElement('button');
                btn.className = 'px-3 py-2 rounded-lg bg-green-500 text-white text-sm hover:opacity-90 transition';
                btn.textContent = seat.id.replace('table-', 'Table ').replace('-', ' • Seat ');
                btn.addEventListener('click', function () { selectSeat(seat.id); });
                panel.appendChild(btn);
              });
            }
          }

          var grid = document.getElementById('seatGrid');
          if (grid) {
            grid.innerHTML = '';
            // Also show occupied seats in red for context
            var allSeats = [];
            Object.keys(occData || {}).forEach(function (tableId) {
              var seats = (occData[tableId] && occData[tableId].seats) || {};
              Object.keys(seats).forEach(function (seatNum) {
                var occ = !!seats[seatNum];
                allSeats.push({ id: tableId + '-' + seatNum, available: !occ });
              });
            });
            if (allSeats.length === 0) {
              var loading = document.createElement('div');
              loading.className = 'text-center text-slate-500 text-sm col-span-5';
              loading.textContent = 'No seats configured.';
              grid.appendChild(loading);
            } else {
              allSeats.sort(function (a, b) { return a.id.localeCompare(b.id); });
              allSeats.forEach(function (seat) {
                var btn = document.createElement('button');
                btn.className = 'w-12 h-12 rounded-lg text-sm font-medium ' + (seat.available ? 'bg-green-500 text-white' : 'bg-red-500 text-white');
                btn.textContent = seat.id.split('-').pop();
                btn.disabled = !seat.available;
                if (seat.available) btn.addEventListener('click', function () { selectSeat(seat.id); });
                grid.appendChild(btn);
              });
            }
          }
        } catch (_) { }
      }

      (function () {
        var el = document.getElementById('fade-content');
        if (!el) return;
        var duration = parseInt(el.getAttribute('data-duration') || '1000', 10);
        var easing = el.getAttribute('data-easing') || 'ease-out';
        var initial = parseFloat(el.getAttribute('data-initial-opacity') || '0');
        var blur = el.getAttribute('data-blur') === 'true';
        var delay = parseInt(el.getAttribute('data-delay') || '0', 10);
        var threshold = parseFloat(el.getAttribute('data-threshold') || '0.1');

        el.style.setProperty('--fade-duration', duration + 'ms');
        el.style.setProperty('--fade-easing', easing);
        el.style.setProperty('--fade-initial-opacity', String(initial));
        if (blur) el.style.filter = 'blur(10px)';

        var io = new IntersectionObserver(function (entries) {
          var e = entries[0];
          if (e && e.isIntersecting) {
            io.unobserve(el);
            setTimeout(function () {
              try { el.style.filter = 'none'; } catch (_) { }
              el.classList.add('is-visible');
            }, Math.max(0, delay));
          }
        }, { threshold: isNaN(threshold) ? 0.1 : threshold });

        io.observe(el);
      })();

      function selectSeat(seatId) {
        // Check in to seat (basic optimistic flow)
        console.log('Checking in to seat:', seatId);
        if (!auth || !db || !auth.currentUser) { return; }
        var uid = auth.currentUser.uid;
        var parts = String(seatId).split('-');
        var tableId = parts.slice(0, 2).join('-');
        var seatNum = parts[2];
        var updates = {};
        updates['occupancy/' + tableId + '/seats/' + seatNum] = true;
        updates['users/' + uid + '/currentSession'] = { seatId: seatId, startTime: Date.now(), noiseLevel: 0 };
        db.ref().update(updates).then(function () {
          if (seatModal) { seatModal.classList.add('hidden'); seatModal.classList.remove('flex'); }
        }).catch(function (err) { console.error('Check-in failed', err); });
      }

      function checkOut() {
        // Check out from current seat
        if (!auth || !db || !auth.currentUser) { return; }
        var uid = auth.currentUser.uid;
        db.ref('users/' + uid + '/currentSession').once('value').then(function (snap) {
          var cur = snap && snap.val ? (snap.val() || null) : null;
          if (!cur || !cur.seatId) return;
          var parts = String(cur.seatId).split('-');
          var tableId = parts.slice(0, 2).join('-');
          var seatNum = parts[2];
          var updates = {};
          updates['occupancy/' + tableId + '/seats/' + seatNum] = false;
          updates['users/' + uid + '/currentSession'] = null;
          db.ref().update(updates).catch(function (err) { console.error('Check-out failed', err); });
        });
      }

      function showCompleteProfile(profile, user) {
        var missing = [];
        if (!profile || !profile.firstName) missing.push('firstName');
        if (!profile || !profile.lastName) missing.push('lastName');
        if (!profile || !profile.studentId) missing.push('studentId');
        if (!profile || !profile.program) missing.push('program');
        var wrapper = document.getElementById('complete-profile');
        if (!wrapper) return;
        if (missing.length > 0) {
          wrapper.classList.remove('hidden');
          setValue('pf-first', (profile && profile.firstName) || '');
          setValue('pf-last', (profile && profile.lastName) || '');
          setValue('pf-studentId', (profile && profile.studentId) || '');
          setValue('pf-program', (profile && profile.program) || '');
        } else {
          wrapper.classList.add('hidden');
        }
      }

      function wireProfileForm(uid) {
        var form = document.getElementById('profile-form');
        var cancel = document.getElementById('pf-cancel');
        var msg = document.getElementById('pf-msg');
        function showMsg(text) { if (!msg) return; msg.textContent = text || ''; if (text) msg.classList.remove('hidden'); else msg.classList.add('hidden'); }
        if (cancel) cancel.addEventListener('click', function () { var w = document.getElementById('complete-profile'); if (w) w.classList.add('hidden'); });
        if (!form) return;
        form.addEventListener('submit', function (e) {
          e.preventDefault(); showMsg('Saving...');
          // Use snake_case to match Supabase users schema
          var updates = {
            first_name: (document.getElementById('pf-first') || {}).value || '',
            last_name: (document.getElementById('pf-last') || {}).value || '',
            student_id: (document.getElementById('pf-studentId') || {}).value || '',
            program: (document.getElementById('pf-program') || {}).value || ''
          };
          if (!updates.student_id || !updates.program) { showMsg('Student ID and Program are required.'); return; }
          if (supabaseInitialized) {
            window.supabaseDB.updateUser(uid, updates).then(function (result) {
              if (result.error) throw result.error;
              showMsg('Saved.');
              setTimeout(function () {
                showMsg('');
                var w = document.getElementById('complete-profile');
                if (w) w.classList.add('hidden');
              }, 1000);
            }).catch(function (err) {
              showMsg(err && err.message ? err.message : 'Failed to save.');
            });
          } else {
            showMsg('Database not connected.');
          }
        });
      }

      // Auth gate and data load
      if (supabaseInitialized) {
        window.supabaseAuth.onAuthStateChange(function (event, session) {
          if (!session || !session.user) {
            window.location.href = 'index.html';
            return;
          }
          var user = session.user;
          var uid = user.id;
          wireProfileForm(uid);

          // Load user profile
          window.supabaseDB.getUser(uid).then(function (result) {
            var profile = {};
            if (result && result.data) {
              profile = {
                firstName: result.data.first_name || '',
                lastName: result.data.last_name || '',
                studentId: result.data.student_id || '',
                program: result.data.program || ''
              };
            }
            populateFromProfile(profile, user);
            showCompleteProfile(profile, user);
          }).catch(function (err) {
            console.error('Error loading profile:', err);
            populateFromProfile({}, user);
            showCompleteProfile({}, user);
          });
        });
      } else {
        // If Supabase not initialized, redirect to login
        window.location.href = 'index.html';
      }


      // Initialize the page

    })();
  </script>
  <script>
    // Fade-on-scroll transitions (copied from Frame 15)
    (function () {
      var fadeElements = Array.from(document.querySelectorAll('[data-fade]'));
      if (fadeElements.length === 0) return;

      fadeElements.forEach(function (el) {
        var initialOpacity = parseFloat(el.getAttribute('data-initial-opacity') || '0');
        var duration = parseInt(el.getAttribute('data-duration') || '1000', 10);
        var easing = el.getAttribute('data-easing') || 'ease-out';
        var blurPxAttr = el.getAttribute('data-blur-px');
        var blurPx = parseInt(blurPxAttr || '14', 10);
        el.style.opacity = String(initialOpacity);
        el.style.setProperty('--fade-init', blurPx + 'px');
        el.style.setProperty('--fade-transition', 'opacity ' + duration + 'ms ' + easing + ', filter ' + duration + 'ms ' + easing);
      });

      var observer = new IntersectionObserver(function (entries) {
        entries.forEach(function (entry) {
          if (entry.isIntersecting) {
            var el = entry.target;
            var delay = parseInt(el.getAttribute('data-delay') || '0', 10);
            var blurAttr = el.getAttribute('data-blur');
            var blurEnabled = (blurAttr !== 'false');
            observer.unobserve(el);
            setTimeout(function () {
              el.style.opacity = '1';
              if (blurEnabled) {
                el.style.setProperty('--fade-init', '0px');
              }
            }, delay);
          }
        });
      }, { threshold: 0.1 });

      fadeElements.forEach(function (el) { observer.observe(el); });
    })();
  </script>
  <script>
    // Mobile menu toggle for Frame 11
    (function () {
      var mobileBtn = document.getElementById('mobile-menu-btn');
      var mobileMenu = document.getElementById('mobile-menu');
      if (mobileBtn && mobileMenu) {
        mobileBtn.addEventListener('click', function () {
          mobileMenu.classList.toggle('hidden');
          var expanded = mobileBtn.getAttribute('aria-expanded') === 'true';
          mobileBtn.setAttribute('aria-expanded', (!expanded).toString());
        });
      }
    })();
  </script>
  <style>
    /* Make input text and placeholder clearly black in both themes */
    #profile-form input,
    #profile-form textarea {
      color: #000000;
      /* black */
    }

    #profile-form input::placeholder,
    #profile-form textarea::placeholder {
      color: #000000;
      /* black */
      opacity: 1;
    }

    /* Also apply to generic inputs if needed elsewhere on this page */
    input,
    textarea {
      color: #000000;
    }

    input::placeholder,
    textarea::placeholder {
      color: #000000;
      opacity: 1;
    }
  </style>
</body>

</html>