<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="UMak_Logo_Registered.png" />
  <title>University of Makati Library - User Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="theme.css" />
  <script defer src="theme.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="supabase.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <style>
    /* Unified fade-in animation (matched to Frame 18 for consistent UX) */
    [data-fade] {
      opacity: 0;
      --fade-init: 14px;
      --fade-filter: none;
      filter: var(--fade-filter) !important;
      transition: var(--fade-transition, opacity 1000ms ease-out, filter 1000ms ease-out) !important;
      will-change: opacity, filter;
    }

    [data-fade]:not([data-blur="false"]) {
      --fade-filter: blur(var(--fade-init));
    }

    /* Modern Top Navigation Bar */
    .modern-sidebar {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: auto;
      min-width: 320px;
      max-width: 500px;
      height: auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-top: none;
      border-radius: 0 0 20px 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.05);
      z-index: 1000;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      padding: 1rem 2rem;
      gap: 1rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Top Navigation Items */
    .sidebar-nav-item {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(0, 0, 0, 0.3);
      color: #374151;
      text-decoration: none;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    .sidebar-nav-item:hover {
      transform: translateY(-2px) scale(1.05);
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(0, 0, 0, 0.5);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15), 0 0 20px rgba(59, 130, 246, 0.3);
    }

    .sidebar-nav-item:active {
      transform: translateY(0) scale(0.98);
    }

    .sidebar-nav-item.active {
      background: rgba(59, 130, 246, 0.2);
      border-color: rgba(59, 130, 246, 0.4);
      color: #3b82f6;
    }

    /* Sidebar Icons */
    .sidebar-icon {
      width: 24px;
      height: 24px;
      stroke-width: 1.5;
    }

    /* Tooltips */
    .sidebar-tooltip {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-top: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
      z-index: 1001;
    }

    .sidebar-tooltip::before {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-bottom-color: rgba(0, 0, 0, 0.9);
    }

    .sidebar-nav-item:hover .sidebar-tooltip {
      opacity: 1;
      visibility: visible;
    }

    /* Logo/Brand in Top Navigation */
    .sidebar-brand {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 0.5rem;
    }

    .sidebar-brand img {
      width: 32px;
      height: 32px;
      border-radius: 6px;
    }

    .sidebar-brand-text {
      font-size: 1.125rem;
      font-weight: 600;
      color: #374151;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .modern-sidebar {
        min-width: 280px;
        max-width: 90vw;
        padding: 0.75rem 1rem;
        gap: 0.75rem;
      }

      .sidebar-nav-item {
        width: 40px;
        height: 40px;
      }

      .sidebar-icon {
        width: 20px;
        height: 20px;
      }

      .sidebar-brand img {
        width: 28px;
        height: 28px;
      }

      .sidebar-brand-text {
        font-size: 1rem;
      }
    }

    /* Dark Mode Support */
    @media (prefers-color-scheme: dark) {
      .modern-sidebar {
        background: rgba(15, 23, 42, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-top: none;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.05);
      }

      .sidebar-nav-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #e5e7eb;
      }

      .sidebar-nav-item:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 20px rgba(59, 130, 246, 0.4);
      }

      .sidebar-nav-item.active {
        background: rgba(59, 130, 246, 0.3);
        border-color: rgba(59, 130, 246, 0.5);
        color: #60a5fa;
      }

      .sidebar-brand-text {
        color: #e5e7eb;
      }
    }

    /* Manual dark mode class support */
    .dark .modern-sidebar {
      background: rgba(15, 23, 42, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-top: none;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.05);
    }

    .dark .sidebar-nav-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #e5e7eb;
    }

    .dark .sidebar-nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 20px rgba(59, 130, 246, 0.4);
    }

    .dark .sidebar-nav-item.active {
      background: rgba(59, 130, 246, 0.3);
      border-color: rgba(59, 130, 246, 0.5);
      color: #60a5fa;
    }

    .dark .sidebar-brand-text {
      color: #e5e7eb;
    }

    /* Adjust main content for top navigation */
    .main-with-sidebar {
      padding-top: 5rem;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">
  <!-- Modern Top Navigation Bar -->
  <nav class="modern-sidebar" data-fade data-blur="true" data-initial-opacity="0" data-duration="1000">
    <!-- Brand/Logo -->
    <div class="sidebar-brand">
      <img src="UMak_Logo_Registered.png" alt="University of Makati Logo" />
    </div>

    <!-- Navigation Items -->
    <a href="Frame_6.html" class="sidebar-nav-item" aria-label="Dashboard">
      <i data-lucide="layout-dashboard" class="sidebar-icon"></i>
      <div class="sidebar-tooltip">Dashboard</div>
    </a>

    <a href="Frame_7.html" class="sidebar-nav-item" aria-label="Log">
      <i data-lucide="file-text" class="sidebar-icon"></i>
      <div class="sidebar-tooltip">Log</div>
    </a>

    <a href="Frame_9.html" class="sidebar-nav-item" aria-label="Alerts">
      <i data-lucide="bell" class="sidebar-icon"></i>
      <div class="sidebar-tooltip">Alerts</div>
    </a>

    <a href="Frame_18.html" class="sidebar-nav-item" aria-label="Reports">
      <i data-lucide="bar-chart-3" class="sidebar-icon"></i>
      <div class="sidebar-tooltip">Reports</div>
    </a>

    <a href="Frame_15.html" class="sidebar-nav-item active" aria-label="Users">
      <i data-lucide="users" class="sidebar-icon"></i>
      <div class="sidebar-tooltip">Users</div>
    </a>

    <a href="Frame_19.html" class="sidebar-nav-item" aria-label="Settings">
      <i data-lucide="settings" class="sidebar-icon"></i>
      <div class="sidebar-tooltip">Settings</div>
    </a>

    <button onclick="logout()" class="sidebar-nav-item" aria-label="Logout">
      <i data-lucide="log-out" class="sidebar-icon"></i>
      <div class="sidebar-tooltip">Logout</div>
    </button>
  </nav>

  <main class="main-with-sidebar flex-1 py-8 px-6" data-fade data-blur="true" data-blur-px="16" data-initial-opacity="0"
    data-duration="1000" data-delay="50">
    <div class="max-w-7xl mx-auto">

      <!-- Users Management -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold mb-2">Users</h1>
        <p class="text-slate-600">Search users, view details, and manage admin access</p>
      </div>

      <!-- Search and Add User Section -->
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
        <div class="flex flex-col md:flex-row gap-4">
          <input type="text" id="user-search-input" placeholder="Search by email, name, student ID"
            class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
          <button onclick="searchUsers()"
            class="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition">
            Search
          </button>
          <button onclick="openAddUserModal()"
            class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 5v14M5 12h14" />
            </svg>
            Add User
          </button>
        </div>
      </div>

      <!-- Users Table Section -->
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-slate-50 border-b border-slate-200">
              <tr>
                <th class="px-6 py-3 text-left text-sm font-semibold text-slate-700">Name</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-slate-700">Email</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-slate-700">Student ID</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-slate-700">Program</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-slate-700">Created</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-slate-700">Admin</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-slate-700">Action</th>
              </tr>
            </thead>
            <tbody id="users-table-body" class="divide-y divide-slate-200">
              <!-- Users will be populated here -->
            </tbody>
          </table>
        </div>
        <div id="users-status" class="px-6 py-4 text-sm text-slate-600"></div>
      </div>

    </div>
  </main>

  <footer class="text-center text-xs text-slate-500 py-3" data-fade data-blur="true" data-initial-opacity="0"
    data-delay="150">© 2025 UMak Library · Noise Comfort Index</footer>
  <div id="toast" style="position:fixed;right:12px;bottom:48px;pointer-events:none"
    class="px-3 py-2 rounded-md text-sm bg-slate-800 text-white shadow hidden"></div>

            <button data-table="table-1" data-seat="1"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-green-300 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
            <button data-table="table-1" data-seat="2"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-green-300 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
            <button data-table="table-1" data-seat="3"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-green-300 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
            <button data-table="table-1" data-seat="4"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-green-300 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
            <button data-table="table-1" data-seat="5"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-green-300 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
          </div>
          <div class="text-sm text-slate-500">Occupancy: <span id="table-1-count">0</span>/5 seats</div>
        </div>

        <!-- Table 2 -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 bounce-in stagger-2">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">Table 2</h3>
            <div class="flex gap-2">
              <button onclick="clearAllSeats('table-2')"
                class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition">Clear
                All</button>
              <button onclick="occupyAllSeats('table-2')"
                class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition">Fill
                All</button>
            </div>
          </div>
          <div class="grid grid-cols-5 gap-2 mb-4">
            <button data-table="table-2" data-seat="1"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-green-300 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
            <button data-table="table-2" data-seat="2"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-red-500 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
            <button data-table="table-2" data-seat="3"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-green-300 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
            <button data-table="table-2" data-seat="4"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-green-300 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
            <button data-table="table-2" data-seat="5"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-green-300 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
          </div>
          <div class="text-sm text-slate-500">Occupancy: <span id="table-2-count">1</span>/5 seats</div>
        </div>

        <!-- Table 3 -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 bounce-in stagger-3">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">Table 3</h3>
            <div class="flex gap-2">
              <button onclick="clearAllSeats('table-3')"
                class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition">Clear
                All</button>
              <button onclick="occupyAllSeats('table-3')"
                class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition">Fill
                All</button>
            </div>
          </div>
          <div class="grid grid-cols-5 gap-2 mb-4">
            <button data-table="table-3" data-seat="1"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-red-500 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
            <button data-table="table-3" data-seat="2"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-red-500 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
            <button data-table="table-3" data-seat="3"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-red-500 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
            <button data-table="table-3" data-seat="4"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-red-500 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
            <button data-table="table-3" data-seat="5"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-red-500 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
          </div>
          <div class="text-sm text-slate-500">Occupancy: <span id="table-3-count">5</span>/5 seats</div>
        </div>

        <!-- Table 4 -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 bounce-in stagger-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">Table 4</h3>
            <div class="flex gap-2">
              <button onclick="clearAllSeats('table-4')"
                class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition">Clear
                All</button>
              <button onclick="occupyAllSeats('table-4')"
                class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition">Fill
                All</button>
            </div>
          </div>
          <div class="grid grid-cols-5 gap-2 mb-4">
            <button data-table="table-4" data-seat="1"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-green-300 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
            <button data-table="table-4" data-seat="2"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-green-300 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
            <button data-table="table-4" data-seat="3"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-green-300 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
            <button data-table="table-4" data-seat="4"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-green-300 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
            <button data-table="table-4" data-seat="5"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-green-300 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
          </div>
          <div class="text-sm text-slate-500">Occupancy: <span id="table-4-count">0</span>/5 seats</div>
        </div>

        <!-- Table 5 -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 bounce-in stagger-5">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">Table 5</h3>
            <div class="flex gap-2">
              <button onclick="clearAllSeats('table-5')"
                class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition">Clear
                All</button>
              <button onclick="occupyAllSeats('table-5')"
                class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition">Fill
                All</button>
            </div>
          </div>
          <div class="grid grid-cols-5 gap-2 mb-4">
            <button data-table="table-5" data-seat="1"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-red-500 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
            <button data-table="table-5" data-seat="2"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-red-500 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
            <button data-table="table-5" data-seat="3"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-red-500 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
            <button data-table="table-5" data-seat="4"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-red-500 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
            <button data-table="table-5" data-seat="5"
              class="seat-btn w-10 h-10 rounded-full border-2 border-slate-300 bg-red-500 hover:scale-105 transition"
              onclick="toggleSeat(this)"></button>
          </div>
          <div class="text-sm text-slate-500">Occupancy: <span id="table-5-count">5</span>/5 seats</div>
        </div>

        <!-- Global Actions -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
          <h3 class="text-lg font-semibold mb-4">Global Actions</h3>
          <div class="space-y-3">
            <button onclick="clearAllTables()"
              class="w-full px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition font-medium">
              Clear All Tables
            </button>
            <button onclick="occupyAllTables()"
              class="w-full px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition font-medium">
              Fill All Tables
            </button>
            <button onclick="saveCurrentState()"
              class="w-full px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition font-medium">
              Save Current State
            </button>
            <button onclick="resetToDefault()"
              class="w-full px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition font-medium">
              Reset to Default
            </button>
          </div>
          <div class="mt-4 p-3 bg-slate-50 rounded-lg">
            <div class="text-sm text-slate-600">
              <strong>Instructions:</strong><br>
              • Click individual seats to toggle occupancy<br>
              • Use table buttons for quick actions<br>
              • Global actions affect all tables
            </div>
          </div>
        </div>

      </div>

      <!-- Current Student Selection -->
      <div class="mt-8 bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <h3 class="text-lg font-semibold mb-2">Current Student Selection</h3>
        <div class="text-sm text-slate-600">
          <span id="current-selection">No active selection</span>
        </div>
      </div>

      <!-- Legend -->
      <div class="mt-8 bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <h3 class="text-lg font-semibold mb-4">Legend</h3>
        <div class="flex flex-wrap gap-6 text-sm">
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded-full bg-green-300"></div>
            <span>Available Seat</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded-full bg-red-500"></div>
            <span>Occupied Seat</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded-full bg-slate-300"></div>
            <span>Clickable Seat</span>
          </div>
        </div>
      </div>

    </div>
  </main>

  <footer class="text-center text-xs text-slate-500 py-3" data-fade data-blur="true" data-initial-opacity="0"
    data-delay="150">© 2025 UMak Library · Noise Comfort Index</footer>
  <div id="toast" style="position:fixed;right:12px;bottom:48px;pointer-events:none"
    class="px-3 py-2 rounded-md text-sm bg-slate-800 text-white shadow hidden"></div>

  <!-- Confirm Modal -->
  <div id="confirm-modal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-[90%] p-5">
      <h3 class="text-lg font-semibold mb-2">Please confirm</h3>
      <p id="confirm-modal-message" class="text-sm text-slate-600 mb-5"></p>
      <div class="flex justify-end gap-2">
        <button id="confirm-cancel"
          class="px-3 py-1.5 rounded-lg bg-slate-200 hover:bg-slate-300 text-black">Cancel</button>
        <button id="confirm-yes" class="px-3 py-1.5 rounded-lg bg-red-600 hover:bg-red-700 text-white">Yes,
          continue</button>
      </div>
    </div>
  </div>

  <!-- Add User Modal -->
  <div id="add-user-modal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-[90%] p-6">
      <h3 class="text-xl font-semibold mb-4">Add New User</h3>
      <form id="add-user-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Email *</label>
          <input type="email" id="new-user-email" required
            class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            placeholder="user@umak.edu.ph" />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Password *</label>
          <div class="relative">
            <input type="password" id="new-user-password" required
              class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
              placeholder="Minimum 6 characters" />
            <button type="button" id="toggle-password-btn"
              class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600">
              <i data-lucide="eye" class="w-5 h-5"></i>
            </button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">First Name</label>
          <input type="text" id="new-user-firstname"
            class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            placeholder="Juan" />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Last Name</label>
          <input type="text" id="new-user-lastname"
            class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            placeholder="Dela Cruz" />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Student ID</label>
          <input type="text" id="new-user-studentid"
            class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            placeholder="2024-12345" />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Program</label>
          <input type="text" id="new-user-program"
            class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            placeholder="BSCS" />
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" id="add-user-cancel"
            class="px-4 py-2 rounded-lg bg-slate-200 hover:bg-slate-300 text-black transition">Cancel</button>
          <button type="submit" id="add-user-submit"
            class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white transition">Create User</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Supabase SDK -->

  <script>
    // Mobile menu toggle (robust like other frames)
    (function () {
      try {
        var mobileBtn = document.getElementById('mobile-menu-btn');
        var mobileMenu = document.getElementById('mobile-menu');
        var header = document.querySelector('header.site-header');
        if (mobileBtn && mobileMenu && header) {
          mobileBtn.addEventListener('click', function () {
            var isHidden = mobileMenu.classList.contains('hidden');
            if (isHidden) {
              header.classList.add('menu-open');
              mobileMenu.classList.remove('hidden');
              mobileBtn.setAttribute('aria-expanded', 'true');
            } else {
              header.classList.remove('menu-open');
              mobileMenu.classList.add('hidden');
              mobileBtn.setAttribute('aria-expanded', 'false');
            }
          });
        }
      } catch (_) { }
    })();

    var TABLE_IDS = ['table-1', 'table-2', 'table-3', 'table-4', 'table-5'];
    var SEATS_PER_TABLE = 5;
    var occupancyState = {};
    TABLE_IDS.forEach(function (id) { occupancyState[id] = { seats: {} }; });


    // Admin access control
    async function checkAdminAccess() {
      try {
        // Check if user is authenticated
        const userResult = await window.supabaseAuth.getCurrentUser();

        if (userResult.error || !userResult.data || !userResult.data.user) {
          console.log('User not authenticated, redirecting to login');
          window.location.href = 'index.html';
          return false;
        }

        const user = userResult.data.user;

        // Check for legacy admin credentials first
        const email = user.email ? user.email.toLowerCase() : '';
        if (email === 'adminlibrarian@umak.edu.ph' || email === 'admin@umak.edu.ph') {
          console.log('Legacy admin user detected, granting access');
          return true;
        }

        // Check if user is admin in database
        const adminResult = await window.supabaseDB.isAdmin(user.id);

        if (adminResult.error) {
          console.error('Error checking admin status:', adminResult.error);
          // If there's an error checking admin status, allow access for now
          console.log('Admin check failed, allowing access temporarily');
          return true;
        }

        if (!adminResult.data) {
          console.log('User is not an admin, redirecting to student dashboard');
          window.location.href = 'Frame_4.html'; // Redirect to student dashboard
          return false;
        }

        return true;
      } catch (error) {
        console.error('Error in admin access check:', error);
        showAccessDenied();
        return false;
      }
    }

    // Show access denied message
    function showAccessDenied() {
      document.body.innerHTML = `
        <div class="min-h-screen bg-slate-50 flex items-center justify-center">
          <div class="bg-white rounded-xl shadow-lg p-8 max-w-md mx-4 text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
              </svg>
            </div>
            <h1 class="text-2xl font-bold text-slate-900 mb-2">Access Denied</h1>
            <p class="text-slate-600 mb-6">You don't have permission to access the admin panel. Only administrators can view this page.</p>
            <div>
              <a href="Frame_11.html" class="block w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                Go to Student Dashboard
              </a>
            </div>
          </div>
        </div>
      `;
    }

    // Initialize Supabase
    var supabaseInitialized = false;
    try {
      if (initSupabase()) {
        supabaseInitialized = true;
        console.log('Supabase initialized successfully');
      } else {
        console.error('Supabase initialization failed');
      }
    } catch (e) {
      console.error('Supabase init error:', e);
    }

    // Firebase paths removed - now using Supabase

    function toggleSeat(button) {
      var tableId = button.getAttribute('data-table');
      var seatNum = parseInt(button.getAttribute('data-seat'));
      var willOccupy = button.classList.contains('bg-green-300');

      // Optimistic UI update
      if (willOccupy) { button.classList.remove('bg-green-300'); button.classList.add('bg-red-500'); }
      else { button.classList.remove('bg-red-500'); button.classList.add('bg-green-300'); }
      try {
        var seats = occupancyState[tableId] && occupancyState[tableId].seats || {};
        seats[seatNum] = !!willOccupy;
        occupancyState[tableId].seats = seats;
        updateTableCount(tableId);
        updateGlobalStats();
      } catch (_) { }

      // Persist to Supabase
      if (supabaseInitialized) {
        window.supabaseDB.updateSeatOccupancy(tableId, seatNum, !willOccupy, null).catch(function (err) {
          console.error('toggleSeat failed', err);
        });
      }
    }

    function clearAllSeats(tableId) {
      if (!supabaseInitialized) return;
      for (var i = 1; i <= SEATS_PER_TABLE; i++) {
        window.supabaseDB.updateSeatOccupancy(tableId, i, false, null).catch(function (err) {
          console.error('clearAllSeats failed', err);
        });
      }
    }

    function occupyAllSeats(tableId) {
      if (!supabaseInitialized) return;
      for (var i = 1; i <= SEATS_PER_TABLE; i++) {
        window.supabaseDB.updateSeatOccupancy(tableId, i, true, null).catch(function (err) {
          console.error('occupyAllSeats failed', err);
        });
      }
    }

    function clearAllTables() { TABLE_IDS.forEach(function (t) { clearAllSeats(t); }); }

    function occupyAllTables() { TABLE_IDS.forEach(function (t) { occupyAllSeats(t); }); }

    function resetToDefault() { clearAllTables(); }

    function updateTableCount(tableId) {
      var seats = occupancyState[tableId] && occupancyState[tableId].seats || {};
      var occ = Object.keys(seats).filter(function (k) { return !!seats[k]; }).length;
      var el = document.getElementById(tableId + '-count');
      if (el) el.textContent = occ;
    }

    function updateGlobalStats() {
      var totalSeats = TABLE_IDS.length * SEATS_PER_TABLE;
      var occupiedSeats = 0;
      TABLE_IDS.forEach(function (t) { var seats = occupancyState[t].seats || {}; occupiedSeats += Object.keys(seats).filter(function (k) { return !!seats[k]; }).length; });
      var availableSeats = totalSeats - occupiedSeats;
      var occupancyRate = totalSeats ? Math.round((occupiedSeats / totalSeats) * 100) : 0;
      var elTotalSeats = document.getElementById('total-seats');
      if (elTotalSeats) elTotalSeats.textContent = totalSeats;
      var elAvailableSeats = document.getElementById('available-seats');
      if (elAvailableSeats) elAvailableSeats.textContent = availableSeats;
      var elOccupiedSeats = document.getElementById('occupied-seats');
      if (elOccupiedSeats) elOccupiedSeats.textContent = occupiedSeats;
      var elOccupancyRate = document.getElementById('occupancy-rate');
      if (elOccupancyRate) elOccupancyRate.textContent = occupancyRate + '%';
    }

    function ensureSeatSeed(tableId, remote) {
      var seats = remote && remote.seats;
      if (!seats || Object.keys(seats).length === 0) {
        // Initialize empty seats in Supabase
        if (supabaseInitialized) {
          for (var i = 1; i <= SEATS_PER_TABLE; i++) {
            window.supabaseDB.updateSeatOccupancy(tableId, i, false, null).catch(function (err) {
              console.error('Failed to initialize seat:', err);
            });
          }
        }
      }
    }

    // Save a timestamped snapshot of the current state for records
    function saveCurrentState() {
      if (!supabaseInitialized) {
        try { alert('System not initialized. Please try again.'); } catch (_) { }
        return;
      }

      var totals = { totalSeats: 0, occupiedSeats: 0 };
      TABLE_IDS.forEach(function (tableId) {
        var seats = occupancyState[tableId] && occupancyState[tableId].seats || {};
        var occupied = Object.keys(seats).filter(function (k) { return !!seats[k]; }).length;
        totals.totalSeats += SEATS_PER_TABLE;
        totals.occupiedSeats += occupied;
      });

      var snapshotPayload = {
        created_at: new Date().toISOString(),
        occupancy_data: Object.keys(occupancyState).reduce(function (acc, tableId) {
          acc[tableId] = occupancyState[tableId].seats || {};
          return acc;
        }, {}),
        totals: totals
      };

      // Save to Supabase (you may need to create a snapshots table)
      window.supabaseDB.addActivityLog({
        userId: null, // System action
        userName: 'System',
        type: 'snapshot_save',
        title: 'Occupancy Snapshot',
        description: 'Saved current occupancy state',
        severity: 'info',
        details: snapshotPayload
      }).then(function (result) {
        if (result.error) throw result.error;
        try { alert('Snapshot saved successfully'); } catch (_) { }
      }).catch(function (err) {
        console.error('Failed to save snapshot', err);
        try { alert('Failed to save: ' + (err.message || 'Unknown error')); } catch (_) { }
      });
    }

    // Ensure inline onclick handlers can find these functions
    window.toggleSeat = toggleSeat;
    window.clearAllSeats = clearAllSeats;
    window.occupyAllSeats = occupyAllSeats;
    window.clearAllTables = clearAllTables;
    window.occupyAllTables = occupyAllTables;
    window.resetToDefault = resetToDefault;
    window.saveCurrentState = saveCurrentState;

    // Subscribe to Supabase for per-seat updates
    if (supabaseInitialized) {
      // Load initial data
      window.supabaseDB.getOccupancyData().then(function (result) {
        if (result.data) {
          var data = {};
          result.data.forEach(function (record) {
            if (!data[record.table_id]) data[record.table_id] = { seats: {} };
            data[record.table_id].seats[record.seat_number] = record.is_occupied;
          });

          TABLE_IDS.forEach(function (t) { ensureSeatSeed(t, data[t]); });
          TABLE_IDS.forEach(function (tableId) {
            var seatsObj = (data[tableId] && data[tableId].seats) || {};
            occupancyState[tableId].seats = seatsObj;
            var btns = document.querySelectorAll(`[data-table="${tableId}"]`);
            btns.forEach(function (btn) {
              var seatNum = parseInt(btn.getAttribute('data-seat'));
              var occ = !!seatsObj[seatNum];
              if (occ) { btn.classList.remove('bg-green-300'); btn.classList.add('bg-red-500'); }
              else { btn.classList.remove('bg-red-500'); btn.classList.add('bg-green-300'); }
            });
            updateTableCount(tableId);
          });
          updateGlobalStats();
        }
      });

      // Subscribe to real-time changes
      window.supabaseDB.subscribeToOccupancy(function (payload) {
        var record = payload.new || payload.old;
        if (!record) return;

        var tableId = record.table_id;
        var seatNum = record.seat_number;
        var isOccupied = record.is_occupied;

        // Update local state
        if (!occupancyState[tableId]) occupancyState[tableId] = { seats: {} };
        occupancyState[tableId].seats[seatNum] = isOccupied;

        // Update UI
        var btn = document.querySelector(`[data-table="${tableId}"][data-seat="${seatNum}"]`);
        if (btn) {
          if (isOccupied) { btn.classList.remove('bg-green-300'); btn.classList.add('bg-red-500'); }
          else { btn.classList.remove('bg-red-500'); btn.classList.add('bg-green-300'); }
        }

        updateTableCount(tableId);
        updateGlobalStats();
      });
    }

    // Show current student selection (placeholder for now)
    var el = document.getElementById('current-selection');
    if (el) {
      el.textContent = 'No active selection';
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async function () {
      // Show loading state
      showLoadingState();

      // Wait for Supabase to initialize if needed
      if (!supabaseInitialized) {
        await initSupabaseWithRetry();
        if (initSupabase()) {
          supabaseInitialized = true;
          console.log('Supabase initialized successfully');
        }
      }

      // Check admin access
      const hasAccess = await checkAdminAccess();
      if (hasAccess) {
        hideLoadingState();
        initUsersPage();
      }
    });

    // Show loading state
    function showLoadingState() {
      const loadingOverlay = document.createElement('div');
      loadingOverlay.id = 'loading-overlay';
      loadingOverlay.className = 'fixed inset-0 bg-slate-50 flex items-center justify-center z-50';
      loadingOverlay.innerHTML = `
        <div class="text-center">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
          <p class="text-slate-600">Verifying admin access...</p>
        </div>
      `;
      document.body.appendChild(loadingOverlay);
    }

    // Hide loading state
    function hideLoadingState() {
      const loadingOverlay = document.getElementById('loading-overlay');
      if (loadingOverlay) {
        loadingOverlay.remove();
      }
    }

    // Simple in-page confirm modal
    function openConfirm(message, onYes) {
      var modal = document.getElementById('confirm-modal');
      var msg = document.getElementById('confirm-modal-message');
      var btnYes = document.getElementById('confirm-yes');
      var btnCancel = document.getElementById('confirm-cancel');
      if (!modal || !msg || !btnYes || !btnCancel) { try { if (confirm(message)) onYes && onYes(); } catch (_) { } return; }
      msg.textContent = message || 'Are you sure?';
      modal.classList.remove('hidden');
      var cleanup = function () {
        btnYes.onclick = null;
        btnCancel.onclick = null;
        modal.classList.add('hidden');
      };
      btnCancel.onclick = cleanup;
      btnYes.onclick = function () { try { onYes && onYes(); } finally { cleanup(); } };
    }

    // Add User Modal functions
    function openAddUserModal() {
      var modal = document.getElementById('add-user-modal');
      if (!modal) return;

      // Reset form
      var form = document.getElementById('add-user-form');
      if (form) form.reset();

      // Show modal
      modal.classList.remove('hidden');

      // Wire up cancel button
      var cancelBtn = document.getElementById('add-user-cancel');
      if (cancelBtn) {
        cancelBtn.onclick = function () {
          modal.classList.add('hidden');
        };
      }

      // Wire up form submit
      if (form) {
        form.onsubmit = function (e) {
          e.preventDefault();
          handleAddUser();
        };
      }

      // Wire up password toggle
      var toggleBtn = document.getElementById('toggle-password-btn');
      var passwordInput = document.getElementById('new-user-password');
      if (toggleBtn && passwordInput) {
        toggleBtn.onclick = function () {
          var type = passwordInput.type === 'password' ? 'text' : 'password';
          passwordInput.type = type;
          var icon = toggleBtn.querySelector('i');
          if (icon) {
            icon.setAttribute('data-lucide', type === 'password' ? 'eye' : 'eye-off');
            if (typeof lucide !== 'undefined') {
              lucide.createIcons();
            }
          }
        };
      }
    }

    async function handleAddUser() {
      var email = document.getElementById('new-user-email').value.trim();
      var password = document.getElementById('new-user-password').value;
      var firstName = document.getElementById('new-user-firstname').value.trim();
      var lastName = document.getElementById('new-user-lastname').value.trim();
      var studentId = document.getElementById('new-user-studentid').value.trim();
      var program = document.getElementById('new-user-program').value.trim();

      // Validation
      if (!email || !password) {
        showToast('Email and password are required', false);
        return;
      }

      if (password.length < 6) {
        showToast('Password must be at least 6 characters', false);
        return;
      }

      // Disable submit button
      var submitBtn = document.getElementById('add-user-submit');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating...';
      }

      try {
        // Create auth user with autoConfirm
        var signUpResult = await window.supabaseAuth.signUp(email, password, {
          email_confirm: true,
          first_name: firstName,
          last_name: lastName,
          student_id: studentId,
          program: program
        });

        if (signUpResult.error) {
          throw signUpResult.error;
        }

        var userId = signUpResult.data.user.id;

        // Create user profile in database
        var profileData = {
          id: userId,
          email: email,
          first_name: firstName || null,
          last_name: lastName || null,
          student_id: studentId || null,
          program: program || null,
          is_admin: false
        };

        var insertResult = await window.supabaseDB.insertUser(userId, profileData);

        if (insertResult.error && insertResult.error.code !== '23505') {
          console.error('Failed to create profile:', insertResult.error);
          throw new Error('User created but profile creation failed');
        }

        // Close modal and show success
        var modal = document.getElementById('add-user-modal');
        if (modal) modal.classList.add('hidden');

        showToast('✓ User created successfully!', true);

        // Reload users list
        setTimeout(function () {
          loadUsers();
        }, 500);

      } catch (error) {
        console.error('Add user error:', error);
        showToast('✗ Failed to create user: ' + (error.message || 'Unknown error'), false);
      } finally {
        // Re-enable submit button
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Create User';
        }
      }
    }

    function initUsersPage() {
      var container = document.querySelector('main .max-w-7xl');
      if (!container) return;
      container.innerHTML = '\n      <div class="mb-8">\n        <h1 class="text-3xl font-bold mb-2">Users</h1>\n        <p class="text-slate-600">Search users, view details, and manage admin access</p>\n      </div>\n      <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200 mb-6">\n        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">\n          <div class="flex items-center gap-2">\n            <input id="userSearch" placeholder="Search by email, name, student ID" class="px-3 py-2 rounded-lg border border-slate-300 w-72" />\n            <button id="searchBtn" class="px-3 py-2 rounded-lg btn-outline">Search</button>\n          </div>\n          <button id="addUserBtn" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-medium transition">+ Add User</button>\n          <div class="text-sm text-slate-500" id="usersStatus"></div>\n        </div>\n      </div>\n      <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">\n        <div class="overflow-auto">\n          <table class="w-full text-sm">\n            <thead>\n              <tr class="text-left text-slate-500 border-b">\n                <th class="py-2 pr-3">Name</th>\n                <th class="py-2 pr-3">Email</th>\n                <th class="py-2 pr-3">Student ID</th>\n                <th class="py-2 pr-3">Program</th>\n                <th class="py-2 pr-3">Created</th>\n                <th class="py-2 pr-3">Admin</th>\n                <th class="py-2 pr-3">Action</th>\n              </tr>\n            </thead>\n            <tbody id="usersRows">\n              <tr><td colspan="7" class="py-6 text-center text-slate-400">Loading...</td></tr>\n            </tbody>\n          </table>\n        </div>\n      </div>\n      ';
      // Wire events
      var searchBtn = document.getElementById('searchBtn');
      if (searchBtn) searchBtn.addEventListener('click', loadUsers);

      // Add User button
      var addUserBtn = document.getElementById('addUserBtn');
      if (addUserBtn) addUserBtn.addEventListener('click', openAddUserModal);

      // Add force refresh functionality
      window.forceRefreshUsers = function () {
        console.log('Force refreshing users...');
        // Clear any cached data
        if (window.supabaseDB && window.supabaseDB.clearCache) {
          window.supabaseDB.clearCache();
        }
        // Force reload
        loadUsers();
      };

      // Nuclear refresh - clear all caches and reload
      window.nuclearRefresh = function () {
        console.log('Nuclear refresh - clearing all caches...');
        // Clear localStorage
        localStorage.clear();
        sessionStorage.clear();
        // Force page reload
        window.location.reload(true);
      };
      var rows = document.getElementById('usersRows');
      if (rows) rows.addEventListener('click', function (e) {
        var t = e.target; if (!t || !t.getAttribute) return; var id = t.getAttribute('data-id');
        var action = t.getAttribute('data-action');
        if (action === 'set-admin') {
          openConfirm('Are you sure you want to grant Admin access to this user?', function () {
            t.disabled = true;
            // Use the existing authenticated Supabase client from supabase.js
            window.supabaseDB.adminSetUserAdmin(id, true).then(function (result) {
              if (result && result.success) {
                showToast(result.message || 'Admin access granted', true);
                loadUsers();
              } else {
                showToast(result.error || 'Failed to grant admin access', false);
              }
            }).catch(function (err) {
              showToast('Error: ' + (err.message || 'Unknown error'), false);
            }).finally(function () { t.disabled = false; });
          });
        }
        if (action === 'unset-admin') {
          // Only protect admin@umak.edu.ph (primary admin), allow adminlibrarian@umak.edu.ph to be managed
          var row = t.closest('tr');
          var emailCell = row ? row.cells[1] : null;
          var email = emailCell ? emailCell.textContent.trim() : '';

          if (email && email.toLowerCase() === 'admin@umak.edu.ph') {
            showToast('Cannot remove admin status from primary admin account', false);
            return;
          }

          openConfirm('Are you sure you want to remove Admin access from this user?', function () {
            t.disabled = true;
            // Use the existing authenticated Supabase client from supabase.js
            window.supabaseDB.adminSetUserAdmin(id, false).then(function (result) {
              if (result && result.success) {
                showToast(result.message || 'Admin access removed', true);
                loadUsers();
              } else {
                showToast(result.error || 'Failed to remove admin access', false);
              }
            }).catch(function (err) {
              showToast('Error: ' + (err.message || 'Unknown error'), false);
            }).finally(function () { t.disabled = false; });
          });
        }
        if (action === 'remove-user') {
          // Only protect admin@umak.edu.ph (primary admin), allow adminlibrarian@umak.edu.ph to be managed
          var row = t.closest('tr');
          var emailCell = row ? row.cells[1] : null;
          var email = emailCell ? emailCell.textContent.trim() : '';

          if (email && email.toLowerCase() === 'admin@umak.edu.ph') {
            showToast('Cannot delete primary admin account', false);
            return;
          }

          openConfirm('PERMANENT DELETION WARNING: This will COMPLETELY remove this user from the Database AND Authentication System. The user will NOT be able to log in again. This action CANNOT be undone. Are you absolutely sure?', function () {
            t.disabled = true;
            showToast('Deleting user from database and auth...', true);

            window.supabaseDB.adminPurgeUser(id).then(function (res) {
              console.log('Delete response:', res);

              if (res && !res.error && res.data) {
                if (res.data.success) {
                  showToast('User deleted from entire system (DB + Auth)', true);
                } else if (res.data.warning) {
                  showToast(res.data.warning, true);
                } else if (res.data.error) {
                  showToast(res.data.error, false);
                  t.disabled = false;
                  return;
                } else {
                  showToast('User deleted successfully', true);
                }
              } else if (res && res.error) {
                var msg = res.error.message || res.error.details || 'Failed to delete user';
                showToast(msg, false);
                t.disabled = false;
                return;
              } else {
                showToast('Unexpected error during deletion', false);
                t.disabled = false;
                return;
              }

              // Reload users list after a short delay to ensure deletion is complete
              setTimeout(function () {
                loadUsers();
                t.disabled = false;
              }, 800);
            }).catch(function (err) {
              console.error('Delete error:', err);
              var msg = (err && (err.message || err.details)) ? (err.message || err.details) : 'Failed to delete user';
              showToast(msg, false);
              t.disabled = false;
            });
          });
        }
      });
      loadUsers();
    }

    function renderUsers(rows) {
      var body = document.getElementById('usersRows');
      if (!body) return;
      if (!rows || rows.length === 0) {
        body.innerHTML = '<tr><td colspan="7" class="py-6 text-center text-slate-400">No users found</td></tr>';
        return;
      }
      body.innerHTML = '';
      rows.forEach(function (u) {
        var tr = document.createElement('tr');
        tr.className = 'border-b last:border-0';
        var name = ((u.first_name || '') + ' ' + (u.last_name || '')).trim();

        // Check if user is admin (only use database flag, ignore email-based for adminlibrarian)
        var isAdmin = u.is_admin === true;

        // Special case: only admin@umak.edu.ph gets email-based admin status
        if (u.email && u.email.toLowerCase() === 'admin@umak.edu.ph') {
          isAdmin = true;
        }

        var actionHtml = '';
        if (isAdmin) {
          // Only protect admin@umak.edu.ph (primary admin), allow adminlibrarian@umak.edu.ph to be managed
          if (u.email && u.email.toLowerCase() === 'admin@umak.edu.ph') {
            actionHtml = '<span class="px-3 py-1 text-xs rounded bg-gray-200 text-gray-600">Primary Admin</span>';
          } else {
            actionHtml = '<button class="px-3 py-1 text-xs rounded bg-slate-200 hover:bg-slate-300 text-black" data-action="unset-admin" data-id="' + u.id + '">Remove Admin</button>';
          }
        } else {
          actionHtml = '<div class="flex gap-2">\n            <button class="px-3 py-1 text-xs rounded bg-indigo-600 hover:bg-indigo-700 text-white" data-action="set-admin" data-id="' + u.id + '">Make Admin</button>\n            <button class="px-3 py-1 text-xs rounded bg-red-600 hover:bg-red-700 text-white" data-action="remove-user" data-id="' + u.id + '">Delete User</button>\n          </div>';
        }
        tr.innerHTML = '\n          <td class="py-2 pr-3">' + (name || '—') + '</td>\n          <td class="py-2 pr-3">' + (u.email || '—') + '</td>\n          <td class="py-2 pr-3">' + (u.student_id || '—') + '</td>\n          <td class="py-2 pr-3">' + (u.program || '—') + '</td>\n          <td class="py-2 pr-3">' + (u.created_at ? new Date(u.created_at).toLocaleDateString() : '—') + '</td>\n          <td class="py-2 pr-3">' + (isAdmin ? '<span class="px-2 py-0.5 text-xs rounded bg-indigo-100 text-indigo-800">Admin</span>' : '') + '</td>\n          <td class="py-2 pr-3">' + actionHtml + '</td>';
        body.appendChild(tr);
      });
    }

    function loadUsers() {
      var q = (document.getElementById('userSearch') || {}).value || '';
      var status = document.getElementById('usersStatus');
      if (status) status.textContent = 'Loading...';

      // Create fresh Supabase client to bypass any caching
      var supabaseClient = window.supabase.createClient(
        'https://lvjfjyboqlcofzqrwqiy.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2amZqeWJvcWxjb2Z6cXJ3cWl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NzU4MTEsImV4cCI6MjA3MzM1MTgxMX0.XHLeP0xxmSWLC8MpqCpHWOVL3GK2TTJrKOBdbmME2OE'
      );

      // Query users table directly with admin status
      var query = supabaseClient
        .from('users')
        .select(`
          id,
          email,
          first_name,
          last_name,
          student_id,
          program,
          is_admin,
          created_at
        `)
        .order('created_at', { ascending: false })
        .limit(200);

      // Add search filter if provided
      if (q && q.trim()) {
        query = query.or(`email.ilike.%${q}%,first_name.ilike.%${q}%,last_name.ilike.%${q}%,student_id.ilike.%${q}%`);
      }

      query.then(function (res) {
        if (status) status.textContent = '';
        if (res.error) {
          console.error('Direct query error:', res.error);
          status.textContent = 'Failed to load users';
          return;
        }

        // Process the data to match expected format
        var processedData = (res.data || []).map(function (user) {
          return {
            id: user.id,
            email: user.email,
            first_name: user.first_name,
            last_name: user.last_name,
            student_id: user.student_id,
            program: user.program,
            is_admin: user.is_admin,
            created_at: user.created_at
          };
        });

        console.log('Loaded users directly from database:', processedData);

        // Log admin status for each user
        processedData.forEach(function (user, index) {
          console.log(`User ${index}: ${user.email} - is_admin: ${user.is_admin}`);
        });

        renderUsers(processedData);
      }).catch(function (err) {
        if (status) status.textContent = 'Failed to load users';
        console.error('Direct query error:', err);
      });
    }

    // Logout helper
    function logout() {
      try {
        if (supabaseInitialized) {
          window.supabaseAuth.signOut().then(function () {
            window.location.href = 'index.html';
          }).catch(function (err) {
            try { alert(err.message); } catch (_) { }
          });
        } else {
          window.location.href = 'index.html';
        }
      } catch (_) {
        window.location.href = 'index.html';
      }
    }
    window.logout = logout;

    // Simple toast
    function showToast(message, ok) {
      var el = document.getElementById('toast');
      if (!el) return;
      el.textContent = message || '';
      el.classList.remove('hidden');
      el.style.backgroundColor = ok ? '#065f46' : '#7f1d1d';
      el.style.color = 'white';
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(function () { el.classList.add('hidden'); }, 2500);
    }
  </script>
  <script>
    // Unified fade-on-scroll transitions (same timing/easing as Frame 18)
    (function () {
      var fadeElements = Array.from(document.querySelectorAll('[data-fade]'));
      if (fadeElements.length === 0) return;

      fadeElements.forEach(function (el) {
        var initialOpacity = parseFloat(el.getAttribute('data-initial-opacity') || '0');
        var duration = parseInt(el.getAttribute('data-duration') || '1000', 10);
        var easing = el.getAttribute('data-easing') || 'ease-out';
        var blurPxAttr = el.getAttribute('data-blur-px');
        var blurPx = parseInt(blurPxAttr || '14', 10);
        el.style.opacity = String(initialOpacity);
        el.style.setProperty('--fade-init', blurPx + 'px');
        el.style.setProperty('--fade-transition', 'opacity ' + duration + 'ms ' + easing + ', filter ' + duration + 'ms ' + easing);
      });

      var observer = new IntersectionObserver(function (entries) {
        entries.forEach(function (entry) {
          if (entry.isIntersecting) {
            var el = entry.target;
            var delay = parseInt(el.getAttribute('data-delay') || '0', 10);
            var blurAttr = el.getAttribute('data-blur');
            var blurEnabled = (blurAttr !== 'false');
            observer.unobserve(el);
            setTimeout(function () {
              el.style.opacity = '1';
              if (blurEnabled) {
                el.style.setProperty('--fade-init', '0px');
              }
            }, delay);
          }
        });
      }, { threshold: 0.1 });

      fadeElements.forEach(function (el) { observer.observe(el); });
    })();

    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  </script>
</body>

</html>