<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="UMak_Logo_Registered.png" />
  <title>University of Makati Library - Report Noise</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="theme.css" />
  <script defer src="theme.js"></script>
  <!-- UI/UX refinements (non-breaking):
       - improved padding and spacing consistency across sections
       - fixed low-contrast text by mapping to theme tokens
       - unified card/option hover & selected states with brand color
       - replaced hard dividers with spacing for cleaner separation
       - responsive tweaks for mobile readability and hierarchy -->
  <style>
    /* Global fade-in like Frame 15 */
    [data-fade] {
      opacity: 0;
      --fade-init: 14px;
      --fade-filter: none;
      filter: var(--fade-filter) !important;
      transition: var(--fade-transition, opacity 1000ms ease-out, filter 1000ms ease-out) !important;
      will-change: opacity, filter;
    }

    [data-fade]:not([data-blur="false"]) {
      --fade-filter: blur(var(--fade-init));
    }

    /* Library-themed cursor follower - subtle and calm */
    .cursor-follower {
      position: fixed;
      top: 0;
      left: 0;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      pointer-events: none;
      transform: translate(-50%, -50%) scale(1);
      transition: opacity 200ms ease-out;
      will-change: transform, opacity;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      background: radial-gradient(circle, rgba(0, 0, 0, 0.15) 0%, rgba(0, 0, 0, 0.05) 50%, rgba(0, 0, 0, 0.02) 100%);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      opacity: 0;
      z-index: 1;
      /* Behind text and UI elements */
    }

    /* Dark mode - keep white cursor follower */
    @media (prefers-color-scheme: dark) {
      .cursor-follower {
        background: radial-gradient(circle, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 50%, rgba(255, 255, 255, 0.02) 100%);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }
    }

    /* Manual dark mode class support */
    .dark .cursor-follower {
      background: radial-gradient(circle, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 50%, rgba(255, 255, 255, 0.02) 100%);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    /* Hide on small screens and touch devices */
    @media (max-width: 640px) {
      .cursor-follower {
        display: none;
      }
    }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce) {
      .cursor-follower {
        display: none !important;
      }
    }

    /* Confirmation Modal Styles */
    .confirmation-modal-overlay {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 1rem;
    }

    .confirmation-modal {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 100%;
      overflow: hidden;
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .confirmation-modal-header {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      padding: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .confirmation-modal-header svg {
      width: 32px;
      height: 32px;
      flex-shrink: 0;
    }

    .confirmation-modal-header h3 {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0;
    }

    .confirmation-modal-body {
      padding: 1.5rem;
      color: #334155;
      line-height: 1.6;
    }

    .confirmation-modal-body p {
      margin: 0 0 1rem 0;
    }

    .confirmation-modal-body .warning-text {
      background: #fef2f2;
      border-left: 4px solid #ef4444;
      padding: 1rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      color: #991b1b;
      margin-top: 1rem;
    }

    .confirmation-modal-footer {
      padding: 1rem 1.5rem;
      background: #f8fafc;
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .confirmation-modal-footer button {
      padding: 0.625rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 500;
      transition: all 0.2s ease;
      cursor: pointer;
      border: none;
      font-size: 0.875rem;
    }

    .confirmation-modal-footer .btn-cancel {
      background: white;
      color: #64748b;
      border: 1px solid #cbd5e1;
    }

    .confirmation-modal-footer .btn-cancel:hover {
      background: #f1f5f9;
      border-color: #94a3b8;
    }

    .confirmation-modal-footer .btn-confirm {
      background: #ef4444;
      color: white;
    }

    .confirmation-modal-footer .btn-confirm:hover {
      background: #dc2626;
    }

    @media (max-width: 640px) {
      .confirmation-modal-header h3 {
        font-size: 1.125rem;
      }

      .confirmation-modal-footer {
        flex-direction: column-reverse;
      }

      .confirmation-modal-footer button {
        width: 100%;
      }
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">
  <div id="cursor-follower" class="cursor-follower" aria-hidden="true"></div>
  <header class="site-header" data-fade data-blur="true" data-initial-opacity="0" data-duration="1000">
    <div class="max-w-6xl mx-auto flex items-center gap-4 py-3 px-6">
      <img src="UMak_Logo_Registered.png" alt="University of Makati Logo" class="h-12 w-auto" data-fade data-blur="true"
        data-delay="50" data-initial-opacity="0" />
      <a href="Frame_11.html" class="brand-title text-xl md:text-2xl font-semibold mr-auto">University of Makati
        Library</a>
      <button id="mobile-menu-btn"
        class="md:hidden inline-flex items-center justify-center rounded-md p-2 text-slate-200 hover:text-white hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white"
        aria-label="Open main menu" aria-expanded="false">
        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
          aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
      <nav class="hidden md:flex items-center gap-4 text-sm">
        <a href="Frame_11.html" class="nav-link">Profile</a>
        <a href="Frame_8.html" class="nav-link">Map</a>
        <a href="Frame_16.html" class="nav-link active">Report</a>
      </nav>
      <button id="logoutBtn"
        class="hidden md:inline px-3 py-1 rounded-lg bg-slate-200 hover:bg-slate-300 transition">Logout</button>
    </div>
    <nav id="mobile-menu" class="md:hidden hidden px-6 pb-3">
      <a href="Frame_11.html" class="block py-2 text-sm nav-link">Profile</a>
      <a href="Frame_8.html" class="block py-2 text-sm nav-link">Map</a>
      <a href="Frame_16.html" class="block py-2 text-sm nav-link active">Report</a>
      <button id="logoutBtnMobile"
        class="mt-2 w-full px-3 py-2 rounded-lg bg-slate-200 hover:bg-slate-300 text-black transition text-left">Logout</button>
    </nav>
  </header>

  <main class="flex-1 flex items-start justify-center py-12 px-6" data-fade data-blur="true" data-initial-opacity="0"
    data-duration="1000" data-delay="50">
    <div class="w-full max-w-4xl">

      <!-- Report Header -->
      <section class="bg-white rounded-2xl shadow p-4 sm:p-6 mb-6" data-fade data-blur="true" data-duration="900"
        data-easing="ease-out" data-delay="0" data-initial-opacity="0">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center order-1 ml-[5px]">
            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z">
              </path>
            </svg>
          </div>
          <div class="flex-1 order-2" data-fade data-blur="true" data-delay="50" data-initial-opacity="0">
            <h1 class="text-2xl font-semibold mb-2">Report Noise Disturbance</h1>
            <p class="text-slate-600">Help maintain a quiet study environment by reporting noise issues. Your reports
              help librarians take appropriate action.</p>
            <p class="text-xs text-slate-500 mt-1">Note: Once a librarian resolves your complaint, it will be removed
              from your recent reports list.</p>
          </div>
        </div>
      </section>

      <!-- Noise Report Form -->
      <section class="bg-white rounded-2xl shadow p-4 sm:p-6 mb-6" data-fade data-blur="true" data-duration="950"
        data-easing="ease-out" data-delay="75" data-initial-opacity="0">
        <form id="noiseReportForm" class="space-y-6">
          <!-- Noise Level -->
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-3">Noise Level</label>
            <div class="grid grid-cols-3 md:grid-cols-5 gap-2 sm:gap-3">
              <label class="relative cursor-pointer">
                <input type="radio" name="noiseLevel" value="1" class="sr-only" />
                <div
                  class="noise-level-option p-3 rounded-lg border-2 border-slate-200 text-center hover:border-green-300 transition">
                  <div class="text-lg mb-1">🔇</div>
                  <div class="text-xs font-medium">Quiet</div>
                  <div class="text-xs text-slate-500">Level 1</div>
                </div>
              </label>
              <label class="relative cursor-pointer">
                <input type="radio" name="noiseLevel" value="2" class="sr-only" />
                <div
                  class="noise-level-option p-3 rounded-lg border-2 border-slate-200 text-center hover:border-green-300 transition">
                  <div class="text-lg mb-1">🔉</div>
                  <div class="text-xs font-medium">Low</div>
                  <div class="text-xs text-slate-500">Level 2</div>
                </div>
              </label>
              <label class="relative cursor-pointer">
                <input type="radio" name="noiseLevel" value="3" class="sr-only" />
                <div
                  class="noise-level-option p-3 rounded-lg border-2 border-slate-200 text-center hover:border-yellow-300 transition">
                  <div class="text-lg mb-1">🔊</div>
                  <div class="text-xs font-medium">Moderate</div>
                  <div class="text-xs text-slate-500">Level 3</div>
                </div>
              </label>
              <label class="relative cursor-pointer">
                <input type="radio" name="noiseLevel" value="4" class="sr-only" />
                <div
                  class="noise-level-option p-3 rounded-lg border-2 border-slate-200 text-center hover:border-orange-300 transition">
                  <div class="text-lg mb-1">📢</div>
                  <div class="text-xs font-medium">Loud</div>
                  <div class="text-xs text-slate-500">Level 4</div>
                </div>
              </label>
              <label class="relative cursor-pointer">
                <input type="radio" name="noiseLevel" value="5" class="sr-only" />
                <div
                  class="noise-level-option p-3 rounded-lg border-2 border-slate-200 text-center hover:border-red-300 transition">
                  <div class="text-lg mb-1">🚨</div>
                  <div class="text-xs font-medium">Very Loud</div>
                  <div class="text-xs text-slate-500">Level 5</div>
                </div>
              </label>
            </div>
          </div>

          <!-- Location -->
          <div>
            <label for="location" class="block text-sm font-medium text-slate-700 mb-2">Location</label>
            <select id="location" name="location"
              class="w-full rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none p-3">
              <option value="">Select location...</option>
              <option value="table-1">Table 1 Area</option>
              <option value="table-2">Table 2 Area</option>
              <option value="table-3">Table 3 Area</option>
              <option value="table-4">Table 4 Area</option>
              <option value="table-5">Table 5 Area</option>
              <option value="table-6">Table 6 Area</option>
              <option value="table-7">Table 7 Area</option>
              <option value="table-8">Table 8 Area</option>
              <option value="table-9">Table 9 Area</option>
              <option value="table-10">Table 10 Area</option>
              <option value="table-11">Table 11 Area</option>
              <option value="table-12">Table 12 Area</option>
              <option value="table-13">Table 13 Area</option>
              <option value="table-14">Table 14 Area</option>
              <option value="table-15">Table 15 Area</option>
              <option value="table-16">Table 16 Area</option>
              <option value="table-17">Table 17 Area</option>
              <option value="table-18">Table 18 Area</option>
              <option value="entrance">Entrance Area</option>
              <option value="group-study">Group Study Area</option>
              <option value="other">Other</option>
            </select>
          </div>

          <!-- Noise Type -->
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-3">Type of Noise</label>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 sm:gap-3">
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" name="noiseType" value="talking"
                  class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
                <span class="text-sm">Talking</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" name="noiseType" value="music"
                  class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
                <span class="text-sm">Music</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" name="noiseType" value="phone-call"
                  class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
                <span class="text-sm">Phone Call</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" name="noiseType" value="keyboard"
                  class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
                <span class="text-sm">Keyboard Typing</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" name="noiseType" value="footsteps"
                  class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
                <span class="text-sm">Footsteps</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" name="noiseType" value="equipment"
                  class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
                <span class="text-sm">Equipment</span>
              </label>
            </div>
          </div>

          <!-- Duration -->
          <div>
            <label for="duration" class="block text-sm font-medium text-slate-700 mb-2">Duration</label>
            <select id="duration" name="duration"
              class="w-full rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none p-3">
              <option value="">Select duration...</option>
              <option value="less-than-5">Less than 5 minutes</option>
              <option value="5-15">5-15 minutes</option>
              <option value="15-30">15-30 minutes</option>
              <option value="30-60">30-60 minutes</option>
              <option value="more-than-60">More than 1 hour</option>
              <option value="ongoing">Ongoing</option>
            </select>
          </div>

          <!-- Description -->
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Additional Details</label>
            <textarea id="description" rows="4"
              class="w-full rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none p-3"
              placeholder="Describe the noise disturbance in detail..."></textarea>
          </div>

          <!-- Urgency -->
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-3">Urgency Level</label>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 sm:gap-3">
              <label class="relative cursor-pointer">
                <input type="radio" name="urgency" value="low" class="sr-only" />
                <div
                  class="urgency-option p-3 rounded-lg border-2 border-slate-200 text-center hover:border-green-300 transition">
                  <div class="text-lg mb-1">🟢</div>
                  <div class="text-sm font-medium">Low</div>
                  <div class="text-xs text-slate-500">Minor issue</div>
                </div>
              </label>
              <label class="relative cursor-pointer">
                <input type="radio" name="urgency" value="medium" class="sr-only" />
                <div
                  class="urgency-option p-3 rounded-lg border-2 border-slate-200 text-center hover:border-yellow-300 transition">
                  <div class="text-lg mb-1">🟡</div>
                  <div class="text-sm font-medium">Medium</div>
                  <div class="text-xs text-slate-500">Needs attention</div>
                </div>
              </label>
              <label class="relative cursor-pointer">
                <input type="radio" name="urgency" value="high" class="sr-only" />
                <div
                  class="urgency-option p-3 rounded-lg border-2 border-slate-200 text-center hover:border-red-300 transition">
                  <div class="text-lg mb-1">🔴</div>
                  <div class="text-sm font-medium">High</div>
                  <div class="text-xs text-slate-500">Immediate action</div>
                </div>
              </label>
            </div>
          </div>

          <!-- Submit Button -->
          <div class="flex items-center justify-end gap-3 pt-4 border-t border-slate-200">
            <button type="button" id="cancelBtn" class="px-4 py-2 rounded-lg btn-outline">Cancel</button>
            <button type="submit" id="submitBtn"
              class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-medium">Submit Report</button>
          </div>
        </form>
      </section>

      <!-- Community Reports (user-facing list) -->
      <!-- This section is designed for community users: card-style items, clear grouping, badges -->
      <section class="bg-white rounded-2xl shadow p-4 sm:p-6" data-fade data-blur="true" data-duration="1000"
        data-easing="ease-out" data-delay="150" data-initial-opacity="0">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 class="text-lg font-semibold">Community Reports</h2>
            <div class="text-xs text-slate-500 mt-0.5"><span id="communityCount">0</span> reports • <span
                id="communityWindow">Last 25</span></div>
          </div>
          <div class="flex items-center gap-2">
            <label for="communityLimit" class="sr-only">Community report count</label>
            <select id="communityLimit" name="communityLimit"
              class="px-2 py-1.5 text-xs rounded-lg border border-slate-300">
              <option value="10">Last 10</option>
              <option value="25" selected>Last 25</option>
              <option value="50">Last 50</option>
            </select>
            <button id="refreshCommunity" class="px-3 py-1.5 text-xs rounded-lg btn-outline">Refresh</button>
          </div>
        </div>
        <div id="communityReports" class="space-y-3">
          <div class="text-center text-slate-500 py-8">
            <p>No community reports yet</p>
            <p class="text-sm">New reports from students will appear here</p>
          </div>
        </div>
      </section>

      <!-- Admin-only Reports Table (hidden for non-admin users) -->
      <!-- Admin view: retains table-like layout for quick scanning. Visibility toggled by role. -->
      <section id="adminReportsTableContainer" class="bg-white rounded-2xl shadow p-4 sm:p-6 hidden" data-fade
        data-blur="true" data-duration="1000" data-easing="ease-out" data-delay="150" data-initial-opacity="0">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Admin Reports (table)</h2>
          <div class="text-xs text-slate-500">Visible to admins only</div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-slate-500">
                <th class="py-2 pr-4">When</th>
                <th class="py-2 pr-4">Reporter</th>
                <th class="py-2 pr-4">Location</th>
                <th class="py-2 pr-4">Notes</th>
                <th class="py-2 pr-4">Status</th>
              </tr>
            </thead>
            <tbody id="adminReportsTableBody"></tbody>
          </table>
        </div>
      </section>

    </div>
  </main>

  <footer class="text-center text-xs text-slate-500 py-3" data-fade data-blur="true" data-initial-opacity="0"
    data-duration="1000" data-delay="100">© 2025 UMak Library · Noise Comfort Index</footer>
  <div id="supabase-status" class="px-2 py-1 rounded-md text-xs bg-slate-200 text-slate-700 hidden"></div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="confirmation-modal-overlay hidden">
    <div class="confirmation-modal">
      <div class="confirmation-modal-header">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <h3>Confirm Report Submission</h3>
      </div>
      <div class="confirmation-modal-body">
        <p>Are you sure you want to submit this noise report?</p>
        <div class="warning-text">
          <strong>⚠️ Important Notice:</strong><br>
          If the admin discovers that this report is invalid or falsified, sanctions may apply. Please ensure all
          information provided is accurate and truthful.
        </div>
      </div>
      <div class="confirmation-modal-footer">
        <button type="button" id="cancelConfirmation" class="btn-cancel">Cancel</button>
        <button type="button" id="confirmSubmission" class="btn-confirm">Yes, Submit Report</button>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-md">
      <div class="text-center">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h3 class="text-lg font-semibold mb-2">Report Submitted</h3>
        <p class="text-slate-600 mb-4">Thank you for helping maintain a quiet study environment. Librarians will review
          your report.</p>
        <button id="closeSuccessModal"
          class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white">OK</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script src="auth-guard.js"></script>
  <script src="security.js"></script>

  <script>
    (function () {
      // Supabase init with status
      function showStatus(text, ok) {
        var el = document.getElementById('supabase-status');
        if (!el) return;
        el.textContent = text || '';
        if (text) {
          el.classList.remove('hidden');
          el.classList.remove('bg-red-200', 'text-red-700');
          el.classList.remove('bg-green-200', 'text-green-700');
          if (ok) {
            el.classList.add('bg-green-200', 'text-green-700');
          } else {
            el.classList.add('bg-red-200', 'text-red-700');
          }
        } else {
          el.classList.add('hidden');
        }
      }

      // Initialize Supabase
      var supabaseInitialized = false;
      try {
        if (initSupabase()) {
          supabaseInitialized = true;
          showStatus('Supabase: Connected', true);
        } else {
          showStatus('Supabase: Error', false);
        }
      } catch (err) {
        showStatus('Supabase: Error', false);
      }

      // Form elements
      var form = document.getElementById('noiseReportForm');
      var cancelBtn = document.getElementById('cancelBtn');
      var submitBtn = document.getElementById('submitBtn');
      var successModal = document.getElementById('successModal');
      var closeSuccessModal = document.getElementById('closeSuccessModal');
      var logoutBtn = document.getElementById('logoutBtn');
      var logoutBtnMobile = document.getElementById('logoutBtnMobile');

      // Logout functionality
      function handleLogout() {
        try {
          if (window.supabaseAuth) {
            window.supabaseAuth.signOut().then(function () {
              window.location.href = 'index.html';
            }).catch(function (err) {
              console.error('Logout error:', err);
              window.location.href = 'index.html';
            });
          } else {
            window.location.href = 'index.html';
          }
        } catch (_) { window.location.href = 'index.html'; }
      }
      if (logoutBtn) { logoutBtn.addEventListener('click', handleLogout); }
      if (logoutBtnMobile) { logoutBtnMobile.addEventListener('click', handleLogout); }

      // Cancel button
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function () {
          window.location.href = 'Frame_11.html';
        });
      }

      // Close success modal (stay on this page)
      if (closeSuccessModal) {
        closeSuccessModal.addEventListener('click', function () {
          successModal.classList.add('hidden');
          successModal.classList.remove('flex');
          try {
            if (form) { form.reset(); }
            if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Submit Report'; }
            loadRecentReports();
          } catch (_) { }
        });
      }

      // Form submission via Supabase (send to admins)
      if (form) {
        form.addEventListener('submit', async function (e) {
          e.preventDefault();

          // Get form data
          var noiseLevel = document.querySelector('input[name="noiseLevel"]:checked');
          var location = document.getElementById('location').value;
          var noiseTypes = Array.from(document.querySelectorAll('input[name="noiseType"]:checked')).map(function (cb) { return cb.value; });
          var duration = document.getElementById('duration').value;
          var description = document.getElementById('description').value;
          var urgency = document.querySelector('input[name="urgency"]:checked');

          // Validation
          if (!noiseLevel) { alert('Please select a noise level'); return; }
          if (!location) { alert('Please select a location'); return; }
          if (noiseTypes.length === 0) { alert('Please select at least one noise type'); return; }
          if (!duration) { alert('Please select duration'); return; }
          if (!urgency) { alert('Please select urgency level'); return; }

          // Show confirmation modal
          var confirmationModal = document.getElementById('confirmationModal');
          confirmationModal.classList.remove('hidden');

          // Wait for user confirmation
          return; // Don't submit yet
        });

        // Handle confirmation modal
        var confirmationModal = document.getElementById('confirmationModal');
        var cancelConfirmation = document.getElementById('cancelConfirmation');
        var confirmSubmission = document.getElementById('confirmSubmission');

        // Cancel button - hide modal
        cancelConfirmation.addEventListener('click', function () {
          confirmationModal.classList.add('hidden');
        });

        // Confirm button - actually submit the form
        confirmSubmission.addEventListener('click', async function () {
          // Hide confirmation modal
          confirmationModal.classList.add('hidden');

          // Get form data again
          var noiseLevel = document.querySelector('input[name="noiseLevel"]:checked');
          var location = document.getElementById('location').value;
          var noiseTypes = Array.from(document.querySelectorAll('input[name="noiseType"]:checked')).map(function (cb) { return cb.value; });
          var duration = document.getElementById('duration').value;
          var description = document.getElementById('description').value;
          var urgency = document.querySelector('input[name="urgency"]:checked');

          submitBtn.disabled = true;
          submitBtn.textContent = 'Submitting...';

          try {
            var userResult = await window.supabaseAuth.getCurrentUser();
            var user = userResult && userResult.data ? userResult.data.user : null;
            if (!user) { window.location.href = 'index.html'; return; }

            var tableId = location.indexOf('table-') === 0 ? location : null;
            var notes = '[Types] ' + noiseTypes.join(', ') + ' | [Duration] ' + duration + ' | [Urgency] ' + urgency.value + (description ? (' | [Notes] ' + description) : '');

            // Persist report in noise_logs for admin visibility
            var addRes = await window.supabaseDB.addNoiseLog(user.id, tableId || location, parseFloat(noiseLevel.value), 'report', notes);
            if (addRes && addRes.error) throw addRes.error;

            // Notify admins via alerts table
            var msg = 'New report (' + severityLabel(parseFloat(noiseLevel.value)) + ') at ' + (tableId || location);
            try { await window.supabaseDB.addAlert(user.id, 'report', msg); } catch (_) { }

            successModal.classList.remove('hidden');
            successModal.classList.add('flex');
          } catch (err) {
            console.error('Failed to submit report:', err);
            alert('Failed to submit report. Please try again.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Report';
          }

          function severityLabel(level) {
            if (level >= 4.5) return 'critical';
            if (level >= 3) return 'warning';
            return 'info';
          }
        });
      }

      // Close modal when clicking outside
      if (confirmationModal) {
        confirmationModal.addEventListener('click', function (e) {
          if (e.target === confirmationModal) {
            confirmationModal.classList.add('hidden');
          }
        });
      }

      // Visual feedback for radio buttons
      function setupRadioVisuals() {
        // Noise level options
        var noiseLevels = document.querySelectorAll('input[name="noiseLevel"]');
        noiseLevels.forEach(function (radio) {
          radio.addEventListener('change', function () {
            // Remove previous selections
            document.querySelectorAll('.noise-level-option').forEach(function (option) {
              option.classList.remove('border-indigo-500', 'bg-indigo-50');
              option.classList.add('border-slate-200');
            });
            // Add selection to current
            if (this.checked) {
              var option = this.parentElement.querySelector('.noise-level-option');
              option.classList.remove('border-slate-200');
              option.classList.add('border-indigo-500', 'bg-indigo-50');
            }
          });
        });

        // Urgency options
        var urgencies = document.querySelectorAll('input[name="urgency"]');
        urgencies.forEach(function (radio) {
          radio.addEventListener('change', function () {
            // Remove previous selections
            document.querySelectorAll('.urgency-option').forEach(function (option) {
              option.classList.remove('border-indigo-500', 'bg-indigo-50');
              option.classList.add('border-slate-200');
            });
            // Add selection to current
            if (this.checked) {
              var option = this.parentElement.querySelector('.urgency-option');
              option.classList.remove('border-slate-200');
              option.classList.add('border-indigo-500', 'bg-indigo-50');
            }
          });
        });
      }

      // Load community reports via RPC
      function loadCommunityReports() {
        var list = document.getElementById('communityReports');
        var countEl = document.getElementById('communityCount');
        var windowEl = document.getElementById('communityWindow');
        var limitSel = document.getElementById('communityLimit');
        if (!supabaseInitialized || !list) return;
        var limit = 25;
        try { limit = parseInt(limitSel && limitSel.value || '25', 10) || 25; } catch (_) { }
        if (windowEl) { windowEl.textContent = 'Last ' + limit; }
        list.innerHTML = '<div class="text-center text-slate-500 py-6 text-sm">Loading…</div>';
        window.supabaseDB.publicListReports(limit).then(function (result) {
          var rows = Array.isArray(result.data) ? result.data : [];
          if (countEl) { countEl.textContent = String(rows.length); }
          if (rows.length === 0) {
            list.innerHTML = '\n            <div class="text-center text-slate-500 py-8">\n              <p>No community reports yet</p>\n              <p class="text-sm">New reports from students will appear here</p>\n            </div>\n          ';
            return;
          }
          list.innerHTML = '';
          rows.forEach(function (r) {
            var isAdminPost = r.notes && r.notes.toLowerCase().includes('posted by admin');
            var urgency = (function () {
              var m = (r.notes || '').match(/\[Urgency\]\s*(\w+)/i); return m ? (m[1] || '').toLowerCase() : '';
            })();
            var types = (function () {
              var m = (r.notes || '').match(/\[Types\]\s*([^|]+)/i); return m ? (m[1] || '').trim() : '';
            })();
            var duration = (function () {
              var m = (r.notes || '').match(/\[Duration\]\s*([^|]+)/i); return m ? (m[1] || '').trim() : '';
            })();

            var badgeClass = urgency === 'high' ? 'badge badge-high' : (urgency === 'medium' ? 'badge badge-medium' : 'badge badge-low');
            var who = (r.reporter_email || '').trim();
            var when = new Date(r.created_at).toLocaleString();
            var where = r.location || r.table_id || '—';
            var notes = (r.notes || '').replace(/\s*\[Types\][^|]+\|?\s*/i, '').replace(/\s*\[Duration\][^|]+\|?\s*/i, '').replace(/\s*\[Urgency\][^|]+\|?\s*/i, '').trim();

            var el = document.createElement('div');
            el.className = 'report-card p-3 sm:p-4';
            el.innerHTML = '\n              <div class="flex items-start justify-between gap-3">\n                <div class="min-w-0">\n                  <div class="flex items-center gap-2 flex-wrap">\n                    ' + (isAdminPost ? '<span class="badge badge-medium">Admin</span>' : '') + '\n                    <span class="meta-sm">' + (who || 'Reporter') + '</span>\n                    <span class="meta-sm">•</span>\n                    <span class="meta-sm">' + when + '</span>\n                  </div>\n                  <div class="mt-1 text-sm">' + where + '</div>\n                  <div class="mt-2 flex items-center gap-2 flex-wrap">\n                    ' + (urgency ? '<span class="' + badgeClass + '">Urgency: ' + urgency.charAt(0).toUpperCase() + urgency.slice(1) + '</span>' : '') + '\n                    ' + (types ? '<span class="badge" style="background:rgba(59,130,246,0.12);color:#1d4ed8">' + types + '</span>' : '') + '\n                    ' + (duration ? '<span class="badge" style="background:rgba(107,114,128,0.12);color:#374151">' + duration + '</span>' : '') + '\n                  </div>\n                  ' + (notes ? '<div class="mt-2 text-sm text-slate-700">' + notes + '</div>' : '') + '\n                </div>\n              </div>\n            ';
            list.appendChild(el);
          });
        }).catch(function () {
          list.innerHTML = '<div class="text-center text-red-600 py-6 text-sm">Failed to load community reports.</div>';
        });
      }

      // Load community reports immediately (no auth gate needed to view)
      if (supabaseInitialized) {
        loadCommunityReports();
        var limitSel = document.getElementById('communityLimit');
        var refreshBtn = document.getElementById('refreshCommunity');
        if (limitSel) limitSel.addEventListener('change', loadCommunityReports);
        if (refreshBtn) refreshBtn.addEventListener('click', loadCommunityReports);

        // Role-based visibility: show admin table if admin
        try {
          window.supabaseAuth.getCurrentUser().then(function (res) {
            var user = res && res.data ? res.data.user : null;
            if (!user) return;
            window.supabaseDB.isAdmin(user.id).then(function (chk) {
              var isAdmin = chk && chk.data === true;
              var adminCt = document.getElementById('adminReportsTableContainer');
              if (adminCt) {
                if (isAdmin) {
                  adminCt.classList.remove('hidden');
                  // Populate admin table
                  window.supabaseDB.getNoiseLogs('*', 50).then(function (res2) {
                    var rows = Array.isArray(res2.data) ? res2.data : [];
                    var tbody = document.getElementById('adminReportsTableBody');
                    if (tbody) {
                      tbody.innerHTML = '';
                      rows.forEach(function (r) {
                        var tr = document.createElement('tr');
                        tr.innerHTML = '<td class="py-2 pr-4">' + (new Date(r.created_at).toLocaleString()) + '</td>' +
                          '<td class="py-2 pr-4">' + (r.reporter_email || '') + '</td>' +
                          '<td class="py-2 pr-4">' + (r.location || r.table_id || '—') + '</td>' +
                          '<td class="py-2 pr-4">' + (r.notes || '') + '</td>' +
                          '<td class="py-2 pr-4">' + (r.status || '') + '</td>';
                        tbody.appendChild(tr);
                      });
                    }
                  }).catch(function () { });
                } else {
                  adminCt.classList.add('hidden');
                }
              }
            });
          });
        } catch (_) { }
      }

      // Initialize
      setupRadioVisuals();
    })();
  </script>
  <script>
    // Fade-on-scroll transitions (match other frames to avoid sticky blur)
    (function () {
      var fadeElements = Array.from(document.querySelectorAll('[data-fade]'));
      if (fadeElements.length === 0) return;

      fadeElements.forEach(function (el) {
        var initialOpacity = parseFloat(el.getAttribute('data-initial-opacity') || '0');
        var duration = parseInt(el.getAttribute('data-duration') || '1000', 10);
        var easing = el.getAttribute('data-easing') || 'ease-out';
        var blurPxAttr = el.getAttribute('data-blur-px');
        var blurPx = parseInt(blurPxAttr || '14', 10);
        el.style.opacity = String(initialOpacity);
        el.style.setProperty('--fade-init', blurPx + 'px');
        el.style.setProperty('--fade-transition', 'opacity ' + duration + 'ms ' + easing + ', filter ' + duration + 'ms ' + easing);
      });

      var observer = new IntersectionObserver(function (entries) {
        entries.forEach(function (entry) {
          if (entry.isIntersecting) {
            var el = entry.target;
            var delay = parseInt(el.getAttribute('data-delay') || '0', 10);
            var blurAttr = el.getAttribute('data-blur');
            var blurEnabled = (blurAttr !== 'false');
            observer.unobserve(el);
            setTimeout(function () {
              el.style.opacity = '1';
              if (blurEnabled) {
                el.style.setProperty('--fade-init', '0px');
              }
            }, delay);
          }
        });
      }, { threshold: 0.1 });

      fadeElements.forEach(function (el) { observer.observe(el); });
    })();
  </script>
  <script>
    // Fade-on-scroll transitions (same as Frame 8)
    (function () {
      var fadeElements = Array.from(document.querySelectorAll('[data-fade]'));
      if (fadeElements.length === 0) return;

      fadeElements.forEach(function (el) {
        var initialOpacity = parseFloat(el.getAttribute('data-initial-opacity') || '0');
        var duration = parseInt(el.getAttribute('data-duration') || '1000', 10);
        var easing = el.getAttribute('data-easing') || 'ease-out';
        var blurAttr = el.getAttribute('data-blur');
        var blurEnabled = (blurAttr !== 'false');
        el.style.opacity = String(initialOpacity);
        el.style.filter = blurEnabled ? 'blur(10px)' : 'none';
        el.style.transition = 'opacity ' + duration + 'ms ' + easing + ', filter ' + duration + 'ms ' + easing;
      });

      var observer = new IntersectionObserver(function (entries) {
        entries.forEach(function (entry) {
          if (entry.isIntersecting) {
            var el = entry.target;
            var delay = parseInt(el.getAttribute('data-delay') || '0', 10);
            var blurAttr = el.getAttribute('data-blur');
            var blurEnabled = (blurAttr !== 'false');
            observer.unobserve(el);
            setTimeout(function () {
              el.style.opacity = '1';
              if (blurEnabled) {
                el.style.filter = 'blur(0px)';
              }
            }, delay);
          }
        });
      }, { threshold: 0.1 });

      fadeElements.forEach(function (el) { observer.observe(el); });
    })();
  </script>
  <script>
    // Mobile menu toggle for Frame 16 (robust)
    (function () {
      try {
        var mobileBtn = document.getElementById('mobile-menu-btn');
        var mobileMenu = document.getElementById('mobile-menu');
        var header = document.querySelector('header.site-header');
        if (mobileBtn && mobileMenu && header) {
          mobileBtn.addEventListener('click', function () {
            var isHidden = mobileMenu.classList.contains('hidden');
            if (isHidden) {
              header.classList.add('menu-open');
              mobileMenu.classList.remove('hidden');
              mobileBtn.setAttribute('aria-expanded', 'true');
            } else {
              header.classList.remove('menu-open');
              mobileMenu.classList.add('hidden');
              mobileBtn.setAttribute('aria-expanded', 'false');
            }
          });
        }
      } catch (_) { }
    })();
  </script>

  <style>
    .noise-level-option:hover {
      transform: translateY(-1px);
    }

    .urgency-option:hover {
      transform: translateY(-1px);
    }
  </style>
  <script>
    // Library-themed cursor follower
    (function () {
      const follower = document.getElementById('cursor-follower');
      if (!follower) return;

      // Hide on touch devices
      const isTouch = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;
      if (isTouch) { follower.style.display = 'none'; return; }
      if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        follower.style.display = 'none'; return;
      }

      let mouseX = window.innerWidth / 2;
      let mouseY = window.innerHeight / 2;
      let posX = mouseX;
      let posY = mouseY;
      const ease = 0.08; // Slower, more gentle movement for library theme
      let isVisible = false;

      // Gentle fade in/out on mouse movement
      window.addEventListener('mousemove', (e) => {
        mouseX = e.clientX;
        mouseY = e.clientY;
        if (!isVisible) {
          follower.style.opacity = '0.6';
          isVisible = true;
        }
      }, { passive: true });

      // Fade out when mouse leaves window
      window.addEventListener('mouseleave', () => {
        follower.style.opacity = '0';
        isVisible = false;
      });

      // Smooth following animation
      function animate() {
        posX += (mouseX - posX) * ease;
        posY += (mouseY - posY) * ease;
        follower.style.transform = `translate(${posX}px, ${posY}px) translate(-50%, -50%)`;
        requestAnimationFrame(animate);
      }
      requestAnimationFrame(animate);
    })();
  </script>
</body>

</html>