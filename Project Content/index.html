<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>University of Makati Library - Login</title>
  <script>
    (function(){
      var originalWarn = console.warn;
      console.warn = function(){
        try {
          if (arguments && typeof arguments[0] === 'string' && arguments[0].indexOf('cdn.tailwindcss.com should not be used in production') !== -1) {
            return; // suppress only Tailwind CDN production warning
          }
        } catch (e) {}
        return originalWarn.apply(console, arguments);
      };
    })();
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="theme.css" />
  <script defer src="theme.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script>
    // Ensure Supabase is loaded before our script
    window.addEventListener('load', function() {
      if (typeof window.supabase === 'undefined') {
        console.error('Supabase library failed to load');
      } else {
        console.log('Supabase library loaded successfully');
      }
    });
  </script>
  <script src="supabase.js"></script>
  <script src="auth.js"></script>
  <script src="password-toggle.js"></script>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">
  <header class="site-header">
    <div class="max-w-6xl mx-auto flex items-center gap-4 py-3 px-6">
      <img src="UMak_Logo_Registered.png" alt="University of Makati Logo" class="h-12 w-auto" />
      <a href="index.html" class="brand-title text-2xl font-semibold mr-auto">University of Makati Library</a>
      <nav class="hidden md:flex items-center gap-4 text-sm">
        <a href="Frame_5.html" class="nav-link">Register</a>
        <a href="how-to.html" class="nav-link">How To</a>
      </nav>
    </div>
  </header>
  
  <main class="flex-1 flex items-start justify-center py-12 px-6">
    <div class="w-full max-w-6xl">
      <div class="bg-white rounded-2xl shadow overflow-hidden">
        <div class="grid grid-cols-1 md:grid-cols-2">
          <!-- Left: Login form -->
          <div class="p-8">
            <h1 class="text-2xl font-bold mb-2">Welcome Back</h1>
            <p class="text-sm text-slate-500 mb-6">Sign in to access the library dashboard</p>

            <!-- Status Messages -->
            <div id="login-error" class="mb-4 text-sm text-red-600 bg-red-50 border border-red-100 rounded-lg p-3 hidden"></div>
            <div id="login-success" class="mb-4 text-sm text-green-600 bg-green-50 border border-green-100 rounded-lg p-3 hidden"></div>
            <div id="login-loading" class="mb-4 text-sm text-blue-600 bg-blue-50 border border-blue-100 rounded-lg p-3 hidden">
              <div class="flex items-center">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                Signing you in...
              </div>
            </div>

            <form id="login-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Email Address</label>
                <input id="login-email" type="email" class="w-full p-3 rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition" placeholder="your.email@umak.edu.ph" required />
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                <input id="login-password" type="password" class="w-full p-3 rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition" placeholder="Enter your password" required />
              </div>

              <!-- Admin Code Section (Hidden by default) -->
              <div id="admin-secret" class="hidden">
                <label class="block text-sm font-medium text-slate-700 mb-1">Admin Code (Optional)</label>
                <input id="admin-code" type="password" class="w-full p-3 rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition" placeholder="Enter admin code" />
                <p class="mt-1 text-xs text-slate-500">Press Alt+A or click the title 3 times to show/hide</p>
              </div>

              <div class="flex items-center justify-between">
                <label class="flex items-center gap-2 text-sm">
                  <input type="checkbox" class="rounded" />
                  Remember me
                </label>
                <a href="Frame_14.html" class="text-sm text-indigo-600 hover:text-indigo-700">Forgot password?</a>
              </div>

              <div>
                <button type="submit" class="w-full py-3 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                  Sign In
                </button>
              </div>
            </form>

            <div class="mt-6 text-center">
              <p class="text-sm text-slate-500">
                Don't have an account?
                <a href="Frame_5.html" class="text-indigo-600 hover:text-indigo-700 font-medium">Create one here</a>
              </p>
            </div>
          </div>

          <!-- Right: UMak info panel -->
          <div class="info-panel bg-gradient-to-br from-[#052865] via-[#003566] to-[#001d3d] text-white p-8 flex flex-col">
            <div class="flex items-center gap-3 mb-6">
              <img src="UMak_Logo_Registered.png" alt="UMak" class="h-10 w-10 rounded bg-white p-1" />
              <div>
                <h2 class="text-xl font-semibold !text-white">University of Makati Library</h2>
                <p class="text-white text-sm opacity-80 info-muted">Noise Comfort Index</p>
              </div>
            </div>

            <div class="space-y-4 text-white">
              <div>
                <h3 class="font-semibold !text-white">About</h3>
                <p class="text-sm opacity-90 info-muted">The UMak Library provides collaborative study spaces, quiet zones, and access to digital resources to support student success.</p>
              </div>
              <div>
                <h3 class="font-semibold !text-white">Features</h3>
                <ul class="text-sm list-disc pl-5 space-y-1 opacity-90 info-muted">
                  <li>Real-time seat occupancy and reservations</li>
                  <li>Noise Comfort Index monitoring</li>
                  <li>Report and resolve study area concerns</li>
                </ul>
              </div>
              <div>
                <h3 class="font-semibold !text-white">Library Hours</h3>
                <p class="text-sm opacity-90 info-muted">Mon–Fri: 8:00 AM – 7:00 PM · Sat: 9:00 AM – 5:00 PM</p>
              </div>
              <div class="mt-2 text-xs opacity-70 info-muted">For assistance, contact library@umak.edu.ph</div>
            </div>

            <!-- Link to How-To page -->
            <div class="mt-6">
              <a href="how-to.html" class="howto-btn inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-white/10 border border-white/10 text-white transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 0 6.5 22H19"/><path d="M20 12v6"/><path d="M20 18l-8-5v-5l8 5"/><path d="M4 4h16v6H4z"/></svg>
                Read: How to use the UMak Library App
              </a>
            </div>

            <div class="mt-auto pt-6">
              <div class="rounded-xl bg-white/10 border border-white/10 p-4">
                <p class="text-sm">Note: Use your UMak email (e.g., your.name@umak.edu.ph) to sign in.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <footer class="text-center text-xs text-slate-500 py-3">© 2025 UMak Library · Noise Comfort Index</footer>

  <script>
    (function(){
      // Prevent auto-redirects when coming from a logout
      var skipAutoRedirect = false;
      // Initialize Supabase with retry mechanism
      let supabaseInitialized = false;
      
      async function initializeSupabase() {
        try {
          // Try immediate initialization first
          if (initSupabase()) {
            supabaseInitialized = true;
            console.log('Supabase initialized successfully');
            return;
          }
          
          // If immediate initialization fails, try with retry mechanism
          console.log('Immediate initialization failed, trying with retry...');
          supabaseInitialized = await initSupabaseWithRetry();
          
          if (supabaseInitialized) {
            console.log('Supabase initialized successfully with retry');
          } else {
            console.error('Supabase initialization failed after retries');
          }
        } catch(err) {
          console.error('Supabase error:', err);
        }
      }
      
      // Initialize Supabase
      initializeSupabase();

      // Constants
      let tapCount = 0;

      // UI Helper Functions
      function showError(message) {
        hideAllMessages();
        const el = document.getElementById('login-error');
        if (el) {
          el.textContent = message;
          el.classList.remove('hidden');
        }
      }

      function showSuccess(message) {
        hideAllMessages();
        const el = document.getElementById('login-success');
        if (el) {
          el.textContent = message;
          el.classList.remove('hidden');
        }
      }

      function showLoading() {
        hideAllMessages();
        const el = document.getElementById('login-loading');
        if (el) {
          el.classList.remove('hidden');
        }
      }

      function hideAllMessages() {
        const messages = ['login-error', 'login-success', 'login-loading'];
        messages.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.classList.add('hidden');
        });
      }

      function setFormEnabled(enabled) {
        const form = document.getElementById('login-form');
        const inputs = form.querySelectorAll('input, button');
        inputs.forEach(input => {
          input.disabled = !enabled;
        });
      }

      // Admin Code Toggle
      function toggleAdminSecret(force) {
        const wrap = document.getElementById('admin-secret');
        if (!wrap) return;
        const willShow = typeof force === 'boolean' ? force : wrap.classList.contains('hidden');
        if (willShow) { 
          wrap.classList.remove('hidden'); 
        } else { 
          wrap.classList.add('hidden'); 
        }
      }

      // Event Listeners for Admin Code
      const title = document.querySelector('.brand-title');
      if (title) {
        title.addEventListener('click', function(){ 
          tapCount++; 
          if (tapCount >= 3) { 
            toggleAdminSecret(); 
            tapCount = 0; 
          } 
          setTimeout(function(){ tapCount = 0; }, 1200); 
        });
      }
      
      document.addEventListener('keydown', function(e){ 
        if ((e.altKey || e.metaKey) && (e.key === 'a' || e.key === 'A')) { 
          toggleAdminSecret(); 
        } 
      });

      // URL Parameter Handling
      const urlParams = new URLSearchParams(window.location.search);
      const message = urlParams.get('message');
      const logoutFlag = urlParams.get('logout');
      if (logoutFlag) {
        skipAutoRedirect = true;
        try { window.supabaseAuth && window.supabaseAuth.signOut && window.supabaseAuth.signOut(); } catch(_) {}
        // Clean the URL so refreshes don't keep the flag
        window.history.replaceState({}, document.title, window.location.pathname);
      }
      if (message) {
        showSuccess(message);
        // Clear the URL parameter
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      // Form Validation
      function validateForm() {
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;

        // Use AuthManager validation if available
        if (window.authManager) {
          const emailValidation = window.authManager.validateEmail(email);
          if (!emailValidation.valid) {
            showError(emailValidation.message);
            return false;
          }

          const passwordValidation = window.authManager.validatePassword(password);
          if (!passwordValidation.valid) {
            showError(passwordValidation.message);
            return false;
          }

          return true;
        }

        // Fallback validation
        if (!email) {
          showError('Email address is required');
          return false;
        }

        if (!email.toLowerCase().endsWith('@umak.edu.ph')) {
          showError('Please use a University of Makati email address (@umak.edu.ph)');
          return false;
        }

        if (!password) {
          showError('Password is required');
          return false;
        }

        return true;
      }

      // Enhanced User Profile Check
      async function checkAndCreateUserProfile(user) {
        if (!user || !user.id) {
          return false;
        }

        const email = (user.email || '').toLowerCase();
        if (!email.endsWith('@umak.edu.ph')) {
          return false;
        }

        try {
          // Check if user exists in users table
          const profileResult = await window.supabaseDB.getUser(user.id);
          
          if (profileResult.data) {
            console.log('User profile found:', profileResult.data);
            return true;
          } else {
            console.log('User profile not found, creating...');
            
            // Create user profile with metadata
            const userData = {
              first_name: user.user_metadata?.first_name || '',
              last_name: user.user_metadata?.last_name || '',
              student_id: user.user_metadata?.student_id || '',
              program: user.user_metadata?.program || ''
            };

            const createResult = await window.supabaseDB.insertUser(user.id, userData);
            
            if (createResult.error) {
              console.error('Failed to create user profile:', createResult.error);
              if (createResult.error.code === 'PGRST205') {
                console.error('Database table not found. Please run the SQL setup in Supabase dashboard.');
              }
              return false;
            } else {
              console.log('User profile created successfully:', createResult.data);
              return true;
            }
          }
        } catch (error) {
          console.error('Error checking/creating user profile:', error);
          return false;
        }
      }

      // Determine Destination After Login
      async function getDestinationAfterLogin(email, password, user) {
        try {
          // Use the secure AuthManager for destination determination
          if (window.authManager) {
            return await window.authManager.getDestinationAfterLogin(user);
          }
          
          // Fallback to default destination
          return 'Frame_11.html';
        } catch (error) {
          console.error('Error determining destination:', error);
          return 'Frame_11.html';
        }
      }

      // Login Handler
      async function handleLogin(event) {
        event.preventDefault();
        
        // Wait for Supabase to initialize if not ready
        if (!supabaseInitialized) {
          showError('System is initializing. Please wait a moment and try again.');
          
          // Try to initialize again
          await initializeSupabase();
          
          if (!supabaseInitialized) {
            showError('System not initialized. Please refresh the page and try again.');
            return;
          }
        }

        // Initialize AuthManager if not already done
        if (window.authManager && !window.authManager.isInitialized) {
          await window.authManager.initialize();
        }

        if (!validateForm()) {
          return;
        }

        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;

        try {
          showLoading();
          setFormEnabled(false);

          console.log('Attempting login with:', email);

          // Use secure AuthManager for login
          let result;
          if (window.authManager) {
            result = await window.authManager.login(email, password);
          } else {
            // Fallback to direct Supabase call
            result = await window.supabaseAuth.signIn(email, password);
            if (result.error) {
              throw result.error;
            }
          }

          console.log('Login successful:', result.data);

          // Check and create user profile
          const profileExists = await checkAndCreateUserProfile(result.data.user);
          
          if (!profileExists) {
            // Sign out the user if profile creation failed
            await window.supabaseAuth.signOut();
            showError('Account setup incomplete. Please try registering again.');
            return;
          }

          // Determine destination
          const destination = await getDestinationAfterLogin(email, password, result.data.user);
          
          showSuccess('Login successful! Redirecting...');
          
          // Redirect to appropriate page
          const redirectDelay = window.APP_CONFIG?.ui?.redirectDelay || 1000;
          setTimeout(() => {
            window.location.href = destination;
          }, redirectDelay);

        } catch (error) {
          console.error('Login error:', error);
          
          // Enhanced error handling
          if (error.message.includes('Invalid login credentials')) {
            showError('Invalid email or password. Please check your credentials and try again.');
          } else if (error.message.includes('Email not confirmed')) {
            showError('Please check your email and click the confirmation link before signing in.');
          } else if (error.message.includes('Too many requests') || error.message.includes('Too many login attempts')) {
            showError('Too many login attempts. Please wait a moment and try again.');
          } else if (error.message.includes('Please use a University of Makati email address')) {
            showError(error.message);
          } else if (error.message.includes('Password must be at least')) {
            showError(error.message);
          } else {
            showError(error.message || 'Login failed. Please try again.');
          }
        } finally {
          setFormEnabled(true);
        }
      }

      // Event Listeners
      const form = document.getElementById('login-form');
      if (form) {
        form.addEventListener('submit', handleLogin);
      }

      // Real-time validation
      const emailInput = document.getElementById('login-email');
      if (emailInput) {
        emailInput.addEventListener('blur', function() {
          const email = this.value.trim();
          if (email) {
            if (window.authManager) {
              const validation = window.authManager.validateEmail(email);
              if (!validation.valid) {
                showError(validation.message);
              } else {
                hideAllMessages();
              }
            } else {
              // Fallback validation
              if (!email.toLowerCase().endsWith('@umak.edu.ph')) {
                showError('Please use a University of Makati email address (@umak.edu.ph)');
              } else {
                hideAllMessages();
              }
            }
          }
        });
      }

      // Check if user is already logged in
      if (supabaseInitialized && !skipAutoRedirect) {
        window.supabaseAuth.getCurrentUser().then(async ({ data: { user } }) => {
          if (user) {
            console.log('User already logged in:', user.email);
            // Redirect to appropriate page
            const destination = await getDestinationAfterLogin(user.email, '', user);
            window.location.href = destination;
          }
        }).catch(error => {
          console.log('No existing session:', error);
        });
      }

    })();
  </script>
</body>
</html>