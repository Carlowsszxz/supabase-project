<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" type="image/png" href="UMak_Logo_Registered.png" />
    <title>University of Makati Library - Settings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="theme.css" />
    <script defer src="theme.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* Unified fade-in animation (matched to Frame 18 for consistent UX) */
        [data-fade] {
            opacity: 0;
            --fade-init: 14px;
            --fade-filter: none;
            filter: var(--fade-filter) !important;
            transition: var(--fade-transition, opacity 1000ms ease-out, filter 1000ms ease-out) !important;
            will-change: opacity, filter;
        }

        [data-fade]:not([data-blur="false"]) {
            --fade-filter: blur(var(--fade-init));
        }

        /* Modern Top Navigation Bar */
        .modern-sidebar {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            min-width: 320px;
            max-width: 500px;
            height: auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-top: none;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.05);
            z-index: 1000;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            padding: 1rem 2rem;
            gap: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Top Navigation Items */
        .sidebar-nav-item {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.3);
            color: #374151;
            text-decoration: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .sidebar-nav-item:hover {
            transform: translateY(-2px) scale(1.05);
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(0, 0, 0, 0.5);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15), 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .sidebar-nav-item:active {
            transform: translateY(0) scale(0.98);
        }

        .sidebar-nav-item.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.4);
            color: #3b82f6;
        }

        /* Sidebar Icons */
        .sidebar-icon {
            width: 24px;
            height: 24px;
            stroke-width: 1.5;
        }

        /* Tooltips */
        .sidebar-tooltip {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            z-index: 1001;
        }

        .sidebar-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-bottom-color: rgba(0, 0, 0, 0.9);
        }

        .sidebar-nav-item:hover .sidebar-tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* Logo/Brand in Top Navigation */
        .sidebar-brand {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-brand img {
            width: 32px;
            height: 32px;
            border-radius: 6px;
        }

        .sidebar-brand-text {
            font-size: 1.125rem;
            font-weight: 600;
            color: #374151;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .modern-sidebar {
                min-width: 280px;
                max-width: 90vw;
                padding: 0.75rem 1rem;
                gap: 0.75rem;
            }

            .sidebar-nav-item {
                width: 40px;
                height: 40px;
            }

            .sidebar-icon {
                width: 20px;
                height: 20px;
            }

            .sidebar-brand img {
                width: 28px;
                height: 28px;
            }

            .sidebar-brand-text {
                font-size: 1rem;
            }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            .modern-sidebar {
                background: rgba(15, 23, 42, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-top: none;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.05);
            }

            .sidebar-nav-item {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                color: #e5e7eb;
            }

            .sidebar-nav-item:hover {
                background: rgba(255, 255, 255, 0.1);
                border-color: rgba(255, 255, 255, 0.2);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 20px rgba(59, 130, 246, 0.4);
            }

            .sidebar-nav-item.active {
                background: rgba(59, 130, 246, 0.3);
                border-color: rgba(59, 130, 246, 0.5);
                color: #60a5fa;
            }

            .sidebar-brand-text {
                color: #e5e7eb;
            }
        }

        /* Manual dark mode class support */
        .dark .modern-sidebar {
            background: rgba(15, 23, 42, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        .dark .sidebar-nav-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e5e7eb;
        }

        .dark .sidebar-nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 20px rgba(59, 130, 246, 0.4);
        }

        .dark .sidebar-nav-item.active {
            background: rgba(59, 130, 246, 0.3);
            border-color: rgba(59, 130, 246, 0.5);
            color: #60a5fa;
        }

        .dark .sidebar-brand-text {
            color: #e5e7eb;
        }

        /* Adjust main content for top navigation */
        .main-with-sidebar {
            padding-top: 5rem;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">
    <!-- Modern Top Navigation Bar -->
    <nav class="modern-sidebar" data-fade data-blur="true" data-initial-opacity="0" data-duration="1000">
        <!-- Brand/Logo -->
        <div class="sidebar-brand">
            <img src="UMak_Logo_Registered.png" alt="University of Makati Logo" />
        </div>

        <!-- Navigation Items -->
        <a href="Frame_6.html" class="sidebar-nav-item" aria-label="Dashboard">
            <i data-lucide="layout-dashboard" class="sidebar-icon"></i>
            <div class="sidebar-tooltip">Dashboard</div>
        </a>

        <a href="Frame_7.html" class="sidebar-nav-item" aria-label="Log">
            <i data-lucide="file-text" class="sidebar-icon"></i>
            <div class="sidebar-tooltip">Log</div>
        </a>

        <a href="Frame_9.html" class="sidebar-nav-item" aria-label="Alerts">
            <i data-lucide="bell" class="sidebar-icon"></i>
            <div class="sidebar-tooltip">Alerts</div>
        </a>

        <a href="Frame_18.html" class="sidebar-nav-item" aria-label="Reports">
            <i data-lucide="bar-chart-3" class="sidebar-icon"></i>
            <div class="sidebar-tooltip">Reports</div>
        </a>

        <a href="Frame_15.html" class="sidebar-nav-item" aria-label="Users">
            <i data-lucide="users" class="sidebar-icon"></i>
            <div class="sidebar-tooltip">Users</div>
        </a>

        <a href="Frame_19.html" class="sidebar-nav-item active" aria-label="Settings">
            <i data-lucide="settings" class="sidebar-icon"></i>
            <div class="sidebar-tooltip">Settings</div>
        </a>

        <button onclick="logout()" class="sidebar-nav-item" aria-label="Logout">
            <i data-lucide="log-out" class="sidebar-icon"></i>
            <div class="sidebar-tooltip">Logout</div>
        </button>
    </nav>

    <main class="main-with-sidebar flex-1 py-8 px-6" data-fade data-blur="true" data-blur-px="16"
        data-initial-opacity="0" data-duration="1000" data-delay="50">
        <div class="max-w-7xl mx-auto">
            <div class="mb-8">
                <h1 class="text-3xl font-bold mb-2">IoT Monitoring & Settings</h1>
                <p class="text-slate-600">Monitor IoT devices, configure noise thresholds, and manage system settings
                </p>
            </div>

            <!-- IoT Device Status Overview -->
            <div class="mb-6">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold">IoT Device Status</h2>
                        <button id="refreshDevices"
                            class="px-3 py-1.5 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-sm">
                            Refresh
                        </button>
                    </div>
                    <div id="deviceStatusGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Device status cards will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Real-time Noise Monitoring -->
            <div class="mb-6">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold">Real-time Noise Monitoring</h2>
                        <div class="flex items-center gap-2">
                            <span id="lastUpdate" class="text-sm text-slate-500">Last update: --</span>
                            <button id="toggleAutoRefresh"
                                class="px-3 py-1.5 rounded-lg bg-green-600 hover:bg-green-700 text-white text-sm">
                                Auto Refresh: ON
                            </button>
                        </div>
                    </div>
                    <div id="noiseMonitoringGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Noise monitoring cards will be populated here -->
                    </div>
                </div>
            </div>

            <!-- RFID Activity Monitor -->
            <div class="mb-6">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold">RFID Activity Monitor</h2>
                        <button id="clearRfidLog"
                            class="px-3 py-1.5 rounded-lg bg-red-600 hover:bg-red-700 text-white text-sm">
                            Clear Log
                        </button>
                    </div>
                    <div id="rfidActivityLog" class="max-h-64 overflow-y-auto space-y-2">
                        <!-- RFID activity entries will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Recent Taps with UID -->
            <div class="mb-6">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-lg font-semibold">Recent Taps (from recent_taps view)</h2>
                            <p class="text-sm text-slate-500 mt-1">Shows taps with associated UID for manual user
                                assignment</p>
                        </div>
                        <button id="refreshRecentTaps"
                            class="px-3 py-1.5 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-sm">
                            Refresh
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-slate-200">
                                    <th class="text-left py-2 px-3 font-semibold text-slate-700">ID</th>
                                    <th class="text-left py-2 px-3 font-semibold text-slate-700">UID</th>
                                    <th class="text-left py-2 px-3 font-semibold text-slate-700">Name</th>
                                    <th class="text-left py-2 px-3 font-semibold text-slate-700">Table</th>
                                    <th class="text-left py-2 px-3 font-semibold text-slate-700">Timestamp</th>
                                </tr>
                            </thead>
                            <tbody id="recentTapsTableBody">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-slate-400">
                                        <i data-lucide="loader" class="animate-spin inline-block w-5 h-5"></i>
                                        <span class="ml-2">Loading taps...</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h3 class="text-sm font-semibold text-blue-900 mb-2">💡 Suggested UIDs for Manual Assignment:
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-xs text-blue-800">
                            <div><code class="bg-blue-100 px-2 py-1 rounded">CR001</code> - Carlos Ryan</div>
                            <div><code class="bg-blue-100 px-2 py-1 rounded">ST001</code> - Student 1</div>
                            <div><code class="bg-blue-100 px-2 py-1 rounded">ST002</code> - Student 2</div>
                            <div><code class="bg-blue-100 px-2 py-1 rounded">ST003</code> - Student 3</div>
                            <div><code class="bg-blue-100 px-2 py-1 rounded">ST004</code> - Student 4</div>
                            <div><code class="bg-blue-100 px-2 py-1 rounded">ST005</code> - Student 5</div>
                            <div><code class="bg-blue-100 px-2 py-1 rounded">AD001</code> - Admin 1</div>
                            <div><code class="bg-blue-100 px-2 py-1 rounded">AD002</code> - Admin 2</div>
                            <div><code class="bg-blue-100 px-2 py-1 rounded">LIB001</code> - Librarian 1</div>
                        </div>
                        <p class="text-xs text-blue-700 mt-2">Use these UIDs when manually assigning to users in the
                            database.</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Noise Thresholds -->
                <section class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold">Noise Thresholds</h2>
                        <button id="saveNoiseBtn"
                            class="px-3 py-1.5 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-sm">Save</button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Minimum Noise Threshold
                                (critical)</label>
                            <div class="flex items-center gap-3">
                                <input id="noiseThreshold" type="range" min="0" max="5" step="0.1" class="flex-1" />
                                <span id="noiseThresholdVal"
                                    class="px-2 py-0.5 rounded bg-slate-100 text-slate-700 text-sm w-12 text-center">—</span>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">Reports at or above this level are treated as
                                critical.</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Warning Threshold</label>
                            <div class="flex items-center gap-3">
                                <input id="warningThreshold" type="range" min="0" max="5" step="0.1" class="flex-1" />
                                <span id="warningThresholdVal"
                                    class="px-2 py-0.5 rounded bg-slate-100 text-slate-700 text-sm w-12 text-center">—</span>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">Reports at or above this level are treated as
                                warnings.</p>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="flex items-center gap-2 text-sm"><input id="autoCreateAlerts" type="checkbox"
                                    class="rounded" /> Auto-create alerts for critical</label>
                            <label class="flex items-center gap-2 text-sm"><input id="notifyAdmins" type="checkbox"
                                    class="rounded" /> Notify admins on critical</label>
                        </div>
                    </div>
                </section>

                <!-- NCI Behavior -->
                <section class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold">NCI Settings</h2>
                        <button id="saveNciBtn"
                            class="px-3 py-1.5 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-sm">Save</button>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Averaging Window
                                    (min)</label>
                                <input id="nciAvgWindow" type="number" min="1" max="120" step="1"
                                    class="w-full px-3 py-2 rounded-lg border border-slate-300" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Smoothing Factor
                                    (0-1)</label>
                                <input id="nciSmoothing" type="number" min="0" max="1" step="0.05"
                                    class="w-full px-3 py-2 rounded-lg border border-slate-300" />
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="flex items-center gap-2 text-sm"><input id="nciShowBadges" type="checkbox"
                                    class="rounded" /> Highlight critical areas</label>
                            <label class="flex items-center gap-2 text-sm"><input id="nciEnablePolling" type="checkbox"
                                    class="rounded" /> Enable live polling</label>
                        </div>
                    </div>
                </section>

                <!-- LCD Display Settings -->
                <section class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold">LCD Display</h2>
                        <button id="saveLcdBtn"
                            class="px-3 py-1.5 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-sm">Save</button>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Display Mode</label>
                                <select id="lcdMode" class="w-full px-3 py-2 rounded-lg border border-slate-300">
                                    <option value="summary">Summary</option>
                                    <option value="table">By Table</option>
                                    <option value="rolling">Rolling Ticker</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Brightness</label>
                                <input id="lcdBrightness" type="range" min="0" max="100" step="1" class="w-full" />
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Info to Show</label>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <label class="flex items-center gap-2"><input id="lcdShowNoise" type="checkbox"
                                        class="rounded" /> Current Noise Level</label>
                                <label class="flex items-center gap-2"><input id="lcdShowOccupancy" type="checkbox"
                                        class="rounded" /> Occupancy</label>
                                <label class="flex items-center gap-2"><input id="lcdShowWarnings" type="checkbox"
                                        class="rounded" /> Warnings</label>
                                <label class="flex items-center gap-2"><input id="lcdShowTips" type="checkbox"
                                        class="rounded" /> Tips / Notices</label>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Misc Settings -->
                <section class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold">Additional Controls</h2>
                        <button id="saveMiscBtn"
                            class="px-3 py-1.5 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-sm">Save</button>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <label class="flex items-center gap-2 text-sm"><input id="maintenanceMode" type="checkbox"
                                    class="rounded" /> Maintenance Mode</label>
                            <label class="flex items-center gap-2 text-sm"><input id="enableStudentReports"
                                    type="checkbox" class="rounded" checked /> Enable Student Reports</label>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Custom Message (LCD)</label>
                            <input id="customMessage" type="text"
                                class="w-full px-3 py-2 rounded-lg border border-slate-300"
                                placeholder="Welcome to UMak Library" />
                        </div>
                    </div>
                </section>
            </div>

            <div class="mt-6 flex items-center justify-end gap-3">
                <button id="resetDefaults" class="px-4 py-2 rounded-lg btn-outline">Reset to Defaults</button>
                <button id="saveAll"
                    class="px-6 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white font-medium">Save
                    All</button>
            </div>
        </div>
    </main>

    <footer class="text-center text-xs text-slate-500 py-3" data-fade data-blur="true" data-initial-opacity="0"
        data-delay="150">© 2025 UMak Library · Noise Comfort Index</footer>

    <script>
        (function () {
            var supabaseInitialized = false;
            // Admin access gate aligned with other admin frames (Supabase-based)
            async function checkAdminAccess() {
                try {
                    if (!supabaseInitialized) {
                        try { supabaseInitialized = await window.initSupabaseWithRetry(); } catch (_) { supabaseInitialized = false; }
                    }
                    if (!supabaseInitialized) {
                        console.warn('[Frame 19] Supabase not initialized, redirecting to login');
                        window.location.replace('index.html?from=settings');
                        return false;
                    }

                    var userResult = await window.supabaseAuth.getCurrentUser();
                    if (userResult.error || !userResult.data || !userResult.data.user) {
                        console.log('[Frame 19] No authenticated user, redirecting to login');
                        window.location.replace('index.html?from=settings');
                        return false;
                    }

                    var user = userResult.data.user;
                    var email = (user.email || '').toLowerCase();
                    if (email === 'adminlibrarian@umak.edu.ph') {
                        console.log('[Frame 19] Legacy admin detected, access granted');
                        return true;
                    }

                    var adminResult = await window.supabaseDB.isAdmin(user.id);
                    if (adminResult && adminResult.data) {
                        console.log('[Frame 19] Database admin verified, access granted');
                        return true;
                    }

                    console.log('[Frame 19] User is not admin, redirecting to student dashboard');
                    window.location.replace('Frame_4.html');
                    return false;
                } catch (e) {
                    console.error('[Frame 19] Admin access check failed:', e);
                    window.location.replace('index.html?from=settings');
                    return false;
                }
            }

            function getEls() {
                return {
                    noiseThreshold: document.getElementById('noiseThreshold'),
                    noiseThresholdVal: document.getElementById('noiseThresholdVal'),
                    warningThreshold: document.getElementById('warningThreshold'),
                    warningThresholdVal: document.getElementById('warningThresholdVal'),
                    autoCreateAlerts: document.getElementById('autoCreateAlerts'),
                    notifyAdmins: document.getElementById('notifyAdmins'),
                    nciAvgWindow: document.getElementById('nciAvgWindow'),
                    nciSmoothing: document.getElementById('nciSmoothing'),
                    nciShowBadges: document.getElementById('nciShowBadges'),
                    nciEnablePolling: document.getElementById('nciEnablePolling'),
                    lcdMode: document.getElementById('lcdMode'),
                    lcdBrightness: document.getElementById('lcdBrightness'),
                    lcdShowNoise: document.getElementById('lcdShowNoise'),
                    lcdShowOccupancy: document.getElementById('lcdShowOccupancy'),
                    lcdShowWarnings: document.getElementById('lcdShowWarnings'),
                    lcdShowTips: document.getElementById('lcdShowTips'),
                    maintenanceMode: document.getElementById('maintenanceMode'),
                    enableStudentReports: document.getElementById('enableStudentReports'),
                    customMessage: document.getElementById('customMessage'),
                };
            }

            function readForm() {
                var el = getEls();
                return {
                    noiseThreshold: parseFloat(el.noiseThreshold.value),
                    warningThreshold: parseFloat(el.warningThreshold.value),
                    autoCreateAlerts: !!el.autoCreateAlerts.checked,
                    notifyAdmins: !!el.notifyAdmins.checked,
                    nci: {
                        averagingWindowMin: parseInt(el.nciAvgWindow.value, 10),
                        smoothingFactor: parseFloat(el.nciSmoothing.value),
                        showBadges: !!el.nciShowBadges.checked,
                        enablePolling: !!el.nciEnablePolling.checked
                    },
                    lcd: {
                        mode: el.lcdMode.value,
                        brightness: parseInt(el.lcdBrightness.value, 10),
                        showNoise: !!el.lcdShowNoise.checked,
                        showOccupancy: !!el.lcdShowOccupancy.checked,
                        showWarnings: !!el.lcdShowWarnings.checked,
                        showTips: !!el.lcdShowTips.checked,
                        customMessage: el.customMessage.value || ''
                    },
                    maintenanceMode: !!el.maintenanceMode.checked,
                    enableStudentReports: !!el.enableStudentReports.checked
                };
            }

            function writeForm(data) {
                var el = getEls();
                var d = data || {};
                var nci = d.nci || {};
                var lcd = d.lcd || {};
                var th = typeof d.noiseThreshold === 'number' ? d.noiseThreshold : 4.5;
                var wh = typeof d.warningThreshold === 'number' ? d.warningThreshold : 3.0;
                el.noiseThreshold.value = String(th);
                el.noiseThresholdVal.textContent = String(th);
                el.warningThreshold.value = String(wh);
                el.warningThresholdVal.textContent = String(wh);
                el.autoCreateAlerts.checked = !!d.autoCreateAlerts;
                el.notifyAdmins.checked = !!d.notifyAdmins;
                el.nciAvgWindow.value = String(typeof nci.averagingWindowMin === 'number' ? nci.averagingWindowMin : 15);
                el.nciSmoothing.value = String(typeof nci.smoothingFactor === 'number' ? nci.smoothingFactor : 0.5);
                el.nciShowBadges.checked = !!nci.showBadges;
                el.nciEnablePolling.checked = typeof nci.enablePolling === 'boolean' ? nci.enablePolling : true;
                el.lcdMode.value = lcd.mode || 'summary';
                el.lcdBrightness.value = String(typeof lcd.brightness === 'number' ? lcd.brightness : 75);
                el.lcdShowNoise.checked = typeof lcd.showNoise === 'boolean' ? lcd.showNoise : true;
                el.lcdShowOccupancy.checked = typeof lcd.showOccupancy === 'boolean' ? lcd.showOccupancy : true;
                el.lcdShowWarnings.checked = !!lcd.showWarnings;
                el.lcdShowTips.checked = !!lcd.showTips;
                el.customMessage.value = lcd.customMessage || '';
            }

            function wireUI() {
                var el = getEls();
                el.noiseThreshold.addEventListener('input', function () { document.getElementById('noiseThresholdVal').textContent = String(this.value); });
                el.warningThreshold.addEventListener('input', function () { document.getElementById('warningThresholdVal').textContent = String(this.value); });
            }

            async function loadSettings() {
                try {
                    if (!supabaseInitialized) { try { supabaseInitialized = await window.initSupabaseWithRetry(); } catch (_) { supabaseInitialized = false; } }
                    if (!supabaseInitialized) { console.error('Supabase not available'); return; }
                    var res = await window.supabaseDB.getAdminLayout();
                    var cfg = (res && res.data) || {};
                    writeForm(cfg);
                    console.log('Loaded settings');
                } catch (e) {
                    console.error('Failed to load settings', e);
                }
            }

            async function save(partial) {
                try {
                    if (!supabaseInitialized) return;
                    var existing = (await window.supabaseDB.getAdminLayout()).data || {};
                    var merged = Object.assign({}, existing, partial);
                    var out = await window.supabaseDB.updateAdminLayout(merged);
                    console.log('Saved');
                    return out;
                } catch (e) {
                    console.error('Save failed', e);
                }
            }

            function bindActions() {
                var el = getEls();
                document.getElementById('saveNoiseBtn').addEventListener('click', function () {
                    var data = readForm();
                    save({ noiseThreshold: data.noiseThreshold, warningThreshold: data.warningThreshold, autoCreateAlerts: data.autoCreateAlerts, notifyAdmins: data.notifyAdmins });
                });
                document.getElementById('saveNciBtn').addEventListener('click', function () {
                    var data = readForm();
                    save({ nci: data.nci });
                });
                document.getElementById('saveLcdBtn').addEventListener('click', function () {
                    var data = readForm();
                    save({ lcd: data.lcd });
                });
                document.getElementById('saveMiscBtn').addEventListener('click', function () {
                    var data = readForm();
                    save({ maintenanceMode: data.maintenanceMode, enableStudentReports: data.enableStudentReports, lcd: Object.assign({}, data.lcd, { customMessage: data.lcd.customMessage }) });
                });
                document.getElementById('saveAll').addEventListener('click', function () { save(readForm()); });
                document.getElementById('resetDefaults').addEventListener('click', function () {
                    writeForm({});
                });
            }

            function logout() {
                try {
                    if (window.supabaseAuth) {
                        window.supabaseAuth.signOut().then(function () { window.location.href = 'index.html'; }).catch(function () { window.location.href = 'index.html'; });
                    } else { window.location.href = 'index.html'; }
                } catch (_) { window.location.href = 'index.html'; }
            }
            window.logout = logout;

            // Mobile menu toggle
            (function () {
                var btn = document.getElementById('mobile-menu-btn');
                var menu = document.getElementById('mobile-menu');
                var header = document.querySelector('header.site-header');
                if (btn && menu && header) {
                    btn.addEventListener('click', function () {
                        var isHidden = menu.classList.contains('hidden');
                        if (isHidden) { header.classList.add('menu-open'); menu.classList.remove('hidden'); btn.setAttribute('aria-expanded', 'true'); }
                        else { header.classList.remove('menu-open'); menu.classList.add('hidden'); btn.setAttribute('aria-expanded', 'false'); }
                    });
                }
            })();

            // IoT Monitoring Functions
            let autoRefreshInterval = null;
            let isAutoRefreshOn = true;

            // Load and display IoT device status
            async function loadDeviceStatus() {
                try {
                    const { data: devices, error } = await supabase
                        .from('iot_devices')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (error) {
                        console.error('Error loading devices:', error);
                        return;
                    }

                    const deviceGrid = document.getElementById('deviceStatusGrid');
                    if (!deviceGrid) return;

                    deviceGrid.innerHTML = devices.map(device => `
                        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-medium text-slate-900">${device.device_name}</h3>
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${device.status === 'active' ? 'bg-green-100 text-green-800' :
                            device.status === 'inactive' ? 'bg-red-100 text-red-800' :
                                'bg-yellow-100 text-yellow-800'
                        }">
                                    ${device.status}
                                </span>
                            </div>
                            <div class="text-sm text-slate-600 space-y-1">
                                <div>Type: ${device.device_type}</div>
                                <div>Location: ${device.location || 'N/A'}</div>
                                <div>Last seen: ${new Date(device.last_seen).toLocaleString()}</div>
                            </div>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Error in loadDeviceStatus:', error);
                }
            }

            // Load and display real-time noise monitoring
            async function loadNoiseMonitoring() {
                try {
                    const { data: readings, error } = await supabase
                        .from('noise_readings')
                        .select(`
                            *,
                            iot_devices!inner(device_name, location)
                        `)
                        .order('timestamp', { ascending: false })
                        .limit(20);

                    if (error) {
                        console.error('Error loading noise readings:', error);
                        return;
                    }

                    const noiseGrid = document.getElementById('noiseMonitoringGrid');
                    if (!noiseGrid) return;

                    // Group readings by device
                    const groupedReadings = readings.reduce((acc, reading) => {
                        const deviceId = reading.device_id;
                        if (!acc[deviceId]) {
                            acc[deviceId] = {
                                device: reading.iot_devices,
                                readings: []
                            };
                        }
                        acc[deviceId].readings.push(reading);
                        return acc;
                    }, {});

                    noiseGrid.innerHTML = Object.values(groupedReadings).map(group => {
                        const latestReading = group.readings[0];
                        const avgNoise = group.readings.reduce((sum, r) => sum + r.noise_level, 0) / group.readings.length;
                        const comfortIndex = latestReading.comfort_index;

                        return `
                            <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="font-medium text-slate-900">${group.device.device_name}</h3>
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${comfortIndex >= 0.7 ? 'bg-green-100 text-green-800' :
                                comfortIndex >= 0.4 ? 'bg-yellow-100 text-yellow-800' :
                                    'bg-red-100 text-red-800'
                            }">
                                        ${(comfortIndex * 100).toFixed(0)}% Comfort
                                    </span>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-slate-600">Current:</span>
                                        <span class="font-medium">${latestReading.noise_level.toFixed(1)} dB</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-slate-600">Average:</span>
                                        <span class="font-medium">${avgNoise.toFixed(1)} dB</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-slate-600">Quality:</span>
                                        <span class="font-medium capitalize">${latestReading.reading_quality}</span>
                                    </div>
                                    <div class="text-xs text-slate-500">
                                        ${new Date(latestReading.timestamp).toLocaleString()}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    // Update last update time
                    const lastUpdateEl = document.getElementById('lastUpdate');
                    if (lastUpdateEl) {
                        lastUpdateEl.textContent = `Last update: ${new Date().toLocaleTimeString()}`;
                    }
                } catch (error) {
                    console.error('Error in loadNoiseMonitoring:', error);
                }
            }

            // Load RFID activity log
            async function loadRFIDActivity() {
                try {
                    const { data: events, error } = await supabase
                        .from('rfid_events')
                        .select(`
                            *,
                            iot_devices!inner(device_name, location)
                        `)
                        .order('timestamp', { ascending: false })
                        .limit(50);

                    if (error) {
                        console.error('Error loading RFID events:', error);
                        return;
                    }

                    const rfidLog = document.getElementById('rfidActivityLog');
                    if (!rfidLog) return;

                    rfidLog.innerHTML = events.map(event => `
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                            <div class="flex items-center gap-3">
                                <div class="w-2 h-2 rounded-full ${event.event_type === 'check_in' ? 'bg-green-500' :
                            event.event_type === 'check_out' ? 'bg-red-500' :
                                'bg-blue-500'
                        }"></div>
                                <div>
                                    <div class="font-medium text-slate-900">
                                        ${event.event_type === 'check_in' ? 'Check-in' :
                            event.event_type === 'check_out' ? 'Check-out' :
                                'Scan'} - Card ${event.card_id}
                                    </div>
                                    <div class="text-sm text-slate-600">
                                        ${event.iot_devices.device_name} • ${event.iot_devices.location}
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-slate-600">
                                    ${new Date(event.timestamp).toLocaleString()}
                                </div>
                                ${event.session_duration ?
                            `<div class="text-xs text-slate-500">${event.session_duration} min session</div>` :
                            ''
                        }
                            </div>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Error in loadRFIDActivity:', error);
                }
            }

            // Toggle auto refresh
            function toggleAutoRefresh() {
                const button = document.getElementById('toggleAutoRefresh');
                if (!button) return;

                isAutoRefreshOn = !isAutoRefreshOn;

                if (isAutoRefreshOn) {
                    button.textContent = 'Auto Refresh: ON';
                    button.className = 'px-3 py-1.5 rounded-lg bg-green-600 hover:bg-green-700 text-white text-sm';
                    startAutoRefresh();
                } else {
                    button.textContent = 'Auto Refresh: OFF';
                    button.className = 'px-3 py-1.5 rounded-lg bg-gray-600 hover:bg-gray-700 text-white text-sm';
                    stopAutoRefresh();
                }
            }

            // Start auto refresh
            function startAutoRefresh() {
                if (autoRefreshInterval) clearInterval(autoRefreshInterval);
                autoRefreshInterval = setInterval(async () => {
                    await loadNoiseMonitoring();
                    await loadRFIDActivity();
                }, 5000); // Refresh every 5 seconds
            }

            // Stop auto refresh
            function stopAutoRefresh() {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }

            // Clear RFID log
            async function clearRFIDLog() {
                if (confirm('Are you sure you want to clear the RFID activity log?')) {
                    try {
                        const { error } = await supabase
                            .from('rfid_events')
                            .delete()
                            .neq('id', 0); // Delete all records

                        if (error) {
                            console.error('Error clearing RFID log:', error);
                            alert('Error clearing log');
                        } else {
                            await loadRFIDActivity();
                            alert('RFID log cleared successfully');
                        }
                    } catch (error) {
                        console.error('Error in clearRFIDLog:', error);
                        alert('Error clearing log');
                    }
                }
            }

            // Load Recent Taps from recent_taps view
            async function loadRecentTaps() {
                try {
                    console.log('[Recent Taps] Loading from recent_taps view...');
                    const { data: taps, error } = await supabase
                        .from('recent_taps')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(20);

                    if (error) {
                        console.error('[Recent Taps] Error loading taps:', error);
                        const tbody = document.getElementById('recentTapsTableBody');
                        if (tbody) {
                            tbody.innerHTML = `
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-red-500">
                                        Error loading taps: ${error.message}
                                    </td>
                                </tr>
                            `;
                        }
                        return;
                    }

                    console.log('[Recent Taps] Loaded', taps?.length || 0, 'taps');
                    const tbody = document.getElementById('recentTapsTableBody');
                    if (!tbody) return;

                    if (!taps || taps.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center py-8 text-slate-400">
                                    No recent taps found
                                </td>
                            </tr>
                        `;
                        return;
                    }

                    tbody.innerHTML = taps.map(tap => {
                        const formattedDate = new Date(tap.created_at).toLocaleString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });

                        return `
                            <tr class="border-b border-slate-100 hover:bg-slate-50 transition">
                                <td class="py-3 px-3 text-slate-700">${tap.id || 'N/A'}</td>
                                <td class="py-3 px-3 font-mono text-sm">
                                    <span class="px-2 py-1 bg-indigo-100 text-indigo-800 rounded">${tap.uid || 'N/A'}</span>
                                </td>
                                <td class="py-3 px-3 text-slate-700">${tap.name || 'Unknown'}</td>
                                <td class="py-3 px-3 text-slate-700">${tap.table_name || 'N/A'}</td>
                                <td class="py-3 px-3 text-slate-600 text-sm">${formattedDate}</td>
                            </tr>
                        `;
                    }).join('');
                } catch (error) {
                    console.error('[Recent Taps] Error in loadRecentTaps:', error);
                    const tbody = document.getElementById('recentTapsTableBody');
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center py-8 text-red-500">
                                    Error: ${error.message}
                                </td>
                            </tr>
                        `;
                    }
                }
            }

            // Wire IoT monitoring UI
            function wireIOTMonitoring() {
                const refreshDevicesBtn = document.getElementById('refreshDevices');
                const toggleAutoRefreshBtn = document.getElementById('toggleAutoRefresh');
                const clearRfidLogBtn = document.getElementById('clearRfidLog');
                const refreshRecentTapsBtn = document.getElementById('refreshRecentTaps');

                if (refreshDevicesBtn) {
                    refreshDevicesBtn.addEventListener('click', loadDeviceStatus);
                }

                if (toggleAutoRefreshBtn) {
                    toggleAutoRefreshBtn.addEventListener('click', toggleAutoRefresh);
                }

                if (clearRfidLogBtn) {
                    clearRfidLogBtn.addEventListener('click', clearRFIDLog);
                }

                if (refreshRecentTapsBtn) {
                    refreshRecentTapsBtn.addEventListener('click', loadRecentTaps);
                }
            }

            // Init (ensure fade starts after successful admin verification)
            (async function init() {
                var allowed = await checkAdminAccess();
                if (!allowed) return;
                wireUI();
                bindActions();
                wireIOTMonitoring();
                await loadSettings();

                // Load IoT data
                await loadDeviceStatus();
                await loadNoiseMonitoring();
                await loadRFIDActivity();
                await loadRecentTaps();

                // Start auto refresh
                startAutoRefresh();
            })();
        })();
    </script>
    <script>
        // Unified fade-on-scroll transitions (same timing/easing as Frame 18)
        // Note: Runs after main script to ensure access checks complete first
        (function () {
            var fadeElements = Array.from(document.querySelectorAll('[data-fade]'));
            if (fadeElements.length === 0) return;

            fadeElements.forEach(function (el) {
                var initialOpacity = parseFloat(el.getAttribute('data-initial-opacity') || '0');
                var duration = parseInt(el.getAttribute('data-duration') || '1000', 10);
                var easing = el.getAttribute('data-easing') || 'ease-out';
                var blurPxAttr = el.getAttribute('data-blur-px');
                var blurPx = parseInt(blurPxAttr || '14', 10);
                el.style.opacity = String(initialOpacity);
                el.style.setProperty('--fade-init', blurPx + 'px');
                el.style.setProperty('--fade-transition', 'opacity ' + duration + 'ms ' + easing + ', filter ' + duration + 'ms ' + easing);
            });

            var observer = new IntersectionObserver(function (entries) {
                entries.forEach(function (entry) {
                    if (entry.isIntersecting) {
                        var el = entry.target;
                        var delay = parseInt(el.getAttribute('data-delay') || '0', 10);
                        var blurAttr = el.getAttribute('data-blur');
                        var blurEnabled = (blurAttr !== 'false');
                        observer.unobserve(el);
                        setTimeout(function () {
                            el.style.opacity = '1';
                            if (blurEnabled) {
                                el.style.setProperty('--fade-init', '0px');
                            }
                        }, delay);
                    }
                });
            }, { threshold: 0.1 });

            fadeElements.forEach(function (el) { observer.observe(el); });
        })();

        // Initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    </script>
</body>

</html>