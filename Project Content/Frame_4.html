<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Frame 4 - Login</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="theme.css" />
  <script defer src="theme.js"></script>
  <script src="password-toggle.js"></script>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">
  <header class="site-header">
    <div class="max-w-6xl mx-auto flex items-center gap-4 py-3 px-6">
      <img src="UMak_Logo_Registered.png" alt="University of Makati Logo" class="h-12 w-auto" />
      <a href="index.html" class="brand-title text-2xl font-semibold mr-auto">University of Makati Library</a>
    </div>
  </header>
  <main class="flex-1 flex items-start justify-center py-12 px-6">
    <div class="w-full max-w-4xl">

<div class="bg-white rounded-2xl shadow p-8">
  <h1 class="text-2xl font-bold mb-2">Welcome back</h1>
  <p class="text-sm text-slate-500 mb-6">Sign in to access the library dashboard</p>
  <div id="login-error" class="mb-4 text-sm text-red-600 bg-red-50 border border-red-100 rounded-lg p-3 hidden"></div>
  <div id="login-success" class="mb-4 text-sm text-green-600 bg-green-50 border border-green-100 rounded-lg p-3 hidden"></div>
  <form id="login-form" class="space-y-4">
    <div>
      <label class="block text-sm font-medium text-slate-700">Email</label>
      <input id="login-email" type="email" class="mt-1 block w-full rounded-lg border-gray-200 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="you@example.com" required />
    </div>
    <div>
      <label class="block text-sm font-medium text-slate-700">Password</label>
      <input id="login-password" type="password" class="mt-1 block w-full rounded-lg border-gray-200 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="••••••••" required />
    </div>
    <div id="admin-secret" class="hidden">
      <label class="block text-sm font-medium text-slate-700">Admin code (optional)</label>
      <input id="admin-code" type="password" class="mt-1 block w-full rounded-lg border-gray-200 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter admin code" />
      <p class="mt-1 text-xs text-slate-500">Hint: press Alt+A or click the title 3× to show/hide.</p>
    </div>
    <div class="flex items-center justify-between">
      <label class="flex items-center gap-2 text-sm"><input type="checkbox" class="rounded" /> Remember me</label>
      <a href="Frame_14.html" class="text-sm text-indigo-600">Forgot password?</a>
    </div>
    <div>
      <button type="submit" class="w-full py-2 rounded-lg bg-indigo-600 text-white font-semibold">Sign in</button>
    </div>
  </form>
  <p class="text-center text-sm text-slate-500 mt-4">Don't have an account? <a href="Frame_5.html" class="text-indigo-600">Register</a></p>
</div>

    </div>
  </main>
  <footer class="text-center text-xs text-slate-500 py-3">© 2025 UMak Library · Noise Comfort Index</footer>
  <div id="fb-status" style="position:fixed;right:12px;bottom:12px" class="px-2 py-1 rounded-md text-xs bg-slate-200 text-slate-700 hidden"></div>
  <!-- Firebase Auth -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="firebase.js"></script>
  <script>
    (function(){
      // Firebase init with status
      function showStatus(text, ok) {
        var el = document.getElementById('fb-status');
        if (!el) return;
        el.textContent = text || '';
        if (text) {
          el.classList.remove('hidden');
          el.classList.remove('bg-red-200', 'text-red-700');
          el.classList.remove('bg-green-200', 'text-green-700');
          if (ok) {
            el.classList.add('bg-green-200', 'text-green-700');
          } else {
            el.classList.add('bg-red-200', 'text-red-700');
          }
        } else {
          el.classList.add('hidden');
        }
      }

      var cfg = window.firebaseConfig || {};
      try { 
        if (!firebase.apps.length) firebase.initializeApp(cfg); 
        showStatus('Firebase: Connected', true);
      } catch(err){ 
        showStatus('Firebase: Error', false);
      }
      var auth = null; try { auth = firebase.auth(); } catch(_){ }
      var db = null; try { db = firebase.database(); } catch(_){ }

      // Use local persistence
      try { auth && auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL); } catch(_){ }

      var SECRET_CODE = 'SEAT-ADMIN-2025';
      var tapCount = 0;
      function toggleAdminSecret(force) {
        var wrap = document.getElementById('admin-secret');
        if (!wrap) return;
        var willShow = typeof force === 'boolean' ? force : wrap.classList.contains('hidden');
        if (willShow) { wrap.classList.remove('hidden'); }
        else { wrap.classList.add('hidden'); }
      }

      var title = document.querySelector('.brand-title');
      if (title) {
        title.addEventListener('click', function(){ tapCount++; if (tapCount >= 3) { toggleAdminSecret(); tapCount = 0; } setTimeout(function(){ tapCount = 0; }, 1200); });
      }
      document.addEventListener('keydown', function(e){ if ((e.altKey || e.metaKey) && (e.key === 'a' || e.key === 'A')) { toggleAdminSecret(); } });

      function setBusy(isBusy) {
        var btn = document.querySelector('#login-form button[type="submit"]');
        if (btn) { btn.disabled = !!isBusy; btn.style.opacity = isBusy ? '0.7' : '1'; }
        var g = document.getElementById('google-login');
        if (g) { g.disabled = !!isBusy; g.style.opacity = isBusy ? '0.7' : '1'; }
      }

      function showError(text) {
        var el = document.getElementById('login-error');
        if (!el) return;
        el.textContent = text || '';
        if (text) el.classList.remove('hidden'); else el.classList.add('hidden');
      }

      function showSuccess(text) {
        var el = document.getElementById('login-success');
        if (!el) return;
        el.textContent = text || '';
        if (text) el.classList.remove('hidden'); else el.classList.add('hidden');
      }

      // Check for success message in URL
      var urlParams = new URLSearchParams(window.location.search);
      var message = urlParams.get('message');
      if (message) {
        showSuccess(message);
        // Clear the URL parameter
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      function checkWhitelistOrBlock(user) {
        return new Promise(function(resolve){
          if (!user || !user.id) { resolve(false); return; }
          var email = (user.email || '').toLowerCase();
          if (!email.endsWith('@umak.edu.ph')) {
            resolve(false); return;
          }
          
          // Check if user exists in Supabase users table
          window.supabaseDB.getUser(user.id).then(function(result){
            if (result && result.data) {
              // User exists in users table
              resolve(true);
            } else {
              // User doesn't exist in users table, create them
              console.log('User not found in users table, creating profile...');
              var userData = {
                first_name: user.user_metadata?.first_name || '',
                last_name: user.user_metadata?.last_name || '',
                student_id: user.user_metadata?.student_id || '',
                program: user.user_metadata?.program || ''
              };
              
              window.supabaseDB.insertUser(user.id, userData).then(function(insertResult){
                if (insertResult.error) {
                  console.error('Failed to create user profile:', insertResult.error);
                  resolve(false);
                } else {
                  console.log('User profile created successfully');
                  resolve(true);
                }
              }).catch(function(err){
                console.error('Error creating user profile:', err);
                resolve(false);
              });
            }
          }).catch(function(err){
            console.error('Error checking user:', err);
            resolve(false);
          });
        });
      }

      async function destinationAfterLogin(email, password, user) {
        var code = (document.getElementById('admin-code')||{}).value || '';
        var emailLower = (email || '').toLowerCase();
        
        // Check for specific admin credentials (legacy support)
        if (emailLower === 'adminlibrarian@umak.edu.ph' && password === 'noiseumak') {
          return 'Frame_6.html';
        }
        
        // Check admin code (legacy support)
        if (code === SECRET_CODE) {
          return 'Frame_6.html';
        }
        
        // Check if user is admin in database
        if (user && user.uid) {
          try {
            var adminCheck = await window.supabaseDB.isAdmin(user.uid);
            if (adminCheck.data) {
              console.log('User is admin, redirecting to admin dashboard');
              return 'Frame_6.html';
            }
          } catch (error) {
            console.error('Error checking admin status:', error);
          }
        }
        
        return 'Frame_11.html';
      }

      var form = document.getElementById('login-form');
      if (form && auth) {
        form.addEventListener('submit', async function(e){
          e.preventDefault(); setBusy(true); showError('');
          var email = (document.getElementById('login-email')||{}).value || '';
          var pass = (document.getElementById('login-password')||{}).value || '';
          var lower = (email||'').toLowerCase();
          if (!lower.endsWith('@umak.edu.ph')) { setBusy(false); showError('Only University of Makati email addresses (@umak.edu.ph) are allowed.'); return; }
          auth.signInWithEmailAndPassword(email, pass)
            .then(function(res){ return checkWhitelistOrBlock(res && res.user).then(function(ok){ return {ok: ok, user: res && res.user}; }); })
            .then(async function(result){
              if (!result || !result.ok) {
                return auth.signOut().finally(function(){ setBusy(false); showError('No account found. Please register.'); });
              }
              var destination = await destinationAfterLogin(email, pass, result.user);
              window.location.href = destination;
            })
            .catch(function(err){
              setBusy(false);
              var code = err && err.code || '';
              if (code === 'auth/user-not-found') { showError('No account found. Please register.'); return; }
              showError(err && err.message ? err.message : 'Login failed.');
            });
        });
      }

    })();
  </script>
</body>
</html>
